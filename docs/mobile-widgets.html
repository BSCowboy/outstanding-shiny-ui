<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 26 Design widgets | Outstanding User Interfaces with Shiny</title>
<meta name="author" content="David Granjon">
<!-- CSS --><link rel="stylesheet" href="css/style.css">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.2/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.2/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.1.9000/tabs.js"></script><script src="libs/bs3compat-0.2.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Outstanding User Interfaces with Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="foreword.html">Foreword</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="web-intro.html"><span class="header-section-number">1</span> Shiny and the Web</a></li>
<li><a class="" href="web-dependencies.html"><span class="header-section-number">2</span> Discover Shiny dependencies</a></li>
<li class="book-part">From R to HTML: discover and master {htmltools}:</li>
<li><a class="" href="htmltools-overview.html"><span class="header-section-number">3</span> htmltools overview</a></li>
<li><a class="" href="htmltools-dependencies.html"><span class="header-section-number">4</span> Dependency utilities</a></li>
<li class="book-part">Beautify with CSS and SASS</li>
<li><a class="" href="beautify-css.html"><span class="header-section-number">5</span> CSS for Shiny</a></li>
<li><a class="" href="beautify-sass.html"><span class="header-section-number">6</span> Introduction to SASS</a></li>
<li><a class="" href="beautify-with-fresh.html"><span class="header-section-number">7</span> Beautify with fresh</a></li>
<li><a class="" href="beautify-with-bootstraplib.html"><span class="header-section-number">8</span> Beautify with bslib</a></li>
<li><a class="" href="beautify-other-tools.html"><span class="header-section-number">9</span> Other tools</a></li>
<li class="book-part">Unleash interactivity with JavaScript</li>
<li><a class="" href="survival-kit-javascript.html"><span class="header-section-number">10</span> JavaScript for Shiny</a></li>
<li><a class="" href="shiny-intro.html"><span class="header-section-number">11</span> Shiny’s internal: session and websockets</a></li>
<li><a class="" href="shiny-input-system.html"><span class="header-section-number">12</span> Shiny’s input system</a></li>
<li><a class="" href="shiny-input-lifecycle.html"><span class="header-section-number">13</span> Shiny inputs lifecycles</a></li>
<li><a class="" href="shiny-input-gems.html"><span class="header-section-number">14</span> Hidden gems about inputs</a></li>
<li><a class="" href="shiny-custom-handler.html"><span class="header-section-number">15</span> Dynamically manage content with handlers</a></li>
<li class="book-part">Practice 1: a dashboard template</li>
<li><a class="" href="custom-templates-selection.html"><span class="header-section-number">16</span> Template selection</a></li>
<li><a class="" href="custom-templates-dependencies.html"><span class="header-section-number">17</span> Define dependencies</a></li>
<li><a class="" href="custom-templates-skeleton.html"><span class="header-section-number">18</span> Template skeleton</a></li>
<li><a class="" href="custom-templates-testing.html"><span class="header-section-number">19</span> Testing and validating templates elements</a></li>
<li><a class="" href="custom-templates-inputs.html"><span class="header-section-number">20</span> Develop custom input widgets</a></li>
<li><a class="" href="custom-templates-interactivity.html"><span class="header-section-number">21</span> Adding more interactivity</a></li>
<li class="book-part">Toward a better workflow</li>
<li><a class="" href="workflow-charpente.html"><span class="header-section-number">22</span> Introduction to {charpente}</a></li>
<li class="book-part">Case study 2: Mobile development with Shiny</li>
<li><a class="" href="mobile-shiny-intro.html"><span class="header-section-number">23</span> Introduction</a></li>
<li><a class="" href="mobile-shinyMobile.html"><span class="header-section-number">24</span> Reconstruct {shinyMobile}</a></li>
<li><a class="" href="mobile-pwa.html"><span class="header-section-number">25</span> {shinyMobile} and PWA</a></li>
<li><a class="active" href="mobile-widgets.html"><span class="header-section-number">26</span> Design widgets</a></li>
<li class="book-part">Going further</li>
<li><a class="" href="going-further-reactR.html"><span class="header-section-number">27</span> R + Shiny + React: welcome {reactR}</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DivadNojnarg/outstanding-shiny-ui">View book source</a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="mobile-widgets" class="section level1">
<h1>
<span class="header-section-number">26</span> Design widgets<a class="anchor" aria-label="anchor" href="#mobile-widgets"><i class="fas fa-link"></i></a>
</h1>
<p>Framework7 brings dozen of different widgets like a photo browser, virtual lists (high performance lists),
messages, notifications, toasts, …</p>
<p>Looking at the <a href="https://v5.framework7.io/docs/">documentation</a>, the API is most of the time
always the same that is, we create the widget:</p>
<div class="sourceCode" id="cb593"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb593-1"><a href="mobile-widgets.html#cb593-1"></a><span class="va">app</span>.<span class="va">widget</span>.<span class="at">create</span>(parameters)<span class="op">;</span></span></code></pre></div>
<p>and we update, open or close it later:</p>
<div class="sourceCode" id="cb594"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb594-1"><a href="mobile-widgets.html#cb594-1"></a><span class="va">app</span>.<span class="va">widget</span>.<span class="at">update</span>(newParameters)<span class="op">;</span></span>
<span id="cb594-2"><a href="mobile-widgets.html#cb594-2"></a><span class="va">app</span>.<span class="va">widget</span>.<span class="at">open</span>()<span class="op">;</span></span>
<span id="cb594-3"><a href="mobile-widgets.html#cb594-3"></a><span class="va">app</span>.<span class="va">widget</span>.<span class="at">close</span>()<span class="op">;</span></span></code></pre></div>
<p>I must admit, there are few deviations like the navbar (<code>app.navbar.show()</code>) or the dialog but we have enough common points to
design a main wrapper that creates any widget and update/open/close it.</p>
<p>What we do below significantly simplify the R/JS API at a price to slightly reduce the
customization.</p>
<div id="build-the-ui" class="section level2">
<h2>
<span class="header-section-number">26.1</span> Build the UI<a class="anchor" aria-label="anchor" href="#build-the-ui"><i class="fas fa-link"></i></a>
</h2>
<p>We know that JavaScript must receive a configuration object to create the widget instance.
As shown earlier in this book, there is a simple way to achieve this. Let’s consider the <a href="https://v5.framework7.io/docs/gauge.html">gauge</a> example.</p>
<p>On the UI side, we expect to have:</p>
<div class="sourceCode" id="cb595"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb595-1"><a href="mobile-widgets.html#cb595-1"></a><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"gauge"</span><span class="kw">&gt;&lt;/div&gt;</span></span></code></pre></div>
<p>Upon instantiating, Framework7 populates this container with the relevant tags.
The <code>f7_gauge</code> function creates a <code>div</code> tag with the <code>gauge</code> class as well as a configuration
tag:</p>
<div class="sourceCode" id="cb596"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f7Gauge</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">value</span>, <span class="va">options</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>

  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">options</span><span class="op">$</span><span class="va">valueText</span><span class="op">)</span><span class="op">)</span> <span class="va">options</span><span class="op">$</span><span class="va">valueText</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">options</span><span class="op">$</span><span class="va">value</span>, <span class="st">"%"</span><span class="op">)</span>

  <span class="va">gaugeProps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, <span class="va">options</span><span class="op">)</span>

  <span class="va">gaugeConfig</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">script</span><span class="op">(</span>
    type <span class="op">=</span> <span class="st">"application/json"</span>,
    `data-for` <span class="op">=</span> <span class="va">id</span>,
    <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">gaugeProps</span>,
      auto_unbox <span class="op">=</span> <span class="cn">TRUE</span>,
      json_verbatim <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
  <span class="op">)</span>

  <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    class <span class="op">=</span> <span class="st">"gauge"</span>,
    id <span class="op">=</span> <span class="va">id</span>,
    <span class="va">gaugeConfig</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We provide a default for the <code>valueText</code> option that should display the current
value followed by a <code>%</code> symbol. Note that the class is crucial to target the relevant tag on the JS side.
All other widgets will moreless follow the same scheme.</p>
</div>
<div id="widgets-without-preexisting-ui" class="section level2">
<h2>
<span class="header-section-number">26.2</span> Widgets without preexisting UI<a class="anchor" aria-label="anchor" href="#widgets-without-preexisting-ui"><i class="fas fa-link"></i></a>
</h2>
<p>There are few widgets like toasts, notifications that don’t have any predefined UI
element when the app starts. In this case, we simply send the configuration to JS, through
the <code>session</code>:</p>
<div class="sourceCode" id="cb597"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f7Notif</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">options</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>

  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">options</span><span class="op">$</span><span class="va">icon</span><span class="op">)</span><span class="op">)</span> <span class="va">options</span><span class="op">$</span><span class="va">icon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">options</span><span class="op">$</span><span class="va">icon</span><span class="op">)</span>

  <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">text</span><span class="op">)</span>, <span class="va">options</span><span class="op">)</span>
  <span class="co"># see my-app.js function</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span>
    type <span class="op">=</span> <span class="st">"notification"</span>,
    message <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span>
      <span class="va">message</span>,
      auto_unbox <span class="op">=</span> <span class="cn">TRUE</span>,
      json_verbatim <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>Pay attention to the <code>icon</code> element: we can’t convert shiny tags to JSON, so they
must be converted to character first. If multiple parameters should contain tags,
you must treat them accordingly!</p>
</div>
<div id="initialize-the-widget" class="section level2">
<h2>
<span class="header-section-number">26.3</span> Initialize the widget<a class="anchor" aria-label="anchor" href="#initialize-the-widget"><i class="fas fa-link"></i></a>
</h2>
<p>On the JS side, we create a new script, <code>widgets.js</code></p>
<div class="sourceCode" id="cb598"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RinteRface/charpente">charpente</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/charpente/man/create_file.html">create_js</a></span><span class="op">(</span><span class="st">"widgets"</span><span class="op">)</span></code></pre></div>
<p>We set an array containing all compatible widget names in two categories and concatenate
in a <code>widgets</code> element:</p>
<div class="sourceCode" id="cb599"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb599-1"><a href="mobile-widgets.html#cb599-1"></a><span class="kw">const</span> uiWidgets <span class="op">=</span> [<span class="st">"gauge"</span><span class="op">,</span> <span class="st">"swiper"</span><span class="op">,</span> <span class="st">"searchbar"</span>]<span class="op">;</span></span>
<span id="cb599-2"><a href="mobile-widgets.html#cb599-2"></a><span class="kw">const</span> serverWidgets <span class="op">=</span> [<span class="st">"toast"</span><span class="op">,</span> <span class="st">"photoBrowser"</span><span class="op">,</span> <span class="st">"notification"</span>]<span class="op">;</span></span>
<span id="cb599-3"><a href="mobile-widgets.html#cb599-3"></a><span class="kw">const</span> widgets <span class="op">=</span> <span class="va">uiWidgets</span>.<span class="at">concat</span>(serverWidgets)<span class="op">;</span></span></code></pre></div>
<p>We then define the <code>activateWidget</code> function, only considering UI widgets.
Since we have two widgets categories, this function first checks whether the widget is part of the <code>uiWidgets</code> array:</p>
<div class="sourceCode" id="cb600"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb600-1"><a href="mobile-widgets.html#cb600-1"></a><span class="cf">if</span> (<span class="va">uiWidgets</span>.<span class="at">indexOf</span>(widget) <span class="op">&gt;</span> <span class="dv">-1</span>) <span class="op">{</span></span>
<span id="cb600-2"><a href="mobile-widgets.html#cb600-2"></a>  <span class="co">// Do things</span></span>
<span id="cb600-3"><a href="mobile-widgets.html#cb600-3"></a><span class="op">}</span></span></code></pre></div>
<p>As there may be multiple widgets of the same time to initialize, we must loop through all
possible elements. This is where the class is important and must match the widget name.
For instance, the gauge has the <code>gauge</code> class and the methods are always <code>app.gauge.</code>.
How do we loop through multiple widgets? We use the jQuery <code>each</code> method:</p>
<div class="sourceCode" id="cb601"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb601-1"><a href="mobile-widgets.html#cb601-1"></a><span class="cf">if</span> (<span class="va">uiWidgets</span>.<span class="at">indexOf</span>(widget) <span class="op">&gt;</span> <span class="dv">-1</span>) <span class="op">{</span></span>
<span id="cb601-2"><a href="mobile-widgets.html#cb601-2"></a>  <span class="at">$</span>(<span class="st">"."</span> <span class="op">+</span> widget).<span class="at">each</span>(<span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb601-3"><a href="mobile-widgets.html#cb601-3"></a>    <span class="co">// Do things</span></span>
<span id="cb601-4"><a href="mobile-widgets.html#cb601-4"></a>  <span class="op">}</span></span>
<span id="cb601-5"><a href="mobile-widgets.html#cb601-5"></a><span class="op">}</span></span></code></pre></div>
<p>We see that <code>$("." + widget)</code> gives <code>$(".gauge)</code> when the widget is a gauge, which
will target all gauges one by one. Then for each gauge, we extract the configuration containing
all options passed by the end user. Remember that each element has a unique id.
We extract the current element <code>$(this)</code> in the <code>$el</code> variable and search for a
script tag pointing to the unique tag having <code>$el.attr("id")</code> as id. The configuration is parsed
to convert it to an object. Note that most of the time, Framework7 expects to have a <code>el</code>
attributes which simply contains the CSS selector of the current element,
in other words its unique id <code>'#' + $el.attr("id")</code>:</p>
<div class="sourceCode" id="cb602"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb602-1"><a href="mobile-widgets.html#cb602-1"></a><span class="cf">if</span> (<span class="va">uiWidgets</span>.<span class="at">indexOf</span>(widget) <span class="op">&gt;</span> <span class="dv">-1</span>) <span class="op">{</span></span>
<span id="cb602-2"><a href="mobile-widgets.html#cb602-2"></a>  <span class="at">$</span>(<span class="st">"."</span> <span class="op">+</span> widget).<span class="at">each</span>(<span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb602-3"><a href="mobile-widgets.html#cb602-3"></a>    <span class="kw">var</span> $el <span class="op">=</span> <span class="at">$</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb602-4"><a href="mobile-widgets.html#cb602-4"></a>    <span class="kw">var</span> config <span class="op">=</span> <span class="at">$</span>(document).<span class="at">find</span>(</span>
<span id="cb602-5"><a href="mobile-widgets.html#cb602-5"></a>      <span class="st">"script[data-for='"</span> <span class="op">+</span> <span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>) <span class="op">+</span> <span class="st">"']"</span></span>
<span id="cb602-6"><a href="mobile-widgets.html#cb602-6"></a>    )<span class="op">;</span></span>
<span id="cb602-7"><a href="mobile-widgets.html#cb602-7"></a>    config <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">config</span>.<span class="at">html</span>())<span class="op">;</span></span>
<span id="cb602-8"><a href="mobile-widgets.html#cb602-8"></a>    <span class="co">// add the id</span></span>
<span id="cb602-9"><a href="mobile-widgets.html#cb602-9"></a>    <span class="va">config</span>.<span class="at">el</span> <span class="op">=</span> <span class="st">'#'</span> <span class="op">+</span> <span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>)<span class="op">;</span></span>
<span id="cb602-10"><a href="mobile-widgets.html#cb602-10"></a>  <span class="op">}</span></span>
<span id="cb602-11"><a href="mobile-widgets.html#cb602-11"></a><span class="op">}</span></span></code></pre></div>
<p>The final step is to initialize the widget, which is quite straightforward if we notice that
<code>app.gauge</code> is the same as <code>app["gauge"]</code>. We obtain the general code:</p>
<div class="sourceCode" id="cb603"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb603-1"><a href="mobile-widgets.html#cb603-1"></a>app[widget].<span class="at">create</span>(config)<span class="op">;</span></span></code></pre></div>
<p>For the server widgets, it is even simpler. We recover the message with a <code>Shiny.addCustomMessageHandler("type", callback)</code> and
initialize it. The only possible source of problem is the custom message <code>type</code> that must be the same
as the one specified in the R function with <code>session$sendCustomMessage("type", message)</code>. We create
an <code>else</code> statement following the <code>if</code> condition and put that code inside:</p>
<div class="sourceCode" id="cb604"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb604-1"><a href="mobile-widgets.html#cb604-1"></a><span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(widget<span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb604-2"><a href="mobile-widgets.html#cb604-2"></a>  app[widget].<span class="at">create</span>(message).<span class="at">open</span>()<span class="op">;</span></span>
<span id="cb604-3"><a href="mobile-widgets.html#cb604-3"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>As shown in the above code, we can also immediately open the widget by chaining methods.</p>
<p>The full JavaScript code may be found below.</p>
<div class="sourceCode" id="cb605"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb605-1"><a href="mobile-widgets.html#cb605-1"></a><span class="co">// Instantiate a widget</span></span>
<span id="cb605-2"><a href="mobile-widgets.html#cb605-2"></a>activateWidget <span class="op">=</span> <span class="kw">function</span>(widget) <span class="op">{</span></span>
<span id="cb605-3"><a href="mobile-widgets.html#cb605-3"></a>  <span class="co">// Handle ui side widgets</span></span>
<span id="cb605-4"><a href="mobile-widgets.html#cb605-4"></a>  <span class="cf">if</span> (<span class="va">uiWidgets</span>.<span class="at">indexOf</span>(widget) <span class="op">&gt;</span> <span class="dv">-1</span>) <span class="op">{</span></span>
<span id="cb605-5"><a href="mobile-widgets.html#cb605-5"></a>    <span class="at">$</span>(<span class="st">"."</span> <span class="op">+</span> widget).<span class="at">each</span>(<span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb605-6"><a href="mobile-widgets.html#cb605-6"></a>      <span class="kw">var</span> $el <span class="op">=</span> <span class="at">$</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb605-7"><a href="mobile-widgets.html#cb605-7"></a>      <span class="kw">var</span> config <span class="op">=</span> <span class="at">$</span>(document).<span class="at">find</span>(</span>
<span id="cb605-8"><a href="mobile-widgets.html#cb605-8"></a>        <span class="st">"script[data-for='"</span> <span class="op">+</span> <span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>) <span class="op">+</span> <span class="st">"']"</span></span>
<span id="cb605-9"><a href="mobile-widgets.html#cb605-9"></a>      )<span class="op">;</span></span>
<span id="cb605-10"><a href="mobile-widgets.html#cb605-10"></a>      config <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">config</span>.<span class="at">html</span>())<span class="op">;</span></span>
<span id="cb605-11"><a href="mobile-widgets.html#cb605-11"></a>      <span class="co">// add the id</span></span>
<span id="cb605-12"><a href="mobile-widgets.html#cb605-12"></a>      <span class="va">config</span>.<span class="at">el</span> <span class="op">=</span> <span class="st">'#'</span> <span class="op">+</span> <span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>)<span class="op">;</span></span>
<span id="cb605-13"><a href="mobile-widgets.html#cb605-13"></a></span>
<span id="cb605-14"><a href="mobile-widgets.html#cb605-14"></a>      <span class="co">// feed the create method</span></span>
<span id="cb605-15"><a href="mobile-widgets.html#cb605-15"></a>      app[widget].<span class="at">create</span>(config)<span class="op">;</span></span>
<span id="cb605-16"><a href="mobile-widgets.html#cb605-16"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb605-17"><a href="mobile-widgets.html#cb605-17"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb605-18"><a href="mobile-widgets.html#cb605-18"></a>    <span class="co">// This concerns toasts, notifications, photoBrowser, ...</span></span>
<span id="cb605-19"><a href="mobile-widgets.html#cb605-19"></a>    <span class="co">// that don't have any UI element in the DOM before creating</span></span>
<span id="cb605-20"><a href="mobile-widgets.html#cb605-20"></a>    <span class="co">// the widget instance.</span></span>
<span id="cb605-21"><a href="mobile-widgets.html#cb605-21"></a>    <span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(widget<span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb605-22"><a href="mobile-widgets.html#cb605-22"></a>      app[widget].<span class="at">create</span>(message).<span class="at">open</span>()<span class="op">;</span></span>
<span id="cb605-23"><a href="mobile-widgets.html#cb605-23"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb605-24"><a href="mobile-widgets.html#cb605-24"></a>  <span class="op">}</span></span>
<span id="cb605-25"><a href="mobile-widgets.html#cb605-25"></a><span class="op">};</span></span></code></pre></div>
<p>The final step is to activate all widgets. We proceed with a loop:</p>
<div class="sourceCode" id="cb606"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb606-1"><a href="mobile-widgets.html#cb606-1"></a><span class="co">// Loop over all widgets to activate them</span></span>
<span id="cb606-2"><a href="mobile-widgets.html#cb606-2"></a><span class="va">widgets</span>.<span class="at">forEach</span>(<span class="kw">function</span>(w) <span class="op">{</span></span>
<span id="cb606-3"><a href="mobile-widgets.html#cb606-3"></a>  <span class="at">activateWidget</span>(w)<span class="op">;</span></span>
<span id="cb606-4"><a href="mobile-widgets.html#cb606-4"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="update-widgets" class="section level2">
<h2>
<span class="header-section-number">26.4</span> Update widgets<a class="anchor" aria-label="anchor" href="#update-widgets"><i class="fas fa-link"></i></a>
</h2>
<p>We would like to develop a similar generalized interface to update any element in the DOM.
Instead of having <code>update_f7_gauge</code>, <code>update_f7_notification</code>, … we want an <code>update_f7_instance</code> function.</p>
<p>We leverage the <code>app.data</code> element that stores all instances by widget type. In the previous part,
we already created a cache for tooltips, so let’s do it for gauges:</p>
<div class="sourceCode" id="cb607"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb607-1"><a href="mobile-widgets.html#cb607-1"></a><span class="va">config</span>.<span class="at">data</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb607-2"><a href="mobile-widgets.html#cb607-2"></a>  <span class="cf">return</span> <span class="op">{</span></span>
<span id="cb607-3"><a href="mobile-widgets.html#cb607-3"></a>    <span class="co">// any other widget type to cache ...</span></span>
<span id="cb607-4"><a href="mobile-widgets.html#cb607-4"></a>    <span class="dt">gauge</span><span class="op">:</span> []</span>
<span id="cb607-5"><a href="mobile-widgets.html#cb607-5"></a>  <span class="op">};</span></span>
<span id="cb607-6"><a href="mobile-widgets.html#cb607-6"></a><span class="op">};</span></span></code></pre></div>
<p>At that step, the array name must be the same as the app method. For instance,
we have <code>app.gauge</code>, which means that we should create <code>config.data.gauge</code> and not <code>config.data.gauges</code>,
as it would lead to errors later.</p>
<p>Once the cache is available, we have to modify the JavaScript that creates the widget instance,
to store the new instance in the cache. We add the following code, where w refers to the widget instance:</p>
<div class="sourceCode" id="cb608"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb608-1"><a href="mobile-widgets.html#cb608-1"></a><span class="co">// ui widgets</span></span>
<span id="cb608-2"><a href="mobile-widgets.html#cb608-2"></a><span class="va">app</span>.<span class="at">data</span>[widget][<span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>)] <span class="op">=</span> w<span class="op">;</span></span>
<span id="cb608-3"><a href="mobile-widgets.html#cb608-3"></a><span class="co">// server widgets</span></span>
<span id="cb608-4"><a href="mobile-widgets.html#cb608-4"></a><span class="va">app</span>.<span class="at">data</span>[widget][<span class="va">message</span>.<span class="at">id</span>] <span class="op">=</span> w<span class="op">;</span></span></code></pre></div>
<p>Only the <code>id</code> location differs depending on the widget definition (ui vs server).</p>
<p>The <code>activateWidget</code> function should be:</p>
<div class="sourceCode" id="cb609"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb609-1"><a href="mobile-widgets.html#cb609-1"></a><span class="co">// Instantiate a widget</span></span>
<span id="cb609-2"><a href="mobile-widgets.html#cb609-2"></a>activateWidget <span class="op">=</span> <span class="kw">function</span>(widget) <span class="op">{</span></span>
<span id="cb609-3"><a href="mobile-widgets.html#cb609-3"></a>  <span class="co">// Handle ui side widgets</span></span>
<span id="cb609-4"><a href="mobile-widgets.html#cb609-4"></a>  <span class="cf">if</span> (<span class="va">uiWidgets</span>.<span class="at">indexOf</span>(widget) <span class="op">&gt;</span> <span class="dv">-1</span>) <span class="op">{</span></span>
<span id="cb609-5"><a href="mobile-widgets.html#cb609-5"></a>    <span class="at">$</span>(<span class="st">"."</span> <span class="op">+</span> widget).<span class="at">each</span>(<span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb609-6"><a href="mobile-widgets.html#cb609-6"></a>      <span class="kw">var</span> $el <span class="op">=</span> <span class="at">$</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb609-7"><a href="mobile-widgets.html#cb609-7"></a>      <span class="kw">var</span> config <span class="op">=</span> <span class="at">$</span>(document).<span class="at">find</span>(</span>
<span id="cb609-8"><a href="mobile-widgets.html#cb609-8"></a>        <span class="st">"script[data-for='"</span> <span class="op">+</span> <span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>) <span class="op">+</span> <span class="st">"']"</span></span>
<span id="cb609-9"><a href="mobile-widgets.html#cb609-9"></a>      )<span class="op">;</span></span>
<span id="cb609-10"><a href="mobile-widgets.html#cb609-10"></a>      config <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">config</span>.<span class="at">html</span>())<span class="op">;</span></span>
<span id="cb609-11"><a href="mobile-widgets.html#cb609-11"></a>      <span class="co">// add the id</span></span>
<span id="cb609-12"><a href="mobile-widgets.html#cb609-12"></a>      <span class="va">config</span>.<span class="at">el</span> <span class="op">=</span> <span class="st">'#'</span> <span class="op">+</span> <span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>)<span class="op">;</span></span>
<span id="cb609-13"><a href="mobile-widgets.html#cb609-13"></a></span>
<span id="cb609-14"><a href="mobile-widgets.html#cb609-14"></a>      <span class="co">// feed the create method</span></span>
<span id="cb609-15"><a href="mobile-widgets.html#cb609-15"></a>      <span class="kw">var</span> w <span class="op">=</span> app[widget].<span class="at">create</span>(config)<span class="op">;</span></span>
<span id="cb609-16"><a href="mobile-widgets.html#cb609-16"></a>      <span class="co">// Store the widget instance in the app data cache</span></span>
<span id="cb609-17"><a href="mobile-widgets.html#cb609-17"></a>      <span class="va">app</span>.<span class="at">data</span>[widget][<span class="va">$el</span>.<span class="at">attr</span>(<span class="st">"id"</span>)] <span class="op">=</span> w<span class="op">;</span></span>
<span id="cb609-18"><a href="mobile-widgets.html#cb609-18"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb609-19"><a href="mobile-widgets.html#cb609-19"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb609-20"><a href="mobile-widgets.html#cb609-20"></a>    <span class="co">// This concerns toasts, notifications, photoBrowser, ...</span></span>
<span id="cb609-21"><a href="mobile-widgets.html#cb609-21"></a>    <span class="co">// that don't have any UI element in the DOM before creating</span></span>
<span id="cb609-22"><a href="mobile-widgets.html#cb609-22"></a>    <span class="co">// the widget instance.</span></span>
<span id="cb609-23"><a href="mobile-widgets.html#cb609-23"></a>    <span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(widget<span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb609-24"><a href="mobile-widgets.html#cb609-24"></a>      <span class="kw">var</span> w <span class="op">=</span> app[widget].<span class="at">create</span>(message)<span class="op">;</span></span>
<span id="cb609-25"><a href="mobile-widgets.html#cb609-25"></a>      <span class="va">app</span>.<span class="at">data</span>[widget][<span class="va">message</span>.<span class="at">id</span>] <span class="op">=</span> w<span class="op">;</span></span>
<span id="cb609-26"><a href="mobile-widgets.html#cb609-26"></a>      <span class="va">w</span>.<span class="at">open</span>()<span class="op">;</span></span>
<span id="cb609-27"><a href="mobile-widgets.html#cb609-27"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb609-28"><a href="mobile-widgets.html#cb609-28"></a>  <span class="op">}</span></span>
<span id="cb609-29"><a href="mobile-widgets.html#cb609-29"></a><span class="op">};</span></span></code></pre></div>
<p>Once done, this is time to design <code>update_f7_instance</code>. The R code sends a message to
the current session containing:</p>
<ul>
<li>The id of the element to update.</li>
<li>The new configuration.</li>
</ul>
<p>Since we send a JSON, the hardest part is to correctly process shiny tags. How do we
track shiny tags. As a reminder, let’s run the code below:</p>
<div class="sourceCode" id="cb610"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "shiny.tag"</code></pre>
<div class="sourceCode" id="cb612"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tag.html">tagList</a></span><span class="op">(</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h1</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "shiny.tag.list" "list"</code></pre>
<p>For each configuration element, we must check whether its class contains <code>shiny.tag</code> or <code>shiny.tag.list</code> and convert it to a character. Moreover, it may contain a nested list like:</p>
<div class="sourceCode" id="cb614"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">options</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  buttons <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
   <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
     text <span class="op">=</span> <span class="st">"Notification"</span>,
     icon <span class="op">=</span> <span class="fu"><a href="https://rinterface.github.io/shinyMobile/reference/f7Icon.html">f7Icon</a></span><span class="op">(</span><span class="st">"info"</span><span class="op">)</span>,
     color <span class="op">=</span> <span class="cn">NULL</span>
   <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>In that case, our function must be recursive and call itself whenever an item having the <code>list</code> class
is found. If the element is simple text, numeric, we return it as is.</p>
<p>We finally get:</p>
<div class="sourceCode" id="cb615"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">update_f7_instance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">options</span>, <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># Convert any shiny tag into character so that toJSON does not cry</span>
  <span class="va">listRenderTags</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      X <span class="op">=</span> <span class="va">l</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny.tag"</span>, <span class="st">"shiny.tag.list"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"list"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="co"># Recursive part</span>
          <span class="fu">listRenderTags</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="va">x</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>
  <span class="op">}</span>
  <span class="va">options</span> <span class="op">&lt;-</span> <span class="fu">listRenderTags</span><span class="op">(</span><span class="va">options</span><span class="op">)</span>

  <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span>, options <span class="op">=</span> <span class="va">options</span><span class="op">)</span>
  <span class="fu">sendCustomMessage</span><span class="op">(</span><span class="st">"update-instance"</span>, <span class="va">message</span>, <span class="va">session</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>On the JS side, we receive the message (still in the <code>widget.js</code> script):</p>
<div class="sourceCode" id="cb616"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb616-1"><a href="mobile-widgets.html#cb616-1"></a><span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(<span class="st">'update-instance'</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb616-2"><a href="mobile-widgets.html#cb616-2"></a>  <span class="co">// Treat message ...</span></span>
<span id="cb616-3"><a href="mobile-widgets.html#cb616-3"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>All widgets are stored by type in the app data, for instance, the element having for unique id
<code>mygauge</code> is located in <code>app.data["gauge"]["mygauge"]</code>. As there is no easy way to recover the widget type
given its id, the first step of the message handler is to find where our instance is located. We design a
nested for loop. The outer loop scans all app.data properties (ie widget categories) and the inner loop
scans all existing instances for each category. Whenever, the <code>message.id</code> matches the instance
name, we store the corresponding widget category in a variable:</p>
<div class="sourceCode" id="cb617"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb617-1"><a href="mobile-widgets.html#cb617-1"></a><span class="kw">var</span> instanceFamily<span class="op">;</span></span>
<span id="cb617-2"><a href="mobile-widgets.html#cb617-2"></a><span class="cf">for</span> (<span class="kw">const</span> property <span class="kw">in</span> <span class="va">app</span>.<span class="at">data</span>) <span class="op">{</span></span>
<span id="cb617-3"><a href="mobile-widgets.html#cb617-3"></a>  <span class="cf">for</span> (<span class="kw">const</span> e <span class="kw">in</span> <span class="va">app</span>.<span class="at">data</span>[property]) <span class="op">{</span></span>
<span id="cb617-4"><a href="mobile-widgets.html#cb617-4"></a>    <span class="cf">if</span> (e <span class="op">===</span> <span class="va">message</span>.<span class="at">id</span>) <span class="op">{</span></span>
<span id="cb617-5"><a href="mobile-widgets.html#cb617-5"></a>      instanceFamily <span class="op">=</span> property<span class="op">;</span></span>
<span id="cb617-6"><a href="mobile-widgets.html#cb617-6"></a>    <span class="op">}</span></span>
<span id="cb617-7"><a href="mobile-widgets.html#cb617-7"></a>  <span class="op">}</span></span>
<span id="cb617-8"><a href="mobile-widgets.html#cb617-8"></a><span class="op">}</span></span></code></pre></div>
<p>We then access the old instance using the newly defined variable and the <code>message.id</code>.
We capture its parameters located in <code>oldInstance.params</code>. From there, multiple options are available:</p>
<ul>
<li>We extend the old configuration by the new one.</li>
<li>We entirely overwrite the existing options.</li>
</ul>
<p>Below, we decided to merge the old and new configurations using <code>app.utils.extend</code>:</p>
<div class="sourceCode" id="cb618"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb618-1"><a href="mobile-widgets.html#cb618-1"></a><span class="kw">var</span> oldInstance <span class="op">=</span> <span class="va">app</span>.<span class="at">data</span>[instanceFamily][<span class="va">message</span>.<span class="at">id</span>]<span class="op">;</span></span>
<span id="cb618-2"><a href="mobile-widgets.html#cb618-2"></a><span class="kw">var</span> oldConfig <span class="op">=</span> <span class="va">oldInstance</span>.<span class="at">params</span><span class="op">;</span></span>
<span id="cb618-3"><a href="mobile-widgets.html#cb618-3"></a><span class="kw">var</span> newConfig <span class="op">=</span> <span class="va">app</span>.<span class="va">utils</span>.<span class="at">extend</span>(oldConfig<span class="op">,</span>  <span class="va">message</span>.<span class="at">options</span>)<span class="op">;</span></span></code></pre></div>
<p>The next step is to destroy the old instance, initialize the new instance and refresh
the <code>app.data</code> cache:</p>
<div class="sourceCode" id="cb619"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb619-1"><a href="mobile-widgets.html#cb619-1"></a><span class="co">// Destroy old instance</span></span>
<span id="cb619-2"><a href="mobile-widgets.html#cb619-2"></a><span class="va">oldInstance</span>.<span class="at">destroy</span>()<span class="op">;</span></span>
<span id="cb619-3"><a href="mobile-widgets.html#cb619-3"></a><span class="co">// Create new config</span></span>
<span id="cb619-4"><a href="mobile-widgets.html#cb619-4"></a><span class="kw">var</span> newInstance <span class="op">=</span> app[instanceFamily].<span class="at">create</span>(newConfig)<span class="op">;</span></span>
<span id="cb619-5"><a href="mobile-widgets.html#cb619-5"></a><span class="co">// Update app data</span></span>
<span id="cb619-6"><a href="mobile-widgets.html#cb619-6"></a><span class="va">app</span>.<span class="at">data</span>[instanceFamily][<span class="va">message</span>.<span class="at">id</span>] <span class="op">=</span> newInstance<span class="op">;</span></span></code></pre></div>
<p>The whole code is located below:</p>
<div class="sourceCode" id="cb620"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb620-1"><a href="mobile-widgets.html#cb620-1"></a><span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(<span class="st">'update-instance'</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb620-2"><a href="mobile-widgets.html#cb620-2"></a>  <span class="co">// Recover in which array is stored the given instance.</span></span>
<span id="cb620-3"><a href="mobile-widgets.html#cb620-3"></a>  <span class="co">// Uniqueness is ensured since HTML id are supposed to be unique.</span></span>
<span id="cb620-4"><a href="mobile-widgets.html#cb620-4"></a>  <span class="kw">var</span> instanceFamily<span class="op">;</span></span>
<span id="cb620-5"><a href="mobile-widgets.html#cb620-5"></a>  <span class="cf">for</span> (<span class="kw">const</span> property <span class="kw">in</span> <span class="va">app</span>.<span class="at">data</span>) <span class="op">{</span></span>
<span id="cb620-6"><a href="mobile-widgets.html#cb620-6"></a>    <span class="cf">for</span> (<span class="kw">const</span> e <span class="kw">in</span> <span class="va">app</span>.<span class="at">data</span>[property]) <span class="op">{</span></span>
<span id="cb620-7"><a href="mobile-widgets.html#cb620-7"></a>      <span class="cf">if</span> (e <span class="op">===</span> <span class="va">message</span>.<span class="at">id</span>) <span class="op">{</span></span>
<span id="cb620-8"><a href="mobile-widgets.html#cb620-8"></a>        instanceFamily <span class="op">=</span> property<span class="op">;</span></span>
<span id="cb620-9"><a href="mobile-widgets.html#cb620-9"></a>      <span class="op">}</span></span>
<span id="cb620-10"><a href="mobile-widgets.html#cb620-10"></a>    <span class="op">}</span></span>
<span id="cb620-11"><a href="mobile-widgets.html#cb620-11"></a>  <span class="op">}</span></span>
<span id="cb620-12"><a href="mobile-widgets.html#cb620-12"></a></span>
<span id="cb620-13"><a href="mobile-widgets.html#cb620-13"></a>  <span class="kw">var</span> oldInstance <span class="op">=</span> <span class="va">app</span>.<span class="at">data</span>[instanceFamily][<span class="va">message</span>.<span class="at">id</span>]<span class="op">;</span></span>
<span id="cb620-14"><a href="mobile-widgets.html#cb620-14"></a>  <span class="kw">var</span> oldConfig <span class="op">=</span> <span class="va">oldInstance</span>.<span class="at">params</span><span class="op">;</span></span>
<span id="cb620-15"><a href="mobile-widgets.html#cb620-15"></a>  <span class="kw">var</span> newConfig <span class="op">=</span> <span class="va">app</span>.<span class="va">utils</span>.<span class="at">extend</span>(oldConfig<span class="op">,</span>  <span class="va">message</span>.<span class="at">options</span>)<span class="op">;</span></span>
<span id="cb620-16"><a href="mobile-widgets.html#cb620-16"></a></span>
<span id="cb620-17"><a href="mobile-widgets.html#cb620-17"></a>  <span class="co">// Destroy old instance</span></span>
<span id="cb620-18"><a href="mobile-widgets.html#cb620-18"></a>  <span class="va">oldInstance</span>.<span class="at">destroy</span>()<span class="op">;</span></span>
<span id="cb620-19"><a href="mobile-widgets.html#cb620-19"></a>  <span class="co">// Create new config</span></span>
<span id="cb620-20"><a href="mobile-widgets.html#cb620-20"></a>  <span class="kw">var</span> newInstance <span class="op">=</span> app[instanceFamily].<span class="at">create</span>(newConfig)<span class="op">;</span></span>
<span id="cb620-21"><a href="mobile-widgets.html#cb620-21"></a>  <span class="co">// Update app data</span></span>
<span id="cb620-22"><a href="mobile-widgets.html#cb620-22"></a>  <span class="va">app</span>.<span class="at">data</span>[instanceFamily][<span class="va">message</span>.<span class="at">id</span>] <span class="op">=</span> newInstance<span class="op">;</span></span>
<span id="cb620-23"><a href="mobile-widgets.html#cb620-23"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>

</div>
</div>




<div class="chapter-nav">
<div class="prev"><a href="mobile-pwa.html"><span class="header-section-number">25</span> {shinyMobile} and PWA</a></div>
<div class="next"><a href="going-further-reactR.html"><span class="header-section-number">27</span> R + Shiny + React: welcome {reactR}</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#mobile-widgets"><span class="header-section-number">26</span> Design widgets</a></li>
<li><a class="nav-link" href="#build-the-ui"><span class="header-section-number">26.1</span> Build the UI</a></li>
<li><a class="nav-link" href="#widgets-without-preexisting-ui"><span class="header-section-number">26.2</span> Widgets without preexisting UI</a></li>
<li><a class="nav-link" href="#initialize-the-widget"><span class="header-section-number">26.3</span> Initialize the widget</a></li>
<li><a class="nav-link" href="#update-widgets"><span class="header-section-number">26.4</span> Update widgets</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/blob/master/mobile-widgets.Rmd">View source</a></li>
          <li><a id="book-edit" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/edit/master/mobile-widgets.Rmd">Edit this page</a></li>
        </ul>
</div>
    </nav>
</div>
</div>
  

  

</div>
 <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Outstanding User Interfaces with Shiny</strong>" was written by David Granjon. It waslast built on 2021-01-19.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This website is produced by the <a class="text-light" href="https://bookdown.org">bookdown</a> bs4_book template.</p>
  </div>

</div></div>
</footer>
</body>
</html>
