<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 10 Shiny’s internals | Outstanding User Interfaces with Shiny</title>
<meta name="author" content="David Granjon">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4/tabs.js"></script><script src="libs/bs3compat-0.2.4/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/core-js-2.5.3/shim.min.js"></script><script src="libs/react-16.12.0/react.min.js"></script><script src="libs/react-16.12.0/react-dom.min.js"></script><script src="libs/reactwidget-1.0.0/react-tools.js"></script><link href="libs/font-awesome-5.13.0/css/all.min.css" rel="stylesheet">
<link href="libs/font-awesome-5.13.0/css/v4-shims.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Outstanding User Interfaces with Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="foreword.html">Foreword</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="web-intro.html"><span class="header-section-number">1</span> Shiny and the Web</a></li>
<li><a class="" href="web-dependencies.html"><span class="header-section-number">2</span> Discover Shiny dependencies</a></li>
<li class="book-part">From R to HTML: discover and master {htmltools}:</li>
<li><a class="" href="htmltools-overview.html"><span class="header-section-number">3</span> htmltools overview</a></li>
<li><a class="" href="htmltools-dependencies.html"><span class="header-section-number">4</span> Dependency utilities</a></li>
<li class="book-part">Beautify with CSS and Sass</li>
<li><a class="" href="beautify-css.html"><span class="header-section-number">5</span> CSS for Shiny</a></li>
<li><a class="" href="beautify-sass.html"><span class="header-section-number">6</span> Introduction to SASS</a></li>
<li><a class="" href="beautify-with-fresh.html"><span class="header-section-number">7</span> Beautify with {fresh}</a></li>
<li><a class="" href="beautify-with-bootstraplib.html"><span class="header-section-number">8</span> Beautify with {bslib}</a></li>
<li class="book-part">Unleash interactivity with JavaScript</li>
<li><a class="" href="survival-kit-javascript.html"><span class="header-section-number">9</span> JavaScript for Shiny</a></li>
<li><a class="active" href="shiny-intro.html"><span class="header-section-number">10</span> Shiny’s internals</a></li>
<li><a class="" href="shiny-input-system.html"><span class="header-section-number">11</span> Shiny’s input system</a></li>
<li><a class="" href="shiny-input-lifecycle.html"><span class="header-section-number">12</span> Shiny inputs lifecycles</a></li>
<li><a class="" href="shiny-input-gems.html"><span class="header-section-number">13</span> Hidden gems about inputs</a></li>
<li><a class="" href="shiny-custom-handler.html"><span class="header-section-number">14</span> Dynamically manage content with handlers</a></li>
<li class="book-part">Practice 1: a dashboard template</li>
<li><a class="" href="custom-templates-selection.html"><span class="header-section-number">15</span> Template selection</a></li>
<li><a class="" href="custom-templates-dependencies.html"><span class="header-section-number">16</span> Define dependencies</a></li>
<li><a class="" href="custom-templates-skeleton.html"><span class="header-section-number">17</span> Template skeleton</a></li>
<li><a class="" href="custom-templates-testing.html"><span class="header-section-number">18</span> Testing and validating templates elements</a></li>
<li><a class="" href="custom-templates-inputs.html"><span class="header-section-number">19</span> Develop custom input widgets</a></li>
<li><a class="" href="custom-templates-interactivity.html"><span class="header-section-number">20</span> Adding more interactivity</a></li>
<li class="book-part">Toward a better workflow</li>
<li><a class="" href="workflow-charpente.html"><span class="header-section-number">21</span> Introduction to {charpente}</a></li>
<li><a class="" href="workflow-rpg.html"><span class="header-section-number">22</span> A RPG game with Shiny</a></li>
<li class="book-part">Case study 2: Mobile development with Shiny</li>
<li><a class="" href="mobile-shiny-intro.html"><span class="header-section-number">23</span> Introduction</a></li>
<li><a class="" href="mobile-shinyMobile.html"><span class="header-section-number">24</span> Reconstruct {shinyMobile}</a></li>
<li><a class="" href="mobile-pwa.html"><span class="header-section-number">25</span> {shinyMobile} and PWA</a></li>
<li><a class="" href="mobile-widgets.html"><span class="header-section-number">26</span> Design widgets</a></li>
<li><a class="" href="mobile-going-further.html"><span class="header-section-number">27</span> Going further</a></li>
<li class="book-part">Going further</li>
<li><a class="" href="going-further-reactR.html"><span class="header-section-number">28</span> R + Shiny + React: welcome {reactR}</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DivadNojnarg/outstanding-shiny-ui">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="shiny-intro" class="section level1">
<h1>
<span class="header-section-number">10</span> Shiny’s internals<a class="anchor" aria-label="anchor" href="#shiny-intro"><i class="fas fa-link"></i></a>
</h1>
<p>This rather technical chapter aims at untangling what are the main mechanisms behind a Shiny app.<br>
We particularly highlight some internal processes necessary to the R/JavaScript communication,
which is quite frankly mind blowing.</p>
<div id="the-client-server-model" class="section level2">
<h2>
<span class="header-section-number">10.1</span> The client-server model<a class="anchor" aria-label="anchor" href="#the-client-server-model"><i class="fas fa-link"></i></a>
</h2>
<p>A Shiny app is a <strong>web application</strong> and like all web applications,
it follows the <strong>server-client</strong> model which consists in:</p>
<ul>
<li>A client which sends requests to the server through the network.</li>
<li>A server composed of hardware and software elements that treats the client request.</li>
<li>A network inside which flow requests between the server and the client. It is done
with the HyperText Transfer protocol (HTTP).</li>
</ul>
<p>Each time a client sends a request, it is processed by the server, which provides an answer and closes the connection,
before treating any other request. In practice, to get a webpage, the client emits many requests, one to get the page and then one request per JS/CSS/image assets. As an example, try to run the following in the R console and open the developer tools:</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<p>Under the network tab, we notice many files (if nothing is shown, reload the web browser tab), which actually correspond to all requests made by the client to the server, Figure <a href="shiny-intro.html#fig:shinyapp-requests">10.1</a>. we also get the current answer status, 200 being the OK HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">status</a>, the size and the time needed to treat the request. Nowaday, there exists mechanisms like cache to speed up the request treatment. Don’t believe that each time you visit a shiny app, all requests are answered by the server. Actually, most assests are recovered from the web browser cache, that takes significantly less time, although sometimes misleading. I am sure you already found this situation when, after updating your shiny app style, you still get the old design. Most of the time this is a caching issue and resetting Chrome’s cache solves the problem.</p>
<div class="figure">
<span id="fig:shinyapp-requests"></span>
<img src="images/survival-kit/shinyapp-requests.png" alt="Request flow between client and server at shiny app start." width="100%"><p class="caption">
FIGURE 10.1: Request flow between client and server at shiny app start.
</p>
</div>
</div>
<div id="about-http-requests" class="section level2">
<h2>
<span class="header-section-number">10.2</span> About HTTP requests<a class="anchor" aria-label="anchor" href="#about-http-requests"><i class="fas fa-link"></i></a>
</h2>
<p>If we inspect the first request from Figure <a href="shiny-intro.html#fig:shinyapp-requests">10.1</a>, we obtain Figure <a href="shiny-intro.html#fig:http-request-details">10.2</a>. An HTTP request is composed of:</p>
<ul>
<li>A <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">method</a> that indicates the intentions.
We mostly use <code>GET</code> to ask for something or <code>POST</code>, to submit something.</li>
<li>An url, corresponding to the path to the targeted element. Here, if nothing is specified in the path, the server will try to get the main HTML page, also called <code>index.html</code>.</li>
</ul>
<div class="figure">
<span id="fig:http-request-details"></span>
<img src="images/survival-kit/http-request-details.png" alt="Details about an HTTP request" width="100%"><p class="caption">
FIGURE 10.2: Details about an HTTP request
</p>
</div>
<p>Wait! How does a Shiny app serves files? This is what we are going to see in the next section.</p>
</div>
<div id="shiny-app-lifecycle" class="section level2">
<h2>
<span class="header-section-number">10.3</span> Shiny app lifecycle<a class="anchor" aria-label="anchor" href="#shiny-app-lifecycle"><i class="fas fa-link"></i></a>
</h2>
<p>Like all web apps, a shiny app must be hosted on a server to be accessible by end users, even though during development, we can run it locally. Shiny Apps are usually hosted on different environments:</p>
<ul>
<li>Shiny server <a href="https://rstudio.com/products/shiny/download-server/">open source</a>.</li>
<li>Shiny server <a href="https://rstudio.com/products/shiny-server-pro/">pro</a>.</li>
<li>
<a href="https://rstudio.com/products/connect/evaluation/">RStudio Connect</a>.</li>
<li>
<a href="https://www.shinyapps.io/">shinyapps.io</a>.</li>
</ul>
<p>Whenever a user (client) accesses a shiny app with his web browser, a series of events occurs (Figure <a href="shiny-intro.html#fig:shinyapp-lifecycle">10.3</a>):</p>
<ol style="list-style-type: decimal">
<li>The client sends a HTTP <code>CONNECT</code> request to the server (Shiny server) containing the path
to the targeted app.</li>
<li>The server starts the targeted app with <code><a href="https://rdrr.io/pkg/shiny/man/runApp.html">runApp()</a></code>.</li>
</ol>
<p>Under the hood, <code><a href="https://rdrr.io/pkg/shiny/man/runApp.html">runApp()</a></code>:</p>
<ul>
<li>Calls <code><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp()</a></code> that returns a shiny app object composed of a server function and the UI.
The UI has to be formatted to be a function returning an HTTP response, as requested by <a href="https://github.com/rstudio/httpuv">httpuv</a>.</li>
<li>Calls <code>startApp</code> that creates HTTP and websocket (WS) handlers. WS handlers are responsible for controlling the WS behavior when the app starts, when a message is received from a client and when the app closes. It also creates static path containing all CSS, JS files that may be accessed by the browser.</li>
<li>Calls <code>startServer</code> from <a href="https://github.com/rstudio/httpuv">httpuv</a>, that starts the HTTP server and opens the server websocket connection.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>If the R code does not contain errors, the server returns the Shiny UI HTML code to the client, which is displayed in the web browser.</li>
<li>The returned HTML contains all the necessary JavaScript to subsequently open the client websocket connection.</li>
<li>From there, client and server are free to exchange information</li>
</ol>
<div class="figure">
<span id="fig:shinyapp-lifecycle"></span>
<img src="images/survival-kit/shinyapp-lifecycle.png" alt="Shiny App lifecycle" width="100%"><p class="caption">
FIGURE 10.3: Shiny App lifecycle
</p>
</div>
<p>The following parts detail the most important mechanisms.</p>
<div id="building-the-ui" class="section level3">
<h3>
<span class="header-section-number">10.3.1</span> Building the UI<a class="anchor" aria-label="anchor" href="#building-the-ui"><i class="fas fa-link"></i></a>
</h3>
<p>What definitely makes Shiny wonderful is the ability to only write R code to produce HTML. Although convenient for R users, there is a moment where all this R code has to become HTML, since web browsers are just not able to process R files. Shiny must provide a string containing the HTML code that will be later given to the <a href="https://github.com/rstudio/httpuv">httpuv</a> server and displayed to the end user. These steps heavily relies on <a href="https://github.com/rstudio/htmltools">htmltools</a>, particularly the <code><a href="https://rdrr.io/pkg/htmltools/man/renderDocument.html">renderDocument()</a></code> function. If it has not been documented until here, it’s mainly because you don’t have to do it on your own, unless you try to develop another web framework for R, built on top of <a href="https://github.com/rstudio/httpuv">httpuv</a>, like <code>{ambriorix}</code> or <code>{fiery}</code>. Another use case is <a href="https://github.com/RinteRface/argonR">argonR</a> which allows to design Bootstrap 4 HTML templates, on top of the <a href="https://www.creative-tim.com/product/argon-design-system">argon</a> design system.</p>
<p>Under the hood, <code><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp()</a></code> does many things, particularly creating a valid HTTP response template for <a href="https://github.com/rstudio/httpuv">httpuv</a>, through the internal <code>shiny:::uiHttpHandler</code> function. The conversion from R to HTML is achieved by <code>shiny:::renderPage</code>. First, the provided UI R code is wrapped in a <code>tags$body()</code>, if not yet done. As a reminder <code>fluidPage</code> does not create a <code>body</code> tag, which is required to produce a valid HTML template. The result is given to <code><a href="https://rdrr.io/pkg/htmltools/man/htmlTemplate.html">htmlTemplate()</a></code> to fill the following boilerplate, part of the Shiny package:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb268-1"><a href="shiny-intro.html#cb268-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb268-2"><a href="shiny-intro.html#cb268-2"></a><span class="kw">&lt;html</span><span class="er">{{</span><span class="ot"> if (isTRUE</span><span class="er">(nzchar(lang)))</span><span class="ot"> paste0</span><span class="er">("</span><span class="ot"> lang=</span><span class="st">\</span><span class="er">"",</span><span class="ot"> lang</span><span class="er">,</span> <span class="er">"\"")</span> <span class="er">}}</span><span class="kw">&gt;</span></span>
<span id="cb268-3"><a href="shiny-intro.html#cb268-3"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb268-4"><a href="shiny-intro.html#cb268-4"></a>  {{ headContent() }}</span>
<span id="cb268-5"><a href="shiny-intro.html#cb268-5"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb268-6"><a href="shiny-intro.html#cb268-6"></a>  {{ body }}</span>
<span id="cb268-7"><a href="shiny-intro.html#cb268-7"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>If we assume that our UI is built as follows, applying <code><a href="https://rdrr.io/pkg/htmltools/man/htmlTemplate.html">htmlTemplate()</a></code> on it yields:</p>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textInput.html">textInput</a></span><span class="op">(</span><span class="st">"caption"</span>, <span class="st">"Caption"</span>, <span class="st">"Data Summary"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">verbatimTextOutput</a></span><span class="op">(</span><span class="st">"value"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/htmlTemplate.html">htmlTemplate</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"template"</span>, <span class="st">"default.html"</span>, package <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span>, 
  lang <span class="op">=</span> <span class="st">"en"</span>, 
  body <span class="op">=</span> <span class="va">tags</span><span class="op">$</span><span class="fu">body</span><span class="op">(</span><span class="va">ui</span><span class="op">)</span>, 
  document_ <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb270"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb270-1"><a href="shiny-intro.html#cb270-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb270-2"><a href="shiny-intro.html#cb270-2"></a><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">"en"</span><span class="kw">&gt;</span></span>
<span id="cb270-3"><a href="shiny-intro.html#cb270-3"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb270-4"><a href="shiny-intro.html#cb270-4"></a>    <span class="co">&lt;!-- HEAD_CONTENT --&gt;</span></span>
<span id="cb270-5"><a href="shiny-intro.html#cb270-5"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb270-6"><a href="shiny-intro.html#cb270-6"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb270-7"><a href="shiny-intro.html#cb270-7"></a>    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"container-fluid"</span><span class="kw">&gt;</span></span>
<span id="cb270-8"><a href="shiny-intro.html#cb270-8"></a>      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"form-group shiny-input-container"</span><span class="kw">&gt;</span></span>
<span id="cb270-9"><a href="shiny-intro.html#cb270-9"></a>        <span class="kw">&lt;label</span><span class="ot"> class=</span><span class="st">"control-label"</span><span class="ot"> id=</span><span class="st">"caption-label"</span><span class="ot"> for=</span><span class="st">"caption"</span><span class="kw">&gt;</span>Caption<span class="kw">&lt;/label&gt;</span></span>
<span id="cb270-10"><a href="shiny-intro.html#cb270-10"></a>        <span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">"caption"</span><span class="ot"> type=</span><span class="st">"text"</span><span class="ot"> class=</span><span class="st">"form-control"</span><span class="ot"> value=</span><span class="st">"Data Summary"</span><span class="kw">/&gt;</span></span>
<span id="cb270-11"><a href="shiny-intro.html#cb270-11"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb270-12"><a href="shiny-intro.html#cb270-12"></a>      <span class="kw">&lt;pre</span><span class="ot"> class=</span><span class="st">"shiny-text-output noplaceholder"</span><span class="ot"> id=</span><span class="st">"value"</span><span class="kw">&gt;&lt;/pre&gt;</span></span>
<span id="cb270-13"><a href="shiny-intro.html#cb270-13"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb270-14"><a href="shiny-intro.html#cb270-14"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb270-15"><a href="shiny-intro.html#cb270-15"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>You may wonder what <code>headContent()</code> does. It inserts the string <code>&lt;!-- HEAD_CONTENT --&gt;</code> inside the head so that
shiny knows where to insert the dependencies. Then, all necessary dependencies like jQuery, Bootstrap and shiny css/javascript files (<code>shiny:::shinyDependencies</code>) are added in the UI head by <code><a href="https://rdrr.io/pkg/htmltools/man/renderDocument.html">renderDocument()</a></code>. For instance:</p>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/htmltools">htmltools</a></span><span class="op">)</span>
<span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/renderDocument.html">renderDocument</a></span><span class="op">(</span>
  <span class="va">ui</span>,
  deps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/htmlDependency.html">htmlDependency</a></span><span class="op">(</span><span class="st">"jquery"</span>, <span class="st">"3.5.1"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>href <span class="op">=</span> <span class="st">"shared"</span><span class="op">)</span>, script <span class="op">=</span> <span class="st">"jquery.min.js"</span><span class="op">)</span><span class="op">)</span>, 
    <span class="fu">shiny</span><span class="fu">:::</span><span class="fu">shinyDependencies</span><span class="op">(</span><span class="op">)</span> <span class="co"># JS + CSS</span>
  <span class="op">)</span>,
  processDep <span class="op">=</span> <span class="va">createWebDependency</span>
<span class="op">)</span></code></pre></div>
<p>The final result is shown below:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb272-1"><a href="shiny-intro.html#cb272-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb272-2"><a href="shiny-intro.html#cb272-2"></a><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">"en"</span><span class="kw">&gt;</span></span>
<span id="cb272-3"><a href="shiny-intro.html#cb272-3"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb272-4"><a href="shiny-intro.html#cb272-4"></a>    <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">"Content-Type"</span><span class="ot"> content=</span><span class="st">"text/html; charset=utf-8"</span><span class="kw">/&gt;</span></span>
<span id="cb272-5"><a href="shiny-intro.html#cb272-5"></a>    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">"application/shiny-singletons"</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb272-6"><a href="shiny-intro.html#cb272-6"></a>    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">"application/html-dependencies"</span><span class="kw">&gt;</span>jquery[<span class="dv">3</span>.<span class="fl">5.1</span>]<span class="op">;</span></span>
<span id="cb272-7"><a href="shiny-intro.html#cb272-7"></a>    shiny<span class="op">-</span>css[<span class="dv">1</span>.<span class="fl">6.0</span>]<span class="op">;</span>shiny<span class="op">-</span>javascript[<span class="dv">1</span>.<span class="fl">6.0</span>]<span class="op">;</span>bootstrap[<span class="dv">3</span>.<span class="fl">4.1</span>]<span class="kw">&lt;/script&gt;</span></span>
<span id="cb272-8"><a href="shiny-intro.html#cb272-8"></a>    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">"shared/jquery.min.js"</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb272-9"><a href="shiny-intro.html#cb272-9"></a>    <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">"shared/shiny.min.css"</span><span class="ot"> rel=</span><span class="st">"stylesheet"</span> <span class="kw">/&gt;</span></span>
<span id="cb272-10"><a href="shiny-intro.html#cb272-10"></a>    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">"shared/shiny.min.js"</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb272-11"><a href="shiny-intro.html#cb272-11"></a>    <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">"viewport"</span><span class="ot"> content=</span><span class="st">"width=device-width, initial-scale=1"</span> <span class="kw">/&gt;</span></span>
<span id="cb272-12"><a href="shiny-intro.html#cb272-12"></a>    <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">"shared/bootstrap/css/bootstrap.min.css"</span><span class="ot"> rel=</span><span class="st">"stylesheet"</span> <span class="kw">/&gt;</span></span>
<span id="cb272-13"><a href="shiny-intro.html#cb272-13"></a>    <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">"shared/bootstrap/accessibility/css/bootstrap-accessibility.min.css"</span><span class="ot"> rel=</span><span class="st">"stylesheet"</span> <span class="kw">/&gt;</span></span>
<span id="cb272-14"><a href="shiny-intro.html#cb272-14"></a>    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">"shared/bootstrap/js/bootstrap.min.js"</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb272-15"><a href="shiny-intro.html#cb272-15"></a>    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">"shared/bootstrap/accessibility/js/bootstrap-accessibility.min.js"</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb272-16"><a href="shiny-intro.html#cb272-16"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb272-17"><a href="shiny-intro.html#cb272-17"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb272-18"><a href="shiny-intro.html#cb272-18"></a>    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"container-fluid"</span><span class="kw">&gt;</span></span>
<span id="cb272-19"><a href="shiny-intro.html#cb272-19"></a>      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"form-group shiny-input-container"</span><span class="kw">&gt;</span></span>
<span id="cb272-20"><a href="shiny-intro.html#cb272-20"></a>        <span class="kw">&lt;label</span><span class="ot"> class=</span><span class="st">"control-label"</span><span class="ot"> id=</span><span class="st">"caption-label"</span><span class="ot"> for=</span><span class="st">"caption"</span><span class="kw">&gt;</span>Caption<span class="kw">&lt;/label&gt;</span></span>
<span id="cb272-21"><a href="shiny-intro.html#cb272-21"></a>        <span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">"caption"</span><span class="ot"> type=</span><span class="st">"text"</span><span class="ot"> class=</span><span class="st">"form-control"</span><span class="ot"> value=</span><span class="st">"Data Summary"</span><span class="kw">/&gt;</span></span>
<span id="cb272-22"><a href="shiny-intro.html#cb272-22"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb272-23"><a href="shiny-intro.html#cb272-23"></a>      <span class="kw">&lt;pre</span><span class="ot"> class=</span><span class="st">"shiny-text-output noplaceholder"</span><span class="ot"> id=</span><span class="st">"value"</span><span class="kw">&gt;&lt;/pre&gt;</span></span>
<span id="cb272-24"><a href="shiny-intro.html#cb272-24"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb272-25"><a href="shiny-intro.html#cb272-25"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb272-26"><a href="shiny-intro.html#cb272-26"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>The final step is to return an HTTP response containing the HTML string. As of <a href="https://shiny.rstudio.com/">shiny</a> <code>1.6.0</code>, the <code>httpResponse</code> function is exported by default:</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/httpResponse.html">httpResponse</a></span><span class="op">(</span>
  status <span class="op">=</span> <span class="fl">200</span>,
  content <span class="op">=</span> <span class="va">html</span>
<span class="op">)</span></code></pre></div>
<pre><code>## $status
## [1] 200
## 
## $content_type
## [1] "text/html; charset=UTF-8"
## 
## $content
## &lt;!DOCTYPE html&gt;
## &lt;html lang="en"&gt;
## &lt;head&gt;
##   &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
##   &lt;script type="application/shiny-singletons"&gt;&lt;/script&gt;
##   &lt;script type="application/html-dependencies"&gt;jquery[3.5.1];shiny-css[1.6.0];shiny-javascript[1.6.0];bootstrap[3.4.1]&lt;/script&gt;
## &lt;script src="shared/jquery.min.js"&gt;&lt;/script&gt;
## &lt;link href="shared/shiny.min.css" rel="stylesheet" /&gt;
## &lt;script src="shared/shiny.min.js"&gt;&lt;/script&gt;
## &lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;
## &lt;link href="shared/bootstrap/css/bootstrap.min.css" rel="stylesheet" /&gt;
## &lt;link href="shared/bootstrap/accessibility/css/bootstrap-accessibility.min.css" rel="stylesheet" /&gt;
## &lt;script src="shared/bootstrap/js/bootstrap.min.js"&gt;&lt;/script&gt;
## &lt;script src="shared/bootstrap/accessibility/js/bootstrap-accessibility.min.js"&gt;&lt;/script&gt;
## &lt;/head&gt;
## &lt;body&gt;
##   &lt;div class="container-fluid"&gt;
##     &lt;div class="form-group shiny-input-container"&gt;
##       &lt;label class="control-label" id="caption-label" for="caption"&gt;Caption&lt;/label&gt;
##       &lt;input id="caption" type="text" class="form-control" value="Data Summary"/&gt;
##     &lt;/div&gt;
##     &lt;pre class="shiny-text-output noplaceholder" id="value"&gt;&lt;/pre&gt;
##   &lt;/div&gt;
## &lt;/body&gt;
## &lt;/html&gt;
## 
## 
## $headers
## $headers$`X-UA-Compatible`
## [1] "IE=edge,chrome=1"
## 
## 
## attr(,"class")
## [1] "httpResponse"</code></pre>
</div>
<div id="serving-html-with-httpuv" class="section level3">
<h3>
<span class="header-section-number">10.3.2</span> Serving HTML with <code>{httpuv}</code><a class="anchor" aria-label="anchor" href="#serving-html-with-httpuv"><i class="fas fa-link"></i></a>
</h3>
<p>Once the UI is processed, Shiny make it available to end users by leveraging <a href="https://github.com/rstudio/httpuv">httpuv</a>, which provides tools to set up an HTTP server. The main function is <code>startServer</code> that requires a <strong>host</strong>, <strong>port</strong> and an <strong>app</strong>. If you run a shiny app locally, the default host is <code>localhost</code> or <code>127.0.0.1</code> and the port is randomly chosen by <code>shinyApp</code> or <code>runApp</code>, even though you may fix it. The most important element is the app and <a href="https://github.com/rstudio/httpuv">httpuv</a> expects a list of functions like:</p>
<ul>
<li>
<code>call</code>, to handle the client HTTP request and return the server HTTP response. Depending on the context,
Shiny may return different responses like 403 (unauthorized), 404 (not found) or 200 (OK).</li>
<li>
<code>onHeaders</code> if the request contains headers. For instance, this may be required for authentication.</li>
<li>
<code>staticPaths</code> to serve assets, especially CSS or JS files.</li>
</ul>
<p>A valid <code>call</code> function template containing the previously processed HTML UI is defined below:</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">app</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">app</span><span class="op">$</span><span class="va">call</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    status <span class="op">=</span> <span class="fl">200L</span>,
    headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="st">'Content-Type'</span> <span class="op">=</span> <span class="st">'text/html'</span>
    <span class="op">)</span>,
    body <span class="op">=</span> <span class="va">html</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We then invoke <code>startServer</code>:</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/httpuv">httpuv</a></span><span class="op">)</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/httpuv/man/startServer.html">startServer</a></span><span class="op">(</span>
  <span class="st">"127.0.0.1"</span>,
  <span class="fl">8080</span>,
  <span class="va">app</span>
<span class="op">)</span></code></pre></div>
<p>Now, if we browse to <code>127.0.0.1:8080</code>, we see the text input. However, opening the HTML inspector shows many errors, most of them due to the fact that we forgot to serve static assets, all located in the <code>inst/www/shared</code> folder of the <a href="https://shiny.rstudio.com/">shiny</a> package. Let’s do it below by adding a <code>staticPaths</code> component to our app:</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span> <span class="co"># stop the server before running it again!</span>
<span class="va">app</span><span class="op">$</span><span class="va">staticPaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>shared <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"shiny"</span>, <span class="st">"www"</span>, <span class="st">"shared"</span><span class="op">)</span><span class="op">)</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/httpuv/man/startServer.html">startServer</a></span><span class="op">(</span>
  <span class="st">"127.0.0.1"</span>,
  <span class="fl">8080</span>,
  <span class="va">app</span>
<span class="op">)</span></code></pre></div>
<p>Keep in mind that Shiny does many more things to setup the server and we just highlighted the most important steps.
The above code crashes since the HTML page returned to the client tries to connect to a server websocket, that does not yet exist.</p>
<p>So far so good! You hopefully now better understand how shiny processes the app UI and how it is served. However, this still does not tell how the communication between R and JS is possible.</p>
</div>
<div id="handle-rjs-communication" class="section level3">
<h3>
<span class="header-section-number">10.3.3</span> Handle R/JS communication<a class="anchor" aria-label="anchor" href="#handle-rjs-communication"><i class="fas fa-link"></i></a>
</h3>
<p>This is a built-in Shiny feature leveraging the <a href="https://github.com/rstudio/httpuv">httpuv</a> package.</p>
<div id="what-is-a-websocket" class="section level4">
<h4>
<span class="header-section-number">10.3.3.1</span> What is a websocket?<a class="anchor" aria-label="anchor" href="#what-is-a-websocket"><i class="fas fa-link"></i></a>
</h4>
<p>Before going further let’s define what is a <strong>websocket</strong>. It is an advanced technology allowing <strong>bidirectional communication</strong> between a (or multiple) client(s) and a server. For instance, a <a href="https://dev.to/spukas/learn-websockets-by-building-simple-chat-app-dee">chat</a> system may be built on top of a websocket.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;By default, each time a client connects to the server, a new connection is opened, thereby preventing this client from capturing others connections messages, also called single cast. For a chat, we use a &lt;a href="https://medium.com/the-quarter-espresso/multicast-websocket-nodejs-ff1f400ba2f7"&gt;multi cast&lt;/a&gt; strategy, that is forwarding one client’s message to (all) other connected clients. &lt;code&gt;{httpuv}&lt;/code&gt; does not provide such a feature since this would not make sense and would be harmful in the context of shiny!&lt;/p&gt;'><sup>3</sup></a> The server is generally created using Node.js libraries like <code>ws</code> and the client with JavaScript. In the R Shiny context, the server part is created from <a href="https://github.com/rstudio/httpuv">httpuv</a> <span class="citation">(Cheng and Chang <a href="references.html#ref-R-httpuv" role="doc-biblioref">2021</a>)</span> and the client either with <code>{websocket}</code> <span class="citation">(Chang et al. <a href="references.html#ref-R-websocket" role="doc-biblioref">2020</a>)</span> (see below) or directly from JavaScript, as described later:</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/httpuv">httpuv</a></span><span class="op">)</span>
<span class="co"># set the server</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/httpuv/man/startServer.html">startServer</a></span><span class="op">(</span><span class="st">"127.0.0.1"</span>, <span class="fl">8080</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    onWSOpen <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ws</span><span class="op">)</span> <span class="op">{</span>
      <span class="co"># The ws object is a WebSocket object</span>
      <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Server connection opened.\n"</span><span class="op">)</span>
      
      <span class="va">ws</span><span class="op">$</span><span class="fu">onMessage</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">binary</span>, <span class="va">message</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Server received message:"</span>, <span class="va">message</span>, <span class="st">"\n"</span><span class="op">)</span>
        <span class="va">ws</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"Hello client!"</span><span class="op">)</span>
      <span class="op">}</span><span class="op">)</span>
      <span class="va">ws</span><span class="op">$</span><span class="fu">onClose</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Server connection closed.\n"</span><span class="op">)</span>
      <span class="op">}</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>On the server side, <code><a href="https://rdrr.io/pkg/httpuv/man/startServer.html">startServer()</a></code> also handles websockets. To proceed, the app list must contain an extra element, that is the <code>onWSOpen</code> function, defining all actions to perform after the connection is established. Those actions are listed in the <a href="https://github.com/rstudio/httpuv">httpuv</a> <code>WebSocket</code> R6 class:</p>
<ul>
<li>
<strong>onMessage</strong> is invoked whenever a message is received on this connection.</li>
<li>
<strong>onClose</strong> is invoked when the connection is closed.</li>
<li>
<strong>send</strong> sends a message from the server (to the client).</li>
</ul>
<p>On the client, we may use the <code>{websocket}</code> <code>WebSocket</code> class provided by the <a href="https://github.com/rstudio/websocket">websocket</a> package:</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">websocket</span><span class="op">)</span>
<span class="co"># set the client</span>
<span class="va">ws</span> <span class="op">&lt;-</span> <span class="fu">websocket</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/websocket/man/WebSocket.html">WebSocket</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ws://127.0.0.1:8080/"</span><span class="op">)</span>
<span class="va">ws</span><span class="op">$</span><span class="fu">onMessage</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">event</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Client received message:"</span>, <span class="va">event</span><span class="op">$</span><span class="va">data</span>, <span class="st">"\n"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Wait for a moment before running next line</span>
<span class="va">ws</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"Hello server!"</span><span class="op">)</span>

<span class="co"># Close client</span>
<span class="va">ws</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>We briefly describe the above code:</p>
<ul>
<li>We create a new client socket instance, which triggers the server <code>onWSOpen</code> function, displaying the welcome message.</li>
<li>We set the client <code>ws$onMessage</code> event manager that will print the message sent by the server.</li>
<li>Then a message is sent from the client with <code>ws$send</code>, received on the server and sent back to the client, and so on.
Figure <a href="shiny-intro.html#fig:websocket-basics">10.4</a> shows the main mechanisms.</li>
<li>The client connection is closed, which also closes the server connection.</li>
</ul>
<div class="figure">
<span id="fig:websocket-basics"></span>
<img src="images/survival-kit/websocket-basics.png" alt="Typical websocket flow between client and server." width="100%"><p class="caption">
FIGURE 10.4: Typical websocket flow between client and server.
</p>
</div>
<p>Interestingly, multiple clients can connect to the same server.
You may give it a try with the <code>{OSUICode}</code> side package:</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>
<span class="va">server</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/websocket.html">websocket_server</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">client_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/websocket.html">websocket_client</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">client_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/websocket.html">websocket_client</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">client_1</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"Hello from client 1"</span><span class="op">)</span>
<span class="va">client_2</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"Hello from client 2"</span><span class="op">)</span>
<span class="va">client_1</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span>
<span class="va">client_2</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"Only client 2 is here"</span><span class="op">)</span>
<span class="va">client_2</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">server</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>whose output is shown below.</p>
<pre><code>Server connection opened.
Server connection opened.
Server received message: Hello from client 1 
Client received message: Hello client! 
Server received message: Hello from client 2 
Client received message: Hello client! 
Server connection closed.
Server received message: Only client 2 is here 
Client received message: Hello client! 
Server connection closed.</code></pre>
</div>
<div id="from-R-to-JS" class="section level4">
<h4>
<span class="header-section-number">10.3.3.2</span> Example<a class="anchor" aria-label="anchor" href="#from-R-to-JS"><i class="fas fa-link"></i></a>
</h4>
<p>In practice, Shiny does not use <code>{websocket}</code>. As mentioned earlier, the client is directly built from JS. To better
understand the whole process, we are going to design a simple web page containing an HTML range slider, pass its value from JS to R through the websocket, so that R can do a simple histogram. Moreover, R will also send a message to JS, thereby updating a gauge meter widget located in the page.</p>
<p>To proceed, we need few elements:
- The HTML page containing the slider, gauge and the JS logic to create the client websocket connection, process
the slider value and update the gauge value.
- An app composed of an <a href="https://github.com/rstudio/httpuv">httpuv</a> powered HTTP server serving this HTML page as well as a websocket server to connect R and JS.</p>
<div id="create-the-app" class="section level5">
<h5>
<span class="header-section-number">10.3.3.2.1</span> Create the app<a class="anchor" aria-label="anchor" href="#create-the-app"><i class="fas fa-link"></i></a>
</h5>
<p>As shown above, we use the <code>startServer</code> function, giving it a default port and host such that the url is <code>127.0.0.1:8080</code>. The most important elements
is the app that consists in an HTTP response and a server websocket. The websocket call back may be defined
as below:</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ws_handler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ws</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># The ws object is a WebSocket object</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"New connection opened.\n"</span><span class="op">)</span>
  <span class="co"># Capture client messages</span>
  <span class="va">ws</span><span class="op">$</span><span class="fu">onMessage</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">binary</span>, <span class="va">message</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># create plot</span>
    <span class="va">input_message</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">message</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">input_message</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Number of bins:"</span>, <span class="va">input_message</span><span class="op">$</span><span class="va">value</span>, <span class="st">"\n"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input_message</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co"># update gauge widget</span>
    <span class="va">output_message</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,
        message <span class="op">=</span> <span class="st">"Thanks client! I updated the plot..."</span>
      <span class="op">)</span>,
      pretty <span class="op">=</span> <span class="cn">TRUE</span>,
      auto_unbox <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
    <span class="va">ws</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="va">output_message</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">output_message</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="va">ws</span><span class="op">$</span><span class="fu">onClose</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Server connection closed.\n"</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The critical part is the <code>onMessage</code> call back which has to process the client message. As we’ll send a JSON (from the client), we leverage <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::fromJSON()</a></code> to properly treat the message. It is printed for debugging purposes and the value is injected inside a <code><a href="https://rdrr.io/r/graphics/hist.html">hist(rnorm())</a></code> function. The second task is to send a message to JS in order to update the gauge value. See it like an <code>updateSlider()</code> function for instance. We utilize <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::toJSON()</a></code> to send a random value to JS as well as a polite message.</p>
<p>The HTTP response is returned by the <code>call</code> function and is typically defined as follows:</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">http_response</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    status <span class="op">=</span> <span class="fl">200L</span>,
    headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="st">'Content-Type'</span> <span class="op">=</span> <span class="st">'text/html'</span>
    <span class="op">)</span>,
    body <span class="op">=</span> <span class="st">"Hello world!"</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>It is a list composed of a status code, 200 being the OK HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">status</a>, some headers here indicating
the content nature and the body which is what well be display when the client visits <code>127.0.0.1:8080</code>.
The app code is:</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/httpuv/man/startServer.html">startServer</a></span><span class="op">(</span>
  <span class="st">"127.0.0.1"</span>,
  <span class="fl">8080</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>call <span class="op">=</span> <span class="va">http_reponse</span>, onWSOpen <span class="op">=</span> <span class="va">ws_handler</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>The next step is to replace the <code>http_reponse$body</code> by a real HTML page containing the client websocket handler,
as well as the slider and gauge widgets.</p>
</div>
<div id="design-the-page-content" class="section level5">
<h5>
<span class="header-section-number">10.3.3.2.2</span> Design the page content<a class="anchor" aria-label="anchor" href="#design-the-page-content"><i class="fas fa-link"></i></a>
</h5>
<p>The first task is to create the websocket client connection:</p>
<ul>
<li>We initialize the socket connection with the <code>WebSocket</code> <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">API</a>. It is crucial
that the <strong>host</strong> and <strong>port</strong> match the parameters provided during the websocket server initialization.</li>
<li>We create the event registry that is <code>socket.onopen</code>, <code>socket.onmessage</code>. Inside <code>socket.onmessage</code>, we have to process the message sent from R with <code>JSON.parse</code> that creates an object. Remember that we sent a list from R and are only interested in the <code>val</code> element.</li>
</ul>
<div class="importantblock">
<p>Importantly, we must wait for all elements to be available in the DOM before starting any action. Therefore, we wrap the whole thing inside a <code>document.addEventListener("DOMContentLoaded", ...)</code>.</p>
</div>
<div class="sourceCode" id="cb285"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb285-1"><a href="shiny-intro.html#cb285-1"></a><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">"DOMContentLoaded"</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></span>
<span id="cb285-2"><a href="shiny-intro.html#cb285-2"></a>  <span class="co">// Capture gauge widget</span></span>
<span id="cb285-3"><a href="shiny-intro.html#cb285-3"></a>  <span class="kw">var</span> gauge <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">"mygauge"</span>)<span class="op">;</span></span>
<span id="cb285-4"><a href="shiny-intro.html#cb285-4"></a>  <span class="co">// Initialize client socket connection</span></span>
<span id="cb285-5"><a href="shiny-intro.html#cb285-5"></a>  <span class="kw">var</span> mySocket <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(<span class="st">"ws://&lt;HOST&gt;:&lt;PORT&gt;"</span>)<span class="op">;</span></span>
<span id="cb285-6"><a href="shiny-intro.html#cb285-6"></a>  <span class="va">mySocket</span>.<span class="at">onopen</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb285-7"><a href="shiny-intro.html#cb285-7"></a>    <span class="co">// do things</span></span>
<span id="cb285-8"><a href="shiny-intro.html#cb285-8"></a>  <span class="op">};</span></span>
<span id="cb285-9"><a href="shiny-intro.html#cb285-9"></a>  <span class="co">// Handle server message</span></span>
<span id="cb285-10"><a href="shiny-intro.html#cb285-10"></a>  <span class="va">mySocket</span>.<span class="at">onmessage</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb285-11"><a href="shiny-intro.html#cb285-11"></a>    <span class="kw">var</span> data <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">event</span>.<span class="at">data</span>)<span class="op">;</span></span>
<span id="cb285-12"><a href="shiny-intro.html#cb285-12"></a>    <span class="va">gauge</span>.<span class="at">value</span> <span class="op">=</span> <span class="va">data</span>.<span class="at">val</span><span class="op">;</span></span>
<span id="cb285-13"><a href="shiny-intro.html#cb285-13"></a>  <span class="op">};</span></span>
<span id="cb285-14"><a href="shiny-intro.html#cb285-14"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>We eventually insert it inside the <code>script</code> tag of our basic HTML boilerplate, which also contains the gauge
skeleton. <code>min</code>, <code>max</code> and <code>value</code> set the range, while <code>low</code>, <code>high</code> and <code>optimum</code> are responsible for the color (red, yellow and green, respectively):</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb286-1"><a href="shiny-intro.html#cb286-1"></a><span class="dt">&lt;!DOCTYPE </span>HTML<span class="dt">&gt;</span></span>
<span id="cb286-2"><a href="shiny-intro.html#cb286-2"></a><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">"en"</span><span class="kw">&gt;</span></span>
<span id="cb286-3"><a href="shiny-intro.html#cb286-3"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb286-4"><a href="shiny-intro.html#cb286-4"></a>    <span class="kw">&lt;script</span><span class="ot"> language=</span><span class="st">"javascript"</span><span class="kw">&gt;</span></span>
<span id="cb286-5"><a href="shiny-intro.html#cb286-5"></a>      <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">"DOMContentLoaded"</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></span>
<span id="cb286-6"><a href="shiny-intro.html#cb286-6"></a>        <span class="co">// Capture gauge widget</span></span>
<span id="cb286-7"><a href="shiny-intro.html#cb286-7"></a>        <span class="kw">var</span> gauge <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">"mygauge"</span>)<span class="op">;</span></span>
<span id="cb286-8"><a href="shiny-intro.html#cb286-8"></a>        <span class="co">// Initialize client socket connection</span></span>
<span id="cb286-9"><a href="shiny-intro.html#cb286-9"></a>        <span class="kw">var</span> mySocket <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(<span class="st">"ws://&lt;HOST&gt;:&lt;PORT&gt;"</span>)<span class="op">;</span></span>
<span id="cb286-10"><a href="shiny-intro.html#cb286-10"></a>        <span class="va">mySocket</span>.<span class="at">onopen</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb286-11"><a href="shiny-intro.html#cb286-11"></a>          <span class="co">// do things</span></span>
<span id="cb286-12"><a href="shiny-intro.html#cb286-12"></a>        <span class="op">};</span></span>
<span id="cb286-13"><a href="shiny-intro.html#cb286-13"></a>        <span class="co">// Handle server message</span></span>
<span id="cb286-14"><a href="shiny-intro.html#cb286-14"></a>        <span class="va">mySocket</span>.<span class="at">onmessage</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb286-15"><a href="shiny-intro.html#cb286-15"></a>          <span class="kw">var</span> data <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">event</span>.<span class="at">data</span>)<span class="op">;</span></span>
<span id="cb286-16"><a href="shiny-intro.html#cb286-16"></a>          <span class="va">gauge</span>.<span class="at">value</span> <span class="op">=</span> <span class="va">data</span>.<span class="at">val</span><span class="op">;</span></span>
<span id="cb286-17"><a href="shiny-intro.html#cb286-17"></a>        <span class="op">};</span></span>
<span id="cb286-18"><a href="shiny-intro.html#cb286-18"></a>      <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb286-19"><a href="shiny-intro.html#cb286-19"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb286-20"><a href="shiny-intro.html#cb286-20"></a>    <span class="kw">&lt;title&gt;</span>Websocket Example<span class="kw">&lt;/title&gt;</span></span>
<span id="cb286-21"><a href="shiny-intro.html#cb286-21"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb286-22"><a href="shiny-intro.html#cb286-22"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb286-23"><a href="shiny-intro.html#cb286-23"></a>    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">"mygauge"</span><span class="kw">&gt;</span>Gauge:<span class="kw">&lt;/label&gt;</span></span>
<span id="cb286-24"><a href="shiny-intro.html#cb286-24"></a>    <span class="kw">&lt;meter</span><span class="ot"> id=</span><span class="st">"mygauge"</span><span class="ot"> min=</span><span class="st">"0"</span><span class="ot"> max=</span><span class="st">"100"</span><span class="ot"> low=</span><span class="st">"33"</span><span class="ot"> high=</span><span class="st">"66"</span><span class="ot"> optimum=</span><span class="st">"80"</span><span class="ot"> value=</span><span class="st">"50"</span><span class="kw">&gt;&lt;/meter&gt;</span></span>
<span id="cb286-25"><a href="shiny-intro.html#cb286-25"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb286-26"><a href="shiny-intro.html#cb286-26"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>Once done, we have to take care of the range slider whose code is taken from the MDN <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Input/range">resources</a>:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb287-1"><a href="shiny-intro.html#cb287-1"></a><span class="kw">&lt;div&gt;</span></span>
<span id="cb287-2"><a href="shiny-intro.html#cb287-2"></a>  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">"range"</span><span class="ot"> id=</span><span class="st">"slider"</span><span class="ot"> name=</span><span class="st">"volume"</span><span class="ot"> min=</span><span class="st">"0"</span><span class="ot"> max=</span><span class="st">"100"</span><span class="kw">&gt;</span></span>
<span id="cb287-3"><a href="shiny-intro.html#cb287-3"></a>  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">"slider"</span><span class="ot"> id</span> <span class="ot">=</span><span class="st">"sliderLabel"</span><span class="kw">&gt;</span>Value:<span class="kw">&lt;/label&gt;</span></span>
<span id="cb287-4"><a href="shiny-intro.html#cb287-4"></a><span class="kw">&lt;/div&gt;</span></span></code></pre></div>
<p>It is a simple div containing an input tag as well as a label. The input tag has some attributes, notably the
minimum and maximum value. The slider has to be inserted in the HTML boilerplate shown below:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb288-1"><a href="shiny-intro.html#cb288-1"></a><span class="dt">&lt;!DOCTYPE </span>HTML<span class="dt">&gt;</span></span>
<span id="cb288-2"><a href="shiny-intro.html#cb288-2"></a><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">"en"</span><span class="kw">&gt;</span></span>
<span id="cb288-3"><a href="shiny-intro.html#cb288-3"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb288-4"><a href="shiny-intro.html#cb288-4"></a>    <span class="kw">&lt;script</span><span class="ot"> language=</span><span class="st">"javascript"</span><span class="kw">&gt;</span></span>
<span id="cb288-5"><a href="shiny-intro.html#cb288-5"></a>      <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">"DOMContentLoaded"</span><span class="op">,</span> <span class="kw">function</span>(event) <span class="op">{</span></span>
<span id="cb288-6"><a href="shiny-intro.html#cb288-6"></a>        <span class="co">// Capture gauge widget</span></span>
<span id="cb288-7"><a href="shiny-intro.html#cb288-7"></a>        <span class="kw">var</span> gauge <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">"mygauge"</span>)<span class="op">;</span></span>
<span id="cb288-8"><a href="shiny-intro.html#cb288-8"></a>        <span class="co">// Initialize client socket connection</span></span>
<span id="cb288-9"><a href="shiny-intro.html#cb288-9"></a>        <span class="kw">var</span> mySocket <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(<span class="st">"ws://&lt;HOST&gt;:&lt;PORT&gt;"</span>)<span class="op">;</span></span>
<span id="cb288-10"><a href="shiny-intro.html#cb288-10"></a>        <span class="va">mySocket</span>.<span class="at">onopen</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb288-11"><a href="shiny-intro.html#cb288-11"></a>          <span class="co">// do things</span></span>
<span id="cb288-12"><a href="shiny-intro.html#cb288-12"></a>        <span class="op">};</span></span>
<span id="cb288-13"><a href="shiny-intro.html#cb288-13"></a>        <span class="co">// Handle server message</span></span>
<span id="cb288-14"><a href="shiny-intro.html#cb288-14"></a>        <span class="va">mySocket</span>.<span class="at">onmessage</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb288-15"><a href="shiny-intro.html#cb288-15"></a>          <span class="kw">var</span> data <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">event</span>.<span class="at">data</span>)<span class="op">;</span></span>
<span id="cb288-16"><a href="shiny-intro.html#cb288-16"></a>          <span class="va">gauge</span>.<span class="at">value</span> <span class="op">=</span> <span class="va">data</span>.<span class="at">val</span><span class="op">;</span></span>
<span id="cb288-17"><a href="shiny-intro.html#cb288-17"></a>        <span class="op">};</span></span>
<span id="cb288-18"><a href="shiny-intro.html#cb288-18"></a>      <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb288-19"><a href="shiny-intro.html#cb288-19"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb288-20"><a href="shiny-intro.html#cb288-20"></a>    <span class="kw">&lt;title&gt;</span>Websocket Example<span class="kw">&lt;/title&gt;</span></span>
<span id="cb288-21"><a href="shiny-intro.html#cb288-21"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb288-22"><a href="shiny-intro.html#cb288-22"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb288-23"><a href="shiny-intro.html#cb288-23"></a>    <span class="kw">&lt;div&gt;</span></span>
<span id="cb288-24"><a href="shiny-intro.html#cb288-24"></a>      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">"range"</span><span class="ot"> id=</span><span class="st">"slider"</span><span class="ot"> name=</span><span class="st">"volume"</span><span class="ot"> min=</span><span class="st">"0"</span><span class="ot"> max=</span><span class="st">"100"</span><span class="kw">&gt;</span></span>
<span id="cb288-25"><a href="shiny-intro.html#cb288-25"></a>      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">"slider"</span><span class="ot"> id</span> <span class="ot">=</span><span class="st">"sliderLabel"</span><span class="kw">&gt;&lt;/label&gt;</span></span>
<span id="cb288-26"><a href="shiny-intro.html#cb288-26"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb288-27"><a href="shiny-intro.html#cb288-27"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb288-28"><a href="shiny-intro.html#cb288-28"></a>    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">"mygauge"</span><span class="kw">&gt;</span>Gauge:<span class="kw">&lt;/label&gt;</span></span>
<span id="cb288-29"><a href="shiny-intro.html#cb288-29"></a>    <span class="kw">&lt;meter</span><span class="ot"> id=</span><span class="st">"mygauge"</span><span class="ot"> min=</span><span class="st">"0"</span><span class="ot"> max=</span><span class="st">"100"</span><span class="ot"> low=</span><span class="st">"33"</span><span class="ot"> high=</span><span class="st">"66"</span><span class="ot"> optimum=</span><span class="st">"80"</span><span class="ot"> value=</span><span class="st">"50"</span><span class="kw">&gt;&lt;/meter&gt;</span></span>
<span id="cb288-30"><a href="shiny-intro.html#cb288-30"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb288-31"><a href="shiny-intro.html#cb288-31"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>The slider behavior is entirely controlled with JS. We recover its value with <code>document.getElementById</code> and
add it to the label inner HTML so as to know the current value. We also add an event listener to update the slider value each time the range is updated, either by drag or by keyboard action with <code>oninput</code>. It is best practice to
convert the slider value to a number with <code>parseInt</code>, as the returned value defaults to a string. Finally, we send the value through the websocket, converting it to JSON so that we may process it from R with <a href="https://arxiv.org/abs/1403.2805">jsonlite</a> (or any other relevant package):</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb289-1"><a href="shiny-intro.html#cb289-1"></a><span class="kw">var</span> sliderWidget <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">"slider"</span>)<span class="op">;</span></span>
<span id="cb289-2"><a href="shiny-intro.html#cb289-2"></a><span class="kw">var</span> label <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">"sliderLabel"</span>)<span class="op">;</span></span>
<span id="cb289-3"><a href="shiny-intro.html#cb289-3"></a><span class="va">label</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="st">"Value:"</span> <span class="op">+</span> <span class="va">slider</span>.<span class="at">value</span><span class="op">;</span> <span class="co">// init</span></span>
<span id="cb289-4"><a href="shiny-intro.html#cb289-4"></a><span class="co">// on change</span></span>
<span id="cb289-5"><a href="shiny-intro.html#cb289-5"></a><span class="va">sliderWidget</span>.<span class="at">oninput</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb289-6"><a href="shiny-intro.html#cb289-6"></a>  <span class="kw">var</span> val <span class="op">=</span> <span class="at">parseInt</span>(<span class="kw">this</span>.<span class="at">value</span>)<span class="op">;</span></span>
<span id="cb289-7"><a href="shiny-intro.html#cb289-7"></a>  <span class="va">mySocket</span>.<span class="at">send</span>(</span>
<span id="cb289-8"><a href="shiny-intro.html#cb289-8"></a>    <span class="va">JSON</span>.<span class="at">stringify</span>(<span class="op">{</span></span>
<span id="cb289-9"><a href="shiny-intro.html#cb289-9"></a>      <span class="dt">value</span><span class="op">:</span> val<span class="op">,</span></span>
<span id="cb289-10"><a href="shiny-intro.html#cb289-10"></a>      <span class="dt">message</span><span class="op">:</span> <span class="st">"New value for you server!"</span></span>
<span id="cb289-11"><a href="shiny-intro.html#cb289-11"></a>    <span class="op">}</span>)</span>
<span id="cb289-12"><a href="shiny-intro.html#cb289-12"></a>  )<span class="op">;</span></span>
<span id="cb289-13"><a href="shiny-intro.html#cb289-13"></a>  <span class="va">label</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="st">"Value:"</span> <span class="op">+</span> val<span class="op">;</span></span>
<span id="cb289-14"><a href="shiny-intro.html#cb289-14"></a><span class="op">};</span></span></code></pre></div>
</div>
</div>
<div id="test-it" class="section level4">
<h4>
<span class="header-section-number">10.3.3.3</span> Test it!<a class="anchor" aria-label="anchor" href="#test-it"><i class="fas fa-link"></i></a>
</h4>
<p>For convenience, the whole code is provided by <code><a href="https://rdrr.io/pkg/OSUICode/man/httpuv_app.html">OSUICode::httpuv_app()</a></code>. Run that function in the R console
and browse to <code>127.0.0.1:8080</code> with Chrome. You should see the range slider as well as its current value. We suggest
the reader to have R and Chrome side by side, to properly see the messages send between R and JS. In Chrome,
open the developer tools and navigate to the Network tab and select the <code>websocket</code> entry, as show Figure <a href="shiny-intro.html#fig:httpuv-websocket-demo">10.5</a>. From now, you may change the slider value. Notice the green arrow message appearing
in the developer tools. This indicates a message sent by the client: here a JSON containing the slider value as well as a tiny message, to be polite with the server. In the R console, you may inspect the received message (it should be the same as the client!). R is instructed to create a new plot and, once done, sends a message back to the client (red arrow) to indicate that the plot is updated and a new value has been generated for the gauge.</p>
<div class="figure">
<span id="fig:httpuv-websocket-demo"></span>
<img src="images/survival-kit/httpuv-websocket-demo.png" alt="Server client communication through websocket" width="100%"><p class="caption">
FIGURE 10.5: Server client communication through websocket
</p>
</div>
</div>
<div id="clients-concurrency" class="section level4">
<h4>
<span class="header-section-number">10.3.3.4</span> Clients concurrency<a class="anchor" aria-label="anchor" href="#clients-concurrency"><i class="fas fa-link"></i></a>
</h4>
<p>Not shown in the above sections, <code><a href="https://rdrr.io/pkg/OSUICode/man/httpuv_app.html">httpuv_app()</a></code> exposes a delay parameter that simulates a computationally intense task on the server:</p>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ws</span><span class="op">$</span><span class="fu">onMessage</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">binary</span>, <span class="va">message</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">message</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">message</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Number of bins:"</span>, <span class="va">message</span><span class="op">$</span><span class="va">value</span>, <span class="st">"\n"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">message</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span>
  <span class="va">ws</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"Thanks client! I updated the plot."</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>This is to simulate concurrency that could occur between multiple client. To test it, you may try to call <code>my_app &lt;- httpuv_app(5)</code>, open two browser tabs pointing to <code>127.0.0.1:8080</code>, update the slider on the first client and update it on the second client. What happens? Why? This illustrates one fundamental limitation about Shiny: as R is single threaded, clients have to queue to get an answer from the server.</p>
<div class="importantblock">
<p>Once done, don’t forget to close the server connection with <code>my_app$stop()</code>!</p>
</div>
<p>In practice, Shiny’s core is much more complex but hopefully, you should get a better understanding of the general idea!
The reader must understand that when Shiny inputs/outputs are modified on the client by an end user, there are a lot of exchanges between R and JS, through the websocket. In the following, we briefly describe how Shiny leverages this technology, on both server and client side.</p>
</div>
<div id="shiny-and-websockets" class="section level4">
<h4>
<span class="header-section-number">10.3.3.5</span> Shiny and websockets<a class="anchor" aria-label="anchor" href="#shiny-and-websockets"><i class="fas fa-link"></i></a>
</h4>
<p>In the previous section, we showed how R and JS can communicate through a <a href="https://github.com/rstudio/httpuv">httpuv</a> powered websocket. Now let’s see what happens in the context of Shiny.</p>
<div id="shiny-session" class="section level5">
<h5>
<span class="header-section-number">10.3.3.5.1</span> The Shiny session object<a class="anchor" aria-label="anchor" href="#shiny-session"><i class="fas fa-link"></i></a>
</h5>
<p>We won’t be able to go anywhere without giving some reminders about the Shiny <a href="https://shiny.rstudio.com/reference/shiny/1.4.0/session.html">session</a> object. Why do we say object? <code>session</code> is actually an instance of the <a href="https://github.com/rstudio/shiny/blob/master/R/shiny.R"><code>ShinySession</code></a> R6 class.
Importantly, the session is unique to a given user. It means that 2 different clients cannot share the same session. This is important since it contains all information about input, output and client data.</p>
<p>Upon calling <code>ShinySession$new()</code>, the initialization method takes one parameter, namely the websocket. As shown in the last section, the websocket allows bidirectional exchanges between R and JS. The session object exposes two methods to communicate with JavaScript:</p>
<ul>
<li>
<code>sendCustomMessage</code> sends messages from R to JS. It calls the private <code>sendMessage</code> method which itself calls <code>write</code>. The message is sent only when the session is opened, through the websocket <code>private$websocket$send(json)</code>. If the <code>shiny.trace</code> <a href="https://shiny.rstudio.com/reference/shiny/0.14/shiny-options.html">option</a> is TRUE, a message showing the sent JSON is displayed, which is useful for debugging.</li>
<li>
<code>sendInputMessage</code> is used to update inputs from the server. The message is stored in a message queue and ultimately sent through the websocket <code>private$websocket$send(json)</code>.</li>
</ul>
<p>The below code is extracted from the <code>shiny.R</code> <a href="https://github.com/rstudio/shiny/blob/master/R/shiny.R">file</a>.</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sendCustomMessage</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">type</span>, <span class="va">message</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">data</span><span class="op">[[</span><span class="va">type</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">message</span>
  <span class="va">private</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span>custom <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">sendInputMessage</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputId</span>, <span class="va">message</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">inputId</span>, message <span class="op">=</span> <span class="va">message</span><span class="op">)</span>
  
  <span class="co"># Add to input message queue</span>
  <span class="va">private</span><span class="op">$</span><span class="va">inputMessageQueue</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">inputMessageQueue</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">data</span>
  <span class="co"># Needed so that Shiny knows to actually flush the input message queue</span>
  <span class="va">self</span><span class="op">$</span><span class="fu">requestFlush</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">sendMessage</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># This function is a wrapper for $write</span>
  <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu">anyUnnamed</span><span class="op">(</span><span class="va">msg</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"All arguments to sendMessage must be named."</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">private</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="fu">toJSON</span><span class="op">(</span><span class="va">msg</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">write</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">json</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">closed</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">traceOption</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">'shiny.trace'</span>, <span class="cn">FALSE</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="va">traceOption</span><span class="op">)</span> <span class="op">||</span> <span class="va">traceOption</span> <span class="op">==</span> <span class="st">"send"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">'SEND '</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">'(?m)base64,[a-zA-Z0-9+/=]+'</span>,<span class="st">'[base64 data]'</span>,<span class="va">json</span>,perl<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
  <span class="va">private</span><span class="op">$</span><span class="va">websocket</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="va">json</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># ...</span></code></pre></div>
<p>No worry if it is not clear at the moment. We will discuss <code>sendInputMessage</code> and <code>sendCustomMessage</code> in the following chapters, respectivelly <a href="shiny-input-system.html#shiny-input-system">11</a> and <a href="shiny-custom-handler.html#shiny-custom-handler">14</a>.</p>
</div>
<div id="server-side" class="section level5">
<h5>
<span class="header-section-number">10.3.3.5.2</span> Server side<a class="anchor" aria-label="anchor" href="#server-side"><i class="fas fa-link"></i></a>
</h5>
<p>On the server, that is R, a websocket is initiated in the <a href="https://github.com/rstudio/shiny/blob/master/R/server.R#L440">startApp</a> function, leveraging the <a href="https://github.com/rstudio/httpuv">httpuv</a> package. Websocket handlers are <a href="https://github.com/rstudio/shiny/blob/master/R/server.R#L133">defined</a> by <code>createAppHandlers</code>:</p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ws</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ws</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># many things</span>
  
  <span class="va">shinysession</span> <span class="op">&lt;-</span> <span class="va">ShinySession</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">ws</span><span class="op">)</span>
  
  <span class="va">ws</span><span class="op">$</span><span class="fu">onMessage</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">binary</span>, <span class="va">msg</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># If unhandled errors occur, make sure they get properly logged</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/stacktrace.html">withLogErrors</a></span><span class="op">(</span><span class="fu">messageHandler</span><span class="op">(</span><span class="va">binary</span>, <span class="va">msg</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="va">ws</span><span class="op">$</span><span class="fu">onClose</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">shinysession</span><span class="op">$</span><span class="fu">wsClosed</span><span class="op">(</span><span class="op">)</span>
    <span class="va">appsByToken</span><span class="op">$</span><span class="fu">remove</span><span class="op">(</span><span class="va">shinysession</span><span class="op">$</span><span class="va">token</span><span class="op">)</span>
    <span class="va">appsNeedingFlush</span><span class="op">$</span><span class="fu">remove</span><span class="op">(</span><span class="va">shinysession</span><span class="op">$</span><span class="va">token</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Overall, they drive the server websocket behavior. When the Shiny session is initialized, a message is sent through the WS, providing the sessionId, workerId and user to the client (see <code>Shiny.shinyapp.config</code> and section <a href="survival-kit-javascript.html#shiny-js-object">9.6.3</a>):</p>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">private</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span>
  config <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    workerId <span class="op">=</span> <span class="fu">workerId</span><span class="op">(</span><span class="op">)</span>,
    sessionId <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">token</span>,
    user <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">user</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p><code>ws$onMessage</code> describes what should happen when the server receives an message from the client.
It applies the <code>messageHandler</code> function that, in short:</p>
<ul>
<li>Decodes the received message.</li>
<li>Processes the message. At initialization, the client send a message with an <code>init</code> method tag,
which tells Shiny to manage input (<code>manageInputs(msg$data, now = TRUE)</code>) before running any observer (since input don’t have value yet). After initialization, client messages have the <code>update</code> tag, meaning that we wait for observers to run before.</li>
</ul>
<p>Finally, when the server connection is closed, all client connections are also closed.</p>
<p>All those handlers are <a href="https://github.com/rstudio/shiny/blob/master/R/server.R#L367">applied</a> by <code>handlerManager$addWSHandler(appHandlers$ws, "/", tail = TRUE)</code>:</p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># see middleware.R</span>
<span class="va">httpuvApp</span> <span class="op">&lt;-</span> <span class="va">handlerManager</span><span class="op">$</span><span class="fu">createHttpuvApp</span><span class="op">(</span><span class="op">)</span>

<span class="va">onWSOpen</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ws</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">wsHandlers</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span><span class="va">ws</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">addWSHandler</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">wsHandler</span>, <span class="va">key</span>, <span class="va">tail</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">wsHandlers</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">wsHandler</span>, <span class="va">key</span>, <span class="va">tail</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Note that the R option <code><a href="https://rdrr.io/r/base/options.html">options(shiny.trace = TRUE)</a></code> allows the websocket messages to be displayed directly in the R console.</p>
</div>
<div id="client-side" class="section level5">
<h5>
<span class="header-section-number">10.3.3.5.3</span> Client side<a class="anchor" aria-label="anchor" href="#client-side"><i class="fas fa-link"></i></a>
</h5>
<p>On the JS side, the socket creation occurs in the <code>shinyapps.js</code> <a href="https://github.com/rstudio/shiny/blob/60db1e02b03d8e6fb146c9bb1bbfbce269231add/srcjs/shinyapp.js#L58">file</a>:</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb295-1"><a href="shiny-intro.html#cb295-1"></a><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(protocol <span class="op">+</span> <span class="st">'//'</span> <span class="op">+</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">host</span> <span class="op">+</span> defaultPath)<span class="op">;</span></span></code></pre></div>
<p>through the <code>WebSocket</code> object. <code>protocol</code> is the chosen protocol, either <code>ws</code> or <code>wss</code> (if using <code>https</code>). <code>window.location.host</code> contains the host name and its <a href="https://developer.mozilla.org/fr/docs/Web/API/window/location">port</a>.
Once the connection is opened, events are handled with the <code>onopen</code> event registry:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb296-1"><a href="shiny-intro.html#cb296-1"></a><span class="va">socket</span>.<span class="at">onopen</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb296-2"><a href="shiny-intro.html#cb296-2"></a>  hasOpened <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb296-3"><a href="shiny-intro.html#cb296-3"></a></span>
<span id="cb296-4"><a href="shiny-intro.html#cb296-4"></a>  <span class="at">$</span>(document).<span class="at">trigger</span>(<span class="op">{</span></span>
<span id="cb296-5"><a href="shiny-intro.html#cb296-5"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">'shiny:connected'</span><span class="op">,</span></span>
<span id="cb296-6"><a href="shiny-intro.html#cb296-6"></a>    <span class="dt">socket</span><span class="op">:</span> socket</span>
<span id="cb296-7"><a href="shiny-intro.html#cb296-7"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb296-8"><a href="shiny-intro.html#cb296-8"></a></span>
<span id="cb296-9"><a href="shiny-intro.html#cb296-9"></a>  <span class="va">self</span>.<span class="at">onConnected</span>()<span class="op">;</span> <span class="co">// remove overlay</span></span>
<span id="cb296-10"><a href="shiny-intro.html#cb296-10"></a></span>
<span id="cb296-11"><a href="shiny-intro.html#cb296-11"></a>  <span class="va">socket</span>.<span class="at">send</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(<span class="op">{</span></span>
<span id="cb296-12"><a href="shiny-intro.html#cb296-12"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">'init'</span><span class="op">,</span></span>
<span id="cb296-13"><a href="shiny-intro.html#cb296-13"></a>    <span class="dt">data</span><span class="op">:</span> <span class="va">self</span>.<span class="at">$initialInput</span></span>
<span id="cb296-14"><a href="shiny-intro.html#cb296-14"></a>  <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb296-15"><a href="shiny-intro.html#cb296-15"></a></span>
<span id="cb296-16"><a href="shiny-intro.html#cb296-16"></a>  <span class="cf">while</span> (<span class="va">self</span>.<span class="va">$pendingMessages</span>.<span class="at">length</span>) <span class="op">{</span></span>
<span id="cb296-17"><a href="shiny-intro.html#cb296-17"></a>    <span class="kw">var</span> msg <span class="op">=</span> <span class="va">self</span>.<span class="va">$pendingMessages</span>.<span class="at">shift</span>()<span class="op">;</span></span>
<span id="cb296-18"><a href="shiny-intro.html#cb296-18"></a>    <span class="va">socket</span>.<span class="at">send</span>(msg)<span class="op">;</span></span>
<span id="cb296-19"><a href="shiny-intro.html#cb296-19"></a>  <span class="op">}</span></span>
<span id="cb296-20"><a href="shiny-intro.html#cb296-20"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>shiny:connected</code> event is triggered, any disconnected overlay (the famous grayed out screen) is then removed from the DOM. Initial input values are sent to the server via the <code>send</code> method. The <code>onmessage</code> registry aims at handling messages received from the server:</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb297-1"><a href="shiny-intro.html#cb297-1"></a><span class="va">socket</span>.<span class="at">onmessage</span> <span class="op">=</span> <span class="kw">function</span>(e) <span class="op">{</span></span>
<span id="cb297-2"><a href="shiny-intro.html#cb297-2"></a>  <span class="va">self</span>.<span class="at">dispatchMessage</span>(<span class="va">e</span>.<span class="at">data</span>)<span class="op">;</span></span>
<span id="cb297-3"><a href="shiny-intro.html#cb297-3"></a><span class="op">};</span></span></code></pre></div>
<p>It subsequently invokes the <code>dispatchMessage</code> method that sends message to all handlers (through <code>_sendMessagesToHandlers</code>), triggering the <code>shiny:message</code> event. Shiny has internal and custom provided handlers (understand user-defined) stored in separate arrays. Each time, a message type matches a given handler, it is treated. For instance, there is a dedicated internal handler for input messages, that bridges the gap between a given input and the corresponding input binding. This handler eventually triggers the <code>inputBinding.receiveMessage</code> method so that the input value is updated on the client. We discuss this in detail in the following section <a href="shiny-input-lifecycle.html#update-input-lifecycle">12.2</a>.</p>
<p>Finally the <code>onclose</code> method is called when the websocket connection is closed.</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb298-1"><a href="shiny-intro.html#cb298-1"></a><span class="va">socket</span>.<span class="at">onclose</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb298-2"><a href="shiny-intro.html#cb298-2"></a>  <span class="co">// These things are needed only if we've successfully opened the</span></span>
<span id="cb298-3"><a href="shiny-intro.html#cb298-3"></a>  <span class="co">// websocket.</span></span>
<span id="cb298-4"><a href="shiny-intro.html#cb298-4"></a>  <span class="cf">if</span> (hasOpened) <span class="op">{</span></span>
<span id="cb298-5"><a href="shiny-intro.html#cb298-5"></a>    <span class="at">$</span>(document).<span class="at">trigger</span>(<span class="op">{</span></span>
<span id="cb298-6"><a href="shiny-intro.html#cb298-6"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">'shiny:disconnected'</span><span class="op">,</span></span>
<span id="cb298-7"><a href="shiny-intro.html#cb298-7"></a>      <span class="dt">socket</span><span class="op">:</span> socket</span>
<span id="cb298-8"><a href="shiny-intro.html#cb298-8"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb298-9"><a href="shiny-intro.html#cb298-9"></a></span>
<span id="cb298-10"><a href="shiny-intro.html#cb298-10"></a>    <span class="va">self</span>.<span class="at">$notifyDisconnected</span>()<span class="op">;</span></span>
<span id="cb298-11"><a href="shiny-intro.html#cb298-11"></a>  <span class="op">}</span></span>
<span id="cb298-12"><a href="shiny-intro.html#cb298-12"></a></span>
<span id="cb298-13"><a href="shiny-intro.html#cb298-13"></a>  <span class="va">self</span>.<span class="at">onDisconnected</span>()<span class="op">;</span> <span class="co">// Must be run before self.$removeSocket()</span></span>
<span id="cb298-14"><a href="shiny-intro.html#cb298-14"></a>  <span class="va">self</span>.<span class="at">$removeSocket</span>()<span class="op">;</span></span>
<span id="cb298-15"><a href="shiny-intro.html#cb298-15"></a><span class="op">}</span></span></code></pre></div>
<p>If the connection was opened, the <code>shiny:disconnected</code> event is triggered. Then, the disconnect overlay is added to the DOM (grayed out screen) and the socket is removed.</p>
<p>Should any error occurs in the R code, the server sends the error through the websocket, which is captured by the client and displayed.</p>
</div>
<div id="debug-websocket-with-shiny" class="section level5">
<h5>
<span class="header-section-number">10.3.3.5.4</span> Debug websocket with Shiny<a class="anchor" aria-label="anchor" href="#debug-websocket-with-shiny"><i class="fas fa-link"></i></a>
</h5>
<p>Let’s run the following app (see <a href="shiny-intro.html#fig:shiny-websocket">10.6</a>, left panel):</p>
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>
  ui <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span><span class="st">"variable"</span>, <span class="st">"Variable:"</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Cylinders"</span> <span class="op">=</span> <span class="st">"cyl"</span>,
                  <span class="st">"Transmission"</span> <span class="op">=</span> <span class="st">"am"</span>,
                  <span class="st">"Gears"</span> <span class="op">=</span> <span class="st">"gear"</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/tableOutput.html">tableOutput</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span>
  <span class="op">)</span>,
  server <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output</span><span class="op">$</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span><span class="op">{</span>
      <span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mpg"</span>, <span class="va">input</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
    <span class="op">}</span>, rownames <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>After opening the HTML inspector, we select the network tab and search for websocket in the list. By choosing the message tab, you may inspect what R and JavaScript say to each others. As stated above, the first message sent contains initial input values. Then Shiny recalculates the table, notify when the recalculation is done and becomes idle. The second message received from R is after updating the select input, which triggers the same event cycle.</p>
<p>Although complex, it is extremely useful to check whether the input / output communication is working properly. If not, we would see the error field identifying the issue.</p>
<p><code>Shiny.shinyapp.$socket.readyState</code> returns the state of the socket connection. It should be 1 if your app is running. In some instances when the socket is closed, an error would be raised.</p>
<div class="figure">
<span id="fig:shiny-websocket"></span>
<img src="images/survival-kit/shiny-websocket.png" alt="Shiny websocket" width="100%"><p class="caption">
FIGURE 10.6: Shiny websocket
</p>
</div>
<p>We see below that we can even bypass the UI element and update the input value directly via the websocket using <code>Shiny.shinyapp.$sendMsg</code> with the <code>update</code> method. This is captured on the server side which triggers the output recalculation. We’ll discuss more about this in the next section <a href="shiny-input-system.html#shiny-input-system">11</a>.</p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">updateObsVal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span>
    <span class="st">"Shiny.shinyapp.$sendMsg(JSON.stringify({
      method: 'update',
      data: {obs: %s}
    }));"</span>,
    <span class="va">value</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="co"># below we shunt the slider input by sending message</span>
<span class="co"># directly through the websocket</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="va">tags</span><span class="op">$</span><span class="fu">button</span><span class="op">(</span>
    <span class="st">"Update obs value"</span>,
    onclick <span class="op">=</span> <span class="fu">updateObsVal</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>
  <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html">sliderInput</a></span><span class="op">(</span><span class="st">"obs"</span>, <span class="st">"Number of observations:"</span>,
              min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1000</span>, value <span class="op">=</span> <span class="fl">500</span>
  <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"distPlot"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">output</span><span class="op">$</span><span class="va">distPlot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
</div>
<div id="summary" class="section level5">
<h5>
<span class="header-section-number">10.3.3.5.5</span> Summary<a class="anchor" aria-label="anchor" href="#summary"><i class="fas fa-link"></i></a>
</h5>
<p>Below is a summary of the server and client websocket parts. The Shiny app shown in Figure <a href="shiny-intro.html#fig:websocket-intro">10.7</a> consists in an <code>actionButton</code> and a <code>sliderInput</code>. Clicking on the action button triggers an <code>observeEvent</code> that fires <code>updateSlideInput</code>. Under the hood, clicking on the action button sends a message from the client to the server. This message is processed and the corresponding input value is updated on the server, thereby invalidating any observer, reactive element. <code>updateSlideInput</code> sends a message back to the client containing the id of the input to update. This message is received and processed by the <code>onMessage</code> event manager, which redirects the message to the related message handler, thereby updating the corresponding input element on the client. The underlying mechanisms are going to be detailed in the next part <a href="shiny-input-system.html#shiny-input-system">11</a>. You may imagine that when the slider is updated, it also sends a message to the server, triggering a cascade of reactions.</p>
<p>It let you imagine how many messages are exchanged for more complex apps!</p>
<div class="figure">
<span id="fig:websocket-intro"></span>
<img src="images/survival-kit/websocket-intro.png" alt="Websocket allows communication between server and client." width="100%"><p class="caption">
FIGURE 10.7: Websocket allows communication between server and client.
</p>
</div>

</div>
</div>
</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="survival-kit-javascript.html"><span class="header-section-number">9</span> JavaScript for Shiny</a></div>
<div class="next"><a href="shiny-input-system.html"><span class="header-section-number">11</span> Shiny’s input system</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#shiny-intro"><span class="header-section-number">10</span> Shiny’s internals</a></li>
<li><a class="nav-link" href="#the-client-server-model"><span class="header-section-number">10.1</span> The client-server model</a></li>
<li><a class="nav-link" href="#about-http-requests"><span class="header-section-number">10.2</span> About HTTP requests</a></li>
<li>
<a class="nav-link" href="#shiny-app-lifecycle"><span class="header-section-number">10.3</span> Shiny app lifecycle</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#building-the-ui"><span class="header-section-number">10.3.1</span> Building the UI</a></li>
<li><a class="nav-link" href="#serving-html-with-httpuv"><span class="header-section-number">10.3.2</span> Serving HTML with {httpuv}</a></li>
<li><a class="nav-link" href="#handle-rjs-communication"><span class="header-section-number">10.3.3</span> Handle R/JS communication</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/blob/master/shiny-intro.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/edit/master/shiny-intro.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Outstanding User Interfaces with Shiny</strong>" was written by David Granjon. It was last built on 2021-03-01.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
