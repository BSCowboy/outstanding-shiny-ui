<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 14 Dynamically manage content with handlers | Outstanding User Interfaces with Shiny</title>
<meta name="author" content="David Granjon">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4/tabs.js"></script><script src="libs/bs3compat-0.2.4/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/core-js-2.5.3/shim.min.js"></script><script src="libs/react-16.12.0/react.min.js"></script><script src="libs/react-16.12.0/react-dom.min.js"></script><script src="libs/reactwidget-1.0.0/react-tools.js"></script><link href="libs/font-awesome-5.13.0/css/all.min.css" rel="stylesheet">
<link href="libs/font-awesome-5.13.0/css/v4-shims.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Outstanding User Interfaces with Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="foreword.html">Foreword</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="web-intro.html"><span class="header-section-number">1</span> Shiny and the Web</a></li>
<li><a class="" href="web-dependencies.html"><span class="header-section-number">2</span> Discover Shiny dependencies</a></li>
<li class="book-part">From R to HTML: discover and master {htmltools}:</li>
<li><a class="" href="htmltools-overview.html"><span class="header-section-number">3</span> htmltools overview</a></li>
<li><a class="" href="htmltools-dependencies.html"><span class="header-section-number">4</span> Dependency utilities</a></li>
<li class="book-part">Beautify with CSS and Sass</li>
<li><a class="" href="beautify-css.html"><span class="header-section-number">5</span> CSS for Shiny</a></li>
<li><a class="" href="beautify-sass.html"><span class="header-section-number">6</span> Introduction to SASS</a></li>
<li><a class="" href="beautify-with-fresh.html"><span class="header-section-number">7</span> Beautify with fresh</a></li>
<li><a class="" href="beautify-with-bootstraplib.html"><span class="header-section-number">8</span> Beautify with {bslib}</a></li>
<li class="book-part">Unleash interactivity with JavaScript</li>
<li><a class="" href="survival-kit-javascript.html"><span class="header-section-number">9</span> JavaScript for Shiny</a></li>
<li><a class="" href="shiny-intro.html"><span class="header-section-number">10</span> Shiny’s internal: session and websockets</a></li>
<li><a class="" href="shiny-input-system.html"><span class="header-section-number">11</span> Shiny’s input system</a></li>
<li><a class="" href="shiny-input-lifecycle.html"><span class="header-section-number">12</span> Shiny inputs lifecycles</a></li>
<li><a class="" href="shiny-input-gems.html"><span class="header-section-number">13</span> Hidden gems about inputs</a></li>
<li><a class="active" href="shiny-custom-handler.html"><span class="header-section-number">14</span> Dynamically manage content with handlers</a></li>
<li class="book-part">Practice 1: a dashboard template</li>
<li><a class="" href="custom-templates-selection.html"><span class="header-section-number">15</span> Template selection</a></li>
<li><a class="" href="custom-templates-dependencies.html"><span class="header-section-number">16</span> Define dependencies</a></li>
<li><a class="" href="custom-templates-skeleton.html"><span class="header-section-number">17</span> Template skeleton</a></li>
<li><a class="" href="custom-templates-testing.html"><span class="header-section-number">18</span> Testing and validating templates elements</a></li>
<li><a class="" href="custom-templates-inputs.html"><span class="header-section-number">19</span> Develop custom input widgets</a></li>
<li><a class="" href="custom-templates-interactivity.html"><span class="header-section-number">20</span> Adding more interactivity</a></li>
<li class="book-part">Toward a better workflow</li>
<li><a class="" href="workflow-charpente.html"><span class="header-section-number">21</span> Introduction to {charpente}</a></li>
<li class="book-part">Case study 2: Mobile development with Shiny</li>
<li><a class="" href="mobile-shiny-intro.html"><span class="header-section-number">22</span> Introduction</a></li>
<li><a class="" href="mobile-shinyMobile.html"><span class="header-section-number">23</span> Reconstruct {shinyMobile}</a></li>
<li><a class="" href="mobile-pwa.html"><span class="header-section-number">24</span> {shinyMobile} and PWA</a></li>
<li><a class="" href="mobile-widgets.html"><span class="header-section-number">25</span> Design widgets</a></li>
<li><a class="" href="mobile-going-further.html"><span class="header-section-number">26</span> Going further</a></li>
<li class="book-part">Going further</li>
<li><a class="" href="going-further-reactR.html"><span class="header-section-number">27</span> R + Shiny + React: welcome {reactR}</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DivadNojnarg/outstanding-shiny-ui">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="shiny-custom-handler" class="section level1">
<h1>
<span class="header-section-number">14</span> Dynamically manage content with handlers<a class="anchor" aria-label="anchor" href="#shiny-custom-handler"><i class="fas fa-link"></i></a>
</h1>
<p>The three previous chapters are largely dedicated to Shiny input elements. Yet, not everything is input in Shiny. This chapter shows how one may leverage the internal Shiny JavaScript tools to build highly interactive and optimized interfaces.</p>
<div id="introduction-3" class="section level2">
<h2>
<span class="header-section-number">14.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-3"><i class="fas fa-link"></i></a>
</h2>
<p>As shown in the Mastering Shiny <a href="https://mastering-shiny.org/action-dynamic.html">book</a>, there exists tools to update UI components from the server. You can use all <code>update&lt;INPUT_NAME&gt;</code> functions like <code>updateTextInput</code> but also what I call secondary input related function like <code>updateTabsetPanel</code>. Why secondary input? Since they are not inputs, strictly speaking. For instance when you fill an inscription form on a website, it contains a lot of inputs like select, text, numeric, date, so that your data is ultimately stored in a database for later use. A <code>tabsetPanel</code> is a simple way to spread multiple elements on different panels and usually gather them by topic. In Shiny, it is always interesting to associate an input to it, as shown in the previous chapter <a href="shiny-input-system.html#secondary-inputs">11.2</a>, so as to be able to trigger sophisticated actions on the server side, whenever necessary. In order not to confuse the reader, primary inputs like <code>actionButton</code> have an id, accessible through <code>inputId</code>, while secondary inputs simply have <code>id</code>.</p>
<p>Other tools to manage your UI consist in <code>toggle</code> functions like <code>hideTab</code>, <code>showTab</code>, the limit being the very few number of them, which often obliges us to use packages like <code>shinyjs</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-shinyjs"><strong>???</strong></span>)</span> or write custom JavaScript code. <code>insertUI/removeUI</code> allows to dynamically insert or remove any element, anywhere.</p>
</div>
<div id="the-renderui-case" class="section level2">
<h2>
<span class="header-section-number">14.2</span> The renderUI case<a class="anchor" aria-label="anchor" href="#the-renderui-case"><i class="fas fa-link"></i></a>
</h2>
<p>One may know the <code>renderUI/uiOutput</code> that allows to render any HTML block from the server. While the <code>update&lt;INPUT_NAME&gt;</code> and <code>toggle</code> tools are component specific, meaning they only target the element to modify, <code>renderUI/uiOutput</code> re-renders the whole block each time an associated reactive dependency is invalidated, even though only a little part should be re-rendered. This approach is usually to avoid since it implies poor performances. Let’s see below, where I simulate a computationally intensive task for three seconds, corresponding to the time to obtain the slider value:</p>
<div class="sourceCode" id="cb307"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html">uiOutput</a></span><span class="op">(</span><span class="st">"moreControls"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">sliderValue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span>
    <span class="co"># computationally intensive task</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
    <span class="fl">1</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="va">output</span><span class="op">$</span><span class="va">moreControls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html">renderUI</a></span><span class="op">(</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html">sliderInput</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"N"</span>, <span class="fu">sliderValue</span><span class="op">(</span><span class="op">)</span>, <span class="fl">1000</span>, <span class="fl">500</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<p>The same example with the <code>updateSliderInput</code> functions:</p>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html">sliderInput</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"N"</span>, <span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">500</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">sliderValue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span>
    <span class="co"># computationally intensive task</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
    <span class="fl">50</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="fu">sliderValue</span><span class="op">(</span><span class="op">)</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/updateSliderInput.html">updateSliderInput</a></span><span class="op">(</span>
      <span class="va">session</span>,
      <span class="st">"n"</span>,
      value <span class="op">=</span> <span class="fu">sliderValue</span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<p>The first approach’s biggest problem is the absence of anything for 3 seconds, which may discourage the end user. Although not ideal, the second approach is already much better.</p>
<p>Below is an very naive and dirty example where <code>renderUI</code> makes the entire dropdown menu re-render each time something changes in the <code>renderUI</code> expression, which may not be optimal. For instance in React, we only re-render what needs to be <a href="https://en.reactjs.org/docs/rendering-elements.html#react-only-updates-whats-necessary">updated</a>! Run the app below, open the HTML inspector and click to add 1 message. Notice that the entire block is updated, whereas only the corresponding HTML element should (Figure <a href="shiny-custom-handler.html#fig:render-ui-1">14.1</a>). No doubt that any advanced user see a place for <code>insertUI</code>.</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rinterface.github.io/bs4Dash/index.html">bs4Dash</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>

<span class="va">new_message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  message <span class="op">=</span> <span class="st">"New message"</span>,
  from <span class="op">=</span> <span class="st">"Paul"</span>,
  src <span class="op">=</span> <span class="st">"https://adminlte.io/themes/v3/dist/img/user3-128x128.jpg"</span>,
  time <span class="op">=</span> <span class="st">"yesterday"</span>,
  status <span class="op">=</span> <span class="st">"success"</span>,
  type <span class="op">=</span> <span class="st">"message"</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>
  ui <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardPage.html">bs4DashPage</a></span><span class="op">(</span>
    navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardHeader.html">bs4DashNavbar</a></span><span class="op">(</span>
      rightUi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html">uiOutput</a></span><span class="op">(</span><span class="st">"messages"</span>, container <span class="op">=</span> <span class="va">tags</span><span class="op">$</span><span class="va">li</span><span class="op">)</span>
    <span class="op">)</span>,
    sidebar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardSidebar.html">bs4DashSidebar</a></span><span class="op">(</span><span class="op">)</span>,
    controlbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardControlbar.html">bs4DashControlbar</a></span><span class="op">(</span><span class="op">)</span>,
    footer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardFooter.html">bs4DashFooter</a></span><span class="op">(</span><span class="op">)</span>,
    title <span class="op">=</span> <span class="st">"test"</span>,
    body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardBody.html">bs4DashBody</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"add"</span>, <span class="st">"Add message"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>,
  server <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="va">messages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactiveValues.html">reactiveValues</a></span><span class="op">(</span>
      items <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
        message <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"A message"</span>, <span class="fl">10</span><span class="op">)</span>,
        from <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,
        src <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"https://adminlte.io/themes/v3/dist/img/user3-128x128.jpg"</span>, <span class="fl">10</span><span class="op">)</span>,
        time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"yesterday"</span>, <span class="fl">10</span><span class="op">)</span>,
        status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"success"</span>, <span class="fl">10</span><span class="op">)</span>,
        type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"message"</span>, <span class="fl">10</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="va">messages</span><span class="op">$</span><span class="va">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span><span class="op">(</span><span class="va">messages</span><span class="op">$</span><span class="va">items</span>, <span class="va">new_message</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="va">output</span><span class="op">$</span><span class="va">messages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html">renderUI</a></span><span class="op">(</span><span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dropdownMenu.html">dropdownMenu</a></span><span class="op">(</span>
        show <span class="op">=</span> <span class="cn">FALSE</span>,
        status <span class="op">=</span> <span class="st">"danger"</span>,
        src <span class="op">=</span> <span class="st">"https://www.google.fr"</span>,
        <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">messages</span><span class="op">$</span><span class="va">items</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">{</span>
          <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">messages</span><span class="op">$</span><span class="va">items</span><span class="op">[</span><span class="va">r</span>, <span class="op">]</span>
          <span class="fu">dropdownMenuItem</span><span class="op">(</span>
            message <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">message</span>,
            from <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">from</span>, 
            time <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">time</span>,
            status <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">status</span>,
            type <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">type</span>,
            src <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">src</span>
          <span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<span id="fig:render-ui-1"></span>
<img src="images/survival-kit/render-ui-1.png" alt="renderUI is not specific" width="100%"><p class="caption">
FIGURE 14.1: renderUI is not specific
</p>
</div>
<p>This non specificity property justifies why you should avoid this method as much as possible, as it overloads the server. Later in this chapter, we leverage custom handlers to solve this problem. Overall, it’s more work, maybe more complex but ensures to be specific and more optimized.</p>
</div>
<div id="insert-ui" class="section level2">
<h2>
<span class="header-section-number">14.3</span> Other Shiny handlers<a class="anchor" aria-label="anchor" href="#insert-ui"><i class="fas fa-link"></i></a>
</h2>
<p>As mentioned in Chapter <a href="shiny-input-lifecycle.html#update-input-lifecycle">12.2</a>, all <code>update&lt;INPUT_NAME&gt;</code> functions are Shiny defined messages handlers.</p>
<div id="the-insertui-case" class="section level3">
<h3>
<span class="header-section-number">14.3.1</span> The insertUI case<a class="anchor" aria-label="anchor" href="#the-insertui-case"><i class="fas fa-link"></i></a>
</h3>
<p>Under the hood, <code>insertUI</code> sends a R <a href="https://github.com/rstudio/shiny/blob/master/R/shiny.R#L1696">message</a> through <code>session$sendInsertUI</code>, via the websocket:</p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">session</span><span class="op">$</span><span class="fu">sendInsertUI</span><span class="op">(</span>
  selector <span class="op">=</span> <span class="va">selector</span>, 
  multiple <span class="op">=</span> <span class="va">multiple</span>, 
  where <span class="op">=</span> <span class="va">where</span>, 
  content <span class="op">=</span> <span class="fu">processDeps</span><span class="op">(</span><span class="va">ui</span>, <span class="va">session</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">sendInsertUI</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">selector</span>, <span class="va">multiple</span>, <span class="va">where</span>, <span class="va">content</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">private</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span>
    `shiny-insert-ui` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      selector <span class="op">=</span> <span class="va">selector</span>,
      multiple <span class="op">=</span> <span class="va">multiple</span>,
      where <span class="op">=</span> <span class="va">where</span>,
      content <span class="op">=</span> <span class="va">content</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The content has been treated with <code>shiny:::processDeps</code> that:</p>
<ul>
<li>Finds and resolve any HTML dependency, as shown in Chapter <a href="htmltools-dependencies.html#htmltools-dependencies">4</a>.</li>
<li>For each dependency, makes sure the corresponding files can be accessed on the server with <code>createWebDependency</code> and <code>addResourcePath</code>.</li>
<li>Returns a list of the HTML element and dependencies. The HTML will be accessed by <code>message.content.html</code> and dependencies by <code>message.content.deps</code>.</li>
</ul>
<p>On the UI side, Shiny has a predefined message <a href="https://github.com/rstudio/shiny/blob/master/srcjs/shinyapp.js#L670">handler</a>:</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb311-1"><a href="shiny-custom-handler.html#cb311-1"></a><span class="at">addMessageHandler</span>(<span class="st">'shiny-insert-ui'</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb311-2"><a href="shiny-custom-handler.html#cb311-2"></a>  <span class="kw">var</span> targets <span class="op">=</span> <span class="at">$</span>(<span class="va">message</span>.<span class="at">selector</span>)<span class="op">;</span></span>
<span id="cb311-3"><a href="shiny-custom-handler.html#cb311-3"></a>  <span class="cf">if</span> (<span class="va">targets</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></span>
<span id="cb311-4"><a href="shiny-custom-handler.html#cb311-4"></a>    <span class="co">// render the HTML and deps to a null target, so</span></span>
<span id="cb311-5"><a href="shiny-custom-handler.html#cb311-5"></a>    <span class="co">// the side-effect of rendering the deps, singletons,</span></span>
<span id="cb311-6"><a href="shiny-custom-handler.html#cb311-6"></a>    <span class="co">// and &lt;head&gt; still occur</span></span>
<span id="cb311-7"><a href="shiny-custom-handler.html#cb311-7"></a>    <span class="va">console</span>.<span class="at">warn</span>(<span class="st">'The selector you chose ("'</span> <span class="op">+</span> <span class="va">message</span>.<span class="at">selector</span> <span class="op">+</span></span>
<span id="cb311-8"><a href="shiny-custom-handler.html#cb311-8"></a>                 <span class="st">'") could not be found in the DOM.'</span>)<span class="op">;</span></span>
<span id="cb311-9"><a href="shiny-custom-handler.html#cb311-9"></a>    <span class="va">exports</span>.<span class="at">renderHtml</span>(<span class="va">message</span>.<span class="va">content</span>.<span class="at">html</span><span class="op">,</span> <span class="at">$</span>([])<span class="op">,</span> <span class="va">message</span>.<span class="va">content</span>.<span class="at">deps</span>)<span class="op">;</span></span>
<span id="cb311-10"><a href="shiny-custom-handler.html#cb311-10"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb311-11"><a href="shiny-custom-handler.html#cb311-11"></a>    <span class="va">targets</span>.<span class="at">each</span>(<span class="kw">function</span> (i<span class="op">,</span> target) <span class="op">{</span></span>
<span id="cb311-12"><a href="shiny-custom-handler.html#cb311-12"></a>      <span class="va">exports</span>.<span class="at">renderContent</span>(target<span class="op">,</span> <span class="va">message</span>.<span class="at">content</span><span class="op">,</span> <span class="va">message</span>.<span class="at">where</span>)<span class="op">;</span></span>
<span id="cb311-13"><a href="shiny-custom-handler.html#cb311-13"></a>      <span class="cf">return</span> <span class="va">message</span>.<span class="at">multiple</span><span class="op">;</span></span>
<span id="cb311-14"><a href="shiny-custom-handler.html#cb311-14"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb311-15"><a href="shiny-custom-handler.html#cb311-15"></a>  <span class="op">}</span></span>
<span id="cb311-16"><a href="shiny-custom-handler.html#cb311-16"></a><span class="op">}</span>)</span></code></pre></div>
<p>It checks whether the provided selector corresponds to multiple DOM elements. If at least 1 item is found, it calls <code>renderContent(html, el, dependencies)</code> that triggers <code>renderHtml(html, el, dependencies)</code>:</p>
<ul>
<li>Processes the provided HTML (treat the head, body and singletons).</li>
<li>Renders all given dependencies into the page’s <a href="https://github.com/rstudio/shiny/blob/master/srcjs/output_binding_html.js#L241">head</a>.</li>
<li>Insert the HTML into the page at the position provided in the <code>insertUI</code> <strong>where</strong> parameter. Internally this calls the <code>insertAdjacentHTML</code> method.</li>
<li>Initialize any input and bind them to the scope and send the value to the server so that output/observers are invalidated. Outputs are also bound. If this step is missed the newly inserted input won’t react, so is the related output and any observer.</li>
</ul>
<p>Keep <code>renderContent</code> and <code>renderHtml</code> in mind, we’ll use them in section <a href="shiny-custom-handler.html#custom-ui-functions">14.4.2</a>.</p>
</div>
<div id="example-2" class="section level3">
<h3>
<span class="header-section-number">14.3.2</span> Example<a class="anchor" aria-label="anchor" href="#example-2"><i class="fas fa-link"></i></a>
</h3>
<p>Going back to the previous example, why don’t we just go for <code>insertUI</code>:</p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>
  ui <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardPage.html">bs4DashPage</a></span><span class="op">(</span>
    navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardHeader.html">bs4DashNavbar</a></span><span class="op">(</span>
      rightUi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dropdownMenu.html">dropdownMenu</a></span><span class="op">(</span>
        show <span class="op">=</span> <span class="cn">FALSE</span>,
        status <span class="op">=</span> <span class="st">"danger"</span>,
        src <span class="op">=</span> <span class="st">"https://www.google.fr"</span>
      <span class="op">)</span>
    <span class="op">)</span>,
    sidebar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardSidebar.html">bs4DashSidebar</a></span><span class="op">(</span><span class="op">)</span>,
    controlbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardControlbar.html">bs4DashControlbar</a></span><span class="op">(</span><span class="op">)</span>,
    footer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardFooter.html">bs4DashFooter</a></span><span class="op">(</span><span class="op">)</span>,
    title <span class="op">=</span> <span class="st">"test"</span>,
    body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardBody.html">bs4DashBody</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"add"</span>, <span class="st">"Add dropdown item"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>,
  server <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">insertUI</a></span><span class="op">(</span>
        selector <span class="op">=</span> <span class="st">".dropdown-menu &gt; .dropdown-item.dropdown-footer"</span>,
        where <span class="op">=</span> <span class="st">"beforeBegin"</span>,
        ui <span class="op">=</span> <span class="fu">dropdownMenuItem</span><span class="op">(</span>
          inputId <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"triggerAction_"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span>,
          message <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"message"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span>,
          from <span class="op">=</span> <span class="st">"Divad Nojnarg"</span>,
          src <span class="op">=</span> <span class="st">"https://adminlte.io/themes/v3/dist/img/user3-128x128.jpg"</span>,
          time <span class="op">=</span> <span class="st">"today"</span>,
          status <span class="op">=</span> <span class="st">"danger"</span>,
          type <span class="op">=</span> <span class="st">"message"</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>Well, if the item is inserted, the item counter as well as the dropdown text are not, as depicted Figure <a href="shiny-custom-handler.html#fig:insertUI-1">14.2</a>! We can’t blame <code>insertUI</code> for this, since this is the fault of the <a href="https://rinterface.github.io/bs4Dash/index.html">bs4Dash</a> component that actually has interconnected HTML pieces. Indeed, the <code>dropdownMenu</code> function generates HTML, detecting the number of <code>dropdownMenuItem</code>. This works well when the app fires but the component is not able to maintain an up to date state.</p>
<div class="figure">
<span id="fig:insertUI-1"></span>
<img src="images/survival-kit/insertUI-1.png" alt="insertUI is not enough specific" width="100%"><p class="caption">
FIGURE 14.2: insertUI is not enough specific
</p>
</div>
<p>We may fix that by adding extra <code><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">insertUI()</a></code> and <code><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">removeUI()</a></code> to replace those parts (<code><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">insertUI()</a></code> does not update the targeted item). Moreover, you we must set correct priority for each <code>observeEvent</code> (try to remove them, it will fail) to ensure that <em>remove</em> happens before <em>insert</em>.</p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>
  ui <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardPage.html">bs4DashPage</a></span><span class="op">(</span>
    navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardHeader.html">bs4DashNavbar</a></span><span class="op">(</span>
      rightUi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dropdownMenu.html">dropdownMenu</a></span><span class="op">(</span>
        show <span class="op">=</span> <span class="cn">FALSE</span>,
        status <span class="op">=</span> <span class="st">"danger"</span>,
        src <span class="op">=</span> <span class="st">"https://www.google.fr"</span>
      <span class="op">)</span>
    <span class="op">)</span>,
    sidebar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardSidebar.html">bs4DashSidebar</a></span><span class="op">(</span><span class="op">)</span>,
    controlbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardControlbar.html">bs4DashControlbar</a></span><span class="op">(</span><span class="op">)</span>,
    footer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardFooter.html">bs4DashFooter</a></span><span class="op">(</span><span class="op">)</span>,
    title <span class="op">=</span> <span class="st">"test"</span>,
    body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardBody.html">bs4DashBody</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"add"</span>, <span class="st">"Add dropdown item"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>,
  server <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">insertUI</a></span><span class="op">(</span>
        selector <span class="op">=</span> <span class="st">".dropdown-menu &gt; .dropdown-item.dropdown-footer"</span>,
        where <span class="op">=</span> <span class="st">"beforeBegin"</span>,
        ui <span class="op">=</span> <span class="fu">dropdownMenuItem</span><span class="op">(</span>
          inputId <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"triggerAction_"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span>,
          message <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"message"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span>,
          from <span class="op">=</span> <span class="st">"Divad Nojnarg"</span>,
          src <span class="op">=</span> <span class="st">"https://adminlte.io/themes/v3/dist/img/user3-128x128.jpg"</span>,
          time <span class="op">=</span> <span class="st">"today"</span>,
          status <span class="op">=</span> <span class="st">"danger"</span>,
          type <span class="op">=</span> <span class="st">"message"</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="co"># remove old badge</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">removeUI</a></span><span class="op">(</span>selector <span class="op">=</span> <span class="st">".badge-danger.navbar-badge"</span><span class="op">)</span>
    <span class="op">}</span>, priority <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    
    <span class="co"># insert new badge</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">insertUI</a></span><span class="op">(</span>
        selector <span class="op">=</span> <span class="st">"[data-toggle=\"dropdown\"]"</span>,
        where <span class="op">=</span> <span class="st">"beforeEnd"</span>,
        ui <span class="op">=</span> <span class="va">tags</span><span class="op">$</span><span class="fu">span</span><span class="op">(</span>class <span class="op">=</span> <span class="st">"badge badge-danger navbar-badge"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    
    <span class="co"># remove old text counter</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">removeUI</a></span><span class="op">(</span>selector <span class="op">=</span> <span class="st">".dropdown-item.dropdown-header"</span><span class="op">)</span>
    <span class="op">}</span>, priority <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    
    <span class="co"># insert new text counter</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/insertUI.html">insertUI</a></span><span class="op">(</span>
        selector <span class="op">=</span> <span class="st">".dropdown-menu"</span>,
        where <span class="op">=</span> <span class="st">"afterBegin"</span>,
        ui <span class="op">=</span> <span class="va">tags</span><span class="op">$</span><span class="fu">span</span><span class="op">(</span>class<span class="op">=</span><span class="st">"dropdown-item dropdown-header"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%s Items"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
  <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>So many <code>observeEvent</code> for a simple action! Imagine if we had 10 similar tasks… Isn’t there a way to do all of this at once, thereby reducing the server code? In general setting priorities in <code>observeEvent</code> is a rather bad smell of poorly designed shiny app.</p>
<p>It seems that we have to create our own message handler!</p>
</div>
</div>
<div id="custom-handlers" class="section level2">
<h2>
<span class="header-section-number">14.4</span> Custom handlers<a class="anchor" aria-label="anchor" href="#custom-handlers"><i class="fas fa-link"></i></a>
</h2>
<p>Custom handlers are a specific category of message handlers, as they are user defined.</p>
<div id="theory" class="section level3">
<h3>
<span class="header-section-number">14.4.1</span> Theory<a class="anchor" aria-label="anchor" href="#theory"><i class="fas fa-link"></i></a>
</h3>
<p>Shiny provides tools to ease the communication between R and JavaScript, as illustrated in section <a href="shiny-intro.html#shiny-websocket">10.2</a>. We already discussed the usage of <code>sendInputMessage()</code> in the input binding section <a href="shiny-input-system.html#shiny-input-system">11</a>. The other important method is <code>sendCustomMessage(type, message)</code>. It works by pair with the JS method <code>Shiny.AddCustomMessageHandler</code>, linked with the type parameter.</p>
<div class="sourceCode" id="cb314"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">say_hello_to_js</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">session</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span>type <span class="op">=</span> <span class="st">'say-hello'</span>, message <span class="op">=</span> <span class="va">text</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The JavaScript part is defined below:</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb315-1"><a href="shiny-custom-handler.html#cb315-1"></a><span class="at">$</span>(<span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb315-2"><a href="shiny-custom-handler.html#cb315-2"></a>  <span class="va">Shiny</span>.<span class="at">AddCustomMessageHandler</span>(<span class="st">'say-hello'</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb315-3"><a href="shiny-custom-handler.html#cb315-3"></a>    <span class="at">alert</span>(<span class="vs">`R says </span><span class="sc">${</span>message<span class="sc">}</span><span class="vs"> to you!`</span>)</span>
<span id="cb315-4"><a href="shiny-custom-handler.html#cb315-4"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb315-5"><a href="shiny-custom-handler.html#cb315-5"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>The shiny app below will simply print a welcome message every 5 seconds. We obviously set <code><a href="https://rdrr.io/r/base/options.html">options(shiny.trace = TRUE)</a></code> so as to capture all messages sent between R and JS. Figure <a href="shiny-custom-handler.html#fig:shiny-custom-message">14.3</a> summarizes the main mechanisms involved in the R to JS communication. The corresponding code may be found <a href="https://github.com/DivadNojnarg/outstanding-shiny-ui-code/blob/master/R/say_hello.R">here</a>.</p>
<div class="sourceCode" id="cb316"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyAppDir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"chapter6/say_hello"</span>, package <span class="op">=</span> <span class="st">"OSUICode"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span id="fig:shiny-custom-message"></span>
<img src="images/survival-kit/shiny-custom-message.png" alt="From R to JavaScript" width="100%"><p class="caption">
FIGURE 14.3: From R to JavaScript
</p>
</div>
<p>Combining <code>Shiny.setInputValue</code> and <code>Shiny.addCustomMessageHandler</code>, here is a fun example
that sets the body background as a result of a simple button click.
We defined 3 JS pieces:</p>
<ul>
<li>
<code>getPokemon</code> whose script is adapted from Colin Fay et al. (see <a href="https://engineering-shiny.org/optimjs.html">here</a>). This function fetch the <a href="https://pokeapi.co/">pokeapi</a>
data and if successful set an input value, which will be available on the R side</li>
<li>An event listener is set to the only button of the page so that each time we click,
we call <code>getPokemon</code> to select a random background image</li>
<li>
<code>input$pokeData</code> is actually a quite complex list (deeply nested JSON) and some manipulation is done from R in the <code>observeEvent</code> block. Once done, we send the data
back to JS through the websocket (the session object sends a message).</li>
<li>On the JS side, the last block is a custom message handler that will add some inline
CSS properties to the body element</li>
</ul>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="va">tags</span><span class="op">$</span><span class="fu">script</span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span>
      <span class="st">[1165 chars quoted with '"']</span>
    <span class="op">)</span>
  <span class="op">)</span>,
  <span class="va">tags</span><span class="op">$</span><span class="fu">button</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"button"</span>, <span class="st">"Go!"</span>, class <span class="op">=</span> <span class="st">"btn-success"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">pokeData</span>, <span class="op">{</span>
    <span class="va">background</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">pokeData</span><span class="op">$</span><span class="va">sprites</span><span class="op">$</span><span class="va">other</span><span class="op">$</span><span class="va">`official-artwork`</span><span class="op">$</span><span class="va">front_default</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="va">background</span><span class="op">)</span>
    <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"update_background"</span>, message <span class="op">=</span> <span class="va">background</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<p>A whole chapter is dedicated to custom handlers, with a practical example <a href="custom-templates-interactivity.html#custom-templates-interactivity">20</a>.</p>
</div>
<div id="custom-ui-functions" class="section level3">
<h3>
<span class="header-section-number">14.4.2</span> Toward custom UI management functions<a class="anchor" aria-label="anchor" href="#custom-ui-functions"><i class="fas fa-link"></i></a>
</h3>
<div id="an-insertdropdownitem-function" class="section level4">
<h4>
<span class="header-section-number">14.4.2.1</span> An insertDropdownItem function<a class="anchor" aria-label="anchor" href="#an-insertdropdownitem-function"><i class="fas fa-link"></i></a>
</h4>
<p>In this example, we go back to the <a href="https://rinterface.github.io/bs4Dash/index.html">bs4Dash</a> <code>dropdownMenu</code> issue, discussed earlier
in the chapter. We propose a method involving only custom message handlers.</p>
<div class="sourceCode" id="cb318"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">insertDropdownItem</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">item</span>, <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span><span class="st">"add-dropdown-item"</span>, message <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">item</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We create the <code>insertDropdownItem</code> function with 2 parameters:</p>
<ul>
<li>item, the HTML element we want to insert in the DOM.</li>
<li>session, used to send a message to JavaScript with <code>session$sendCustomMessage</code>.</li>
</ul>
<p>We don’t use <code>processDeps</code> as it is very unlikely that our <code>dropdownMenuItem</code> contains any extra dependency. item is converted to a character (important) and sent to JavaScript through the shiny session R6 object. We give it a type, that is ‘add-dropdown-item’, to be able to identify it from JavaScript with <code>Shiny.addCustomMessageHandler</code>.</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb319-1"><a href="shiny-custom-handler.html#cb319-1"></a><span class="at">$</span>(<span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb319-2"><a href="shiny-custom-handler.html#cb319-2"></a>  <span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(<span class="st">'add-dropdown-item'</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb319-3"><a href="shiny-custom-handler.html#cb319-3"></a>    <span class="co">// convert string to HTML</span></span>
<span id="cb319-4"><a href="shiny-custom-handler.html#cb319-4"></a>    <span class="kw">var</span> itemTag <span class="op">=</span> <span class="va">$</span>.<span class="at">parseHTML</span>(message)[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb319-5"><a href="shiny-custom-handler.html#cb319-5"></a>    <span class="at">$</span>(itemTag).<span class="at">insertBefore</span>(<span class="at">$</span>(<span class="st">'.dropdown-item.dropdown-footer'</span>))<span class="op">;</span></span>
<span id="cb319-6"><a href="shiny-custom-handler.html#cb319-6"></a>    <span class="co">// since we do not re-render the dropdown, we must update its item counter</span></span>
<span id="cb319-7"><a href="shiny-custom-handler.html#cb319-7"></a>    <span class="kw">var</span> $items <span class="op">=</span> <span class="at">$</span>(<span class="st">'button.dropdown-item'</span>).<span class="at">length</span><span class="op">;</span></span>
<span id="cb319-8"><a href="shiny-custom-handler.html#cb319-8"></a>    <span class="at">$</span>(<span class="st">'.dropdown-item.dropdown-header'</span>).<span class="at">html</span>($items <span class="op">+</span> <span class="st">' Items'</span>)<span class="op">;</span></span>
<span id="cb319-9"><a href="shiny-custom-handler.html#cb319-9"></a>    <span class="at">$</span>(<span class="st">'.nav-item.dropdown'</span>).<span class="at">find</span>(<span class="st">'.navbar-badge'</span>).<span class="at">html</span>($items)<span class="op">;</span></span>
<span id="cb319-10"><a href="shiny-custom-handler.html#cb319-10"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb319-11"><a href="shiny-custom-handler.html#cb319-11"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>We recover the sent message on the JS side with <code>Shiny.addCustomMessageHandler</code>, then parse the string to HTML with <code>$.parseHTML</code> and insert it before the footer (that is the next UI element of the dropdown body). We also update dropdown menu item counter as well as the icon text since the dropdown menu is not re-rendered. These two extra JS steps save us to create extra <code>observeEvent</code> on the server, as shown before. The <code>dropdownMenu</code> is modified so that dependencies are attached:</p>
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dropdownDeps</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">htmltools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/htmlDependency.html">htmlDependency</a></span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"bs4-dropdown"</span>,
    version <span class="op">=</span> <span class="st">"1.0.0"</span>,
    src <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"chapter6/add-dropdown-item"</span><span class="op">)</span>,
    script <span class="op">=</span> <span class="st">"add-dropdown-item.js"</span>,
    package <span class="op">=</span> <span class="st">"OSUICode"</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">dropdownMenu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">show</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">labelText</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">src</span> <span class="op">=</span> <span class="cn">NULL</span>,
                         <span class="va">status</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"primary"</span>, <span class="st">"warning"</span>, <span class="st">"danger"</span>, <span class="st">"info"</span>, <span class="st">"success"</span><span class="op">)</span>,
                         <span class="va">menuIcon</span> <span class="op">=</span> <span class="st">"bell"</span>, <span class="va">align</span> <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">{</span>

  <span class="va">status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span>
  <span class="va">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  <span class="va">n_items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span>
  <span class="co"># remove the divider from the last item</span>
  <span class="co">#items[[n_items]][[2]] &lt;- NULL</span>

  <span class="va">labelText</span> <span class="op">&lt;-</span> <span class="va">n_items</span>

  <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tag.html">tagList</a></span><span class="op">(</span>
    <span class="fu">dropdownDeps</span><span class="op">(</span><span class="op">)</span>,
    <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">li</span><span class="op">(</span>
      class <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="va">show</span><span class="op">)</span><span class="op">)</span> <span class="st">"nav-item dropdown show"</span> <span class="kw">else</span> <span class="st">"nav-item dropdown"</span>,
      <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">a</span><span class="op">(</span>
        class <span class="op">=</span> <span class="st">"nav-link"</span>,
        `data-toggle` <span class="op">=</span> <span class="st">"dropdown"</span>,
        href <span class="op">=</span> <span class="st">"#"</span>,
        <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="va">menuIcon</span><span class="op">)</span>,
        <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">span</span><span class="op">(</span>
          class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"badge badge-"</span>, <span class="va">status</span>, <span class="st">" navbar-badge"</span><span class="op">)</span>,
          <span class="va">labelText</span>
        <span class="op">)</span>
      <span class="op">)</span>,
      <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
        class <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="va">show</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"dropdown-menu dropdown-menu-lg dropdown-menu-%s show"</span>, <span class="va">align</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"dropdown-menu dropdown-menu-lg dropdown-menu-%s"</span>, <span class="va">align</span><span class="op">)</span>
        <span class="op">}</span>,
        <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">span</span><span class="op">(</span>
          class <span class="op">=</span> <span class="st">"dropdown-item dropdown-header"</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n_items</span>, <span class="st">" Items"</span><span class="op">)</span>
        <span class="op">)</span>,
        <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>class <span class="op">=</span> <span class="st">"dropdown-divider"</span><span class="op">)</span>,
        <span class="va">...</span>,
        <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">a</span><span class="op">(</span>
          class <span class="op">=</span> <span class="st">"dropdown-item dropdown-footer"</span>,
          href <span class="op">=</span> <span class="va">src</span>,
          target <span class="op">=</span> <span class="st">"_blank"</span>,
          <span class="st">"See more"</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>You may run the example yourself. Note we load <code>{OSUICode}</code> to overwrite the <a href="https://rinterface.github.io/bs4Dash/index.html">bs4Dash</a> function:</p>
<div class="sourceCode" id="cb321"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># shinyAppDir(system.file("chapter6/add-dropdown-item", package = "OSUICode"))</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>
  ui <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardPage.html">bs4DashPage</a></span><span class="op">(</span>
    navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardHeader.html">bs4DashNavbar</a></span><span class="op">(</span>
      rightUi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/dropdownMenu.html">dropdownMenu</a></span><span class="op">(</span>
        show <span class="op">=</span> <span class="cn">FALSE</span>,
        status <span class="op">=</span> <span class="st">"danger"</span>,
        src <span class="op">=</span> <span class="st">"https://www.google.fr"</span>
      <span class="op">)</span>
    <span class="op">)</span>,
    sidebar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardSidebar.html">bs4DashSidebar</a></span><span class="op">(</span><span class="op">)</span>,
    controlbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardControlbar.html">bs4DashControlbar</a></span><span class="op">(</span><span class="op">)</span>,
    footer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardFooter.html">bs4DashFooter</a></span><span class="op">(</span><span class="op">)</span>,
    title <span class="op">=</span> <span class="st">"test"</span>,
    body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bs4Dash/man/dashboardBody.html">bs4DashBody</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"add"</span>, <span class="st">"Add dropdown item"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>,
  server <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>

    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/insertDropdownItem.html">insertDropdownItem</a></span><span class="op">(</span>
        <span class="fu">dropdownMenuItem</span><span class="op">(</span>
          inputId <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"triggerAction_"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span>,
          message <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"message"</span>, <span class="va">input</span><span class="op">$</span><span class="va">add</span><span class="op">)</span>,
          from <span class="op">=</span> <span class="st">"Divad Nojnarg"</span>,
          src <span class="op">=</span> <span class="st">"https://adminlte.io/themes/v3/dist/img/user3-128x128.jpg"</span>,
          time <span class="op">=</span> <span class="st">"today"</span>,
          status <span class="op">=</span> <span class="st">"danger"</span>,
          type <span class="op">=</span> <span class="st">"message"</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>This solution significantly lightens the server code since everything may be done on the JS side in one step.</p>
</div>
<div id="a-chat-system-for-shinydashboardplus" class="section level4">
<h4>
<span class="header-section-number">14.4.2.2</span> A chat system for shinydashboardPlus<a class="anchor" aria-label="anchor" href="#a-chat-system-for-shinydashboardplus"><i class="fas fa-link"></i></a>
</h4>
<p>User messages in <a href="https://github.com/RinteRface/shinydashboardPlus">shinydashboardPlus</a> (latest devel version) provide an easy way to create a chat system within a shiny app. <code>userMessages</code> hosts the main container while <code>userMessage</code> are the message elements. All of this is pure HTML:</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb322-1"><a href="shiny-custom-handler.html#cb322-1"></a><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"direct-chat-msg"</span><span class="kw">&gt;</span></span>
<span id="cb322-2"><a href="shiny-custom-handler.html#cb322-2"></a>  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"direct-chat-info clearfix"</span><span class="kw">&gt;</span></span>
<span id="cb322-3"><a href="shiny-custom-handler.html#cb322-3"></a>    <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">"direct-chat-name pull-left"</span><span class="kw">&gt;</span>Alexander Pierce<span class="kw">&lt;/span&gt;</span></span>
<span id="cb322-4"><a href="shiny-custom-handler.html#cb322-4"></a>    <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">"direct-chat-timestamp pull-right"</span><span class="kw">&gt;</span>23 Jan 2:00 pm<span class="kw">&lt;/span&gt;</span></span>
<span id="cb322-5"><a href="shiny-custom-handler.html#cb322-5"></a>  <span class="kw">&lt;/div&gt;</span></span>
<span id="cb322-6"><a href="shiny-custom-handler.html#cb322-6"></a>  <span class="co">&lt;!-- /.direct-chat-info --&gt;</span></span>
<span id="cb322-7"><a href="shiny-custom-handler.html#cb322-7"></a>  <span class="kw">&lt;img</span><span class="ot"> class=</span><span class="st">"direct-chat-img"</span><span class="ot"> src=</span><span class="st">"dist/img/user1-128x128.jpg"</span><span class="ot"> alt=</span><span class="st">"message user image"</span><span class="kw">&gt;</span></span>
<span id="cb322-8"><a href="shiny-custom-handler.html#cb322-8"></a>                      <span class="co">&lt;!-- /.direct-chat-img --&gt;</span></span>
<span id="cb322-9"><a href="shiny-custom-handler.html#cb322-9"></a>  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"direct-chat-text"</span><span class="kw">&gt;</span>Is this template really for free? That's unbelievable!</span>
<span id="cb322-10"><a href="shiny-custom-handler.html#cb322-10"></a>  <span class="kw">&lt;/div&gt;</span></span>
<span id="cb322-11"><a href="shiny-custom-handler.html#cb322-11"></a>  <span class="co">&lt;!-- /.direct-chat-text --&gt;</span></span>
<span id="cb322-12"><a href="shiny-custom-handler.html#cb322-12"></a><span class="kw">&lt;/div&gt;</span></span></code></pre></div>
<p>Given that no JavaScript API is available to handle messages, that is send/receive/edit/remove any message, we are going to design a custom R/JavaScript API step by step.</p>
<div id="html-elements" class="section level5">
<h5>
<span class="header-section-number">14.4.2.2.1</span> HTML elements<a class="anchor" aria-label="anchor" href="#html-elements"><i class="fas fa-link"></i></a>
</h5>
<p>The message container is a simple <code>div</code> element:</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb323-1"><a href="shiny-custom-handler.html#cb323-1"></a><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"direct-chat-messages"</span><span class="kw">&gt;</span>...<span class="kw">&lt;/div&gt;</span></span></code></pre></div>
<p>where <code>...</code> receives all messages. From the AdminLTE demonstration <a href="https://adminlte.io/themes/AdminLTE/index2.html">page</a>, the class <code>direct-chat-warning</code> gives the yellow color to the sent messages, while received messages are always gray. In <a href="https://github.com/RinteRface/shinydashboardPlus">shinydashboardPlus</a>, the container is defined as below:</p>
<div class="sourceCode" id="cb324"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">userMessages</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">status</span>, <span class="va">width</span> <span class="op">=</span> <span class="fl">4</span>, <span class="va">height</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="st">"direct-chat-messages direct-chat"</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/validateCssUnit.html">validateCssUnit</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">validateStatus</span><span class="op">(</span><span class="va">status</span><span class="op">)</span>
    <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cl</span>, <span class="st">" direct-chat-"</span>, <span class="va">status</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">msgtag</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    class <span class="op">=</span> <span class="va">cl</span>, 
    <span class="va">...</span>, 
    style <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"height: %s; overflow-y: auto;"</span>, <span class="va">height</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="st">"height: 100%;"</span>
    <span class="op">}</span>
  <span class="op">)</span>
  
  <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    id <span class="op">=</span> <span class="va">id</span>,
    class <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">width</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"col-sm-"</span>, <span class="va">width</span><span class="op">)</span>,
    <span class="va">msgtag</span>
  <span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p>The most important element is the <strong>id</strong> parameter that makes the link with the custom message handler on the JavaScript side. The message element is defined as:</p>
<div class="sourceCode" id="cb325"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">userMessage</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">author</span>, <span class="va">date</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                        <span class="va">image</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sent"</span>, <span class="st">"received"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span>
  <span class="va">messageCl</span> <span class="op">&lt;-</span> <span class="st">"direct-chat-msg"</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"sent"</span><span class="op">)</span> <span class="va">messageCl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">messageCl</span>, <span class="st">" right"</span><span class="op">)</span>
  
  <span class="co"># message info</span>
  <span class="va">messageInfo</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    class <span class="op">=</span> <span class="st">"direct-chat-info clearfix"</span>,
    <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">span</span><span class="op">(</span>
      class <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">{</span>
        <span class="st">"direct-chat-name pull-right"</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="st">"direct-chat-name"</span>
      <span class="op">}</span>, 
      <span class="va">author</span>
    <span class="op">)</span>,
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">span</span><span class="op">(</span>
        class <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">{</span>
          <span class="st">"direct-chat-timestamp right"</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="st">"direct-chat-timestamp"</span>
        <span class="op">}</span>, 
        <span class="va">date</span>
      <span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
  
  <span class="co"># message Text</span>
  <span class="va">messageTxt</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>class <span class="op">=</span> <span class="st">"direct-chat-text"</span>, <span class="va">...</span><span class="op">)</span>
  
  <span class="co"># message author image</span>
  <span class="va">messageImg</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">img</span><span class="op">(</span>class <span class="op">=</span> <span class="st">"direct-chat-img"</span>, src <span class="op">=</span> <span class="va">image</span><span class="op">)</span>
  
  <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    class <span class="op">=</span> <span class="va">messageCl</span>,
    <span class="va">messageInfo</span>,
    <span class="va">messageImg</span>, 
    <span class="va">messageTxt</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>There are 3 parts:</p>
<ul>
<li>The author tag, defined in the <code>messageInfo</code> variable.</li>
<li>The message itself, defined in the <code>messageTxt</code> variable.</li>
<li>The author image, contained in the <code>messageImg</code> variable.</li>
</ul>
<p>The class of the message varies depending whether it is received or sent, which actually changes its position (left or right).</p>
<p>Note the corresponding HTML classes like <code>direct-chat-text</code> since we will use them in JS.</p>
</div>
<div id="handle-interactions" class="section level5">
<h5>
<span class="header-section-number">14.4.2.2.2</span> Handle interactions<a class="anchor" aria-label="anchor" href="#handle-interactions"><i class="fas fa-link"></i></a>
</h5>
<p><code>userMessages</code> and <code>userMessage</code> alone only provide a static API. Let’s design an <code>updateMessages</code> function that offers way to update the message container. That function must allow to:</p>
<ul>
<li>Add any message to the list.</li>
<li>Remove any existing message.</li>
<li>Update a given message.</li>
</ul>
<p>For now, we assume to add only one message at a time. <code>updateMessages</code> is linked to any <code>userMessages</code> container by the <strong>id</strong> parameter. In order to delete/update a message, we need to define an <strong>index</strong> parameter. Don’t forget that R starts from 1 while JS starts from 0. Consequently, we have to decrease the R index by 1 so that JS receives the correct number. We must also provide a content slot so as to update any existing message content. The content has to be compatible we the <code>userMessage</code> structure. We expect the user to pass a list like:</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="shiny-custom-handler.html#cb326-1"></a><span class="kw">list</span>(</span>
<span id="cb326-2"><a href="shiny-custom-handler.html#cb326-2"></a>  <span class="dt">author =</span> <span class="st">"David"</span>,</span>
<span id="cb326-3"><a href="shiny-custom-handler.html#cb326-3"></a>  <span class="dt">date =</span> <span class="st">"Now"</span>,</span>
<span id="cb326-4"><a href="shiny-custom-handler.html#cb326-4"></a>  <span class="dt">image =</span> <span class="st">"https://i.pinimg.com/originals/f1/15/df/f115dfc9cab063597b1221d015996b39.jpg"</span>,</span>
<span id="cb326-5"><a href="shiny-custom-handler.html#cb326-5"></a>  <span class="dt">type =</span> <span class="st">"received"</span>,</span>
<span id="cb326-6"><a href="shiny-custom-handler.html#cb326-6"></a>  <span class="dt">text =</span> <span class="kw">tagList</span>(</span>
<span id="cb326-7"><a href="shiny-custom-handler.html#cb326-7"></a>    <span class="kw">sliderInput</span>(</span>
<span id="cb326-8"><a href="shiny-custom-handler.html#cb326-8"></a>      <span class="st">"obs"</span>, </span>
<span id="cb326-9"><a href="shiny-custom-handler.html#cb326-9"></a>      <span class="st">"Number of observations:"</span>,</span>
<span id="cb326-10"><a href="shiny-custom-handler.html#cb326-10"></a>      <span class="dt">min =</span> <span class="dv">0</span>, </span>
<span id="cb326-11"><a href="shiny-custom-handler.html#cb326-11"></a>      <span class="dt">max =</span> <span class="dv">1000</span>, </span>
<span id="cb326-12"><a href="shiny-custom-handler.html#cb326-12"></a>      <span class="dt">value =</span> <span class="dv">500</span></span>
<span id="cb326-13"><a href="shiny-custom-handler.html#cb326-13"></a>    ),</span>
<span id="cb326-14"><a href="shiny-custom-handler.html#cb326-14"></a>    <span class="kw">plotOutput</span>(<span class="st">"distPlot"</span>)</span>
<span id="cb326-15"><a href="shiny-custom-handler.html#cb326-15"></a>  )</span></code></pre></div>
<p>Interestingly, we may offer the ability to add input/output element in the message content (as shown above) with dependencies that are not yet made available to shiny. We therefore assume that if the content is a shiny tag or a list of shiny tags, it may contain elements with extra dependencies and leverage the <code>processDeps</code> function on the R side for all elements with <code>lapply</code> function. Finally, the message is going to be sent with <code>session$sendCustomMessage</code>:</p>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">updateUserMessages</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">action</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"add"</span>, <span class="st">"remove"</span>, <span class="st">"update"</span><span class="op">)</span>, 
                               <span class="va">index</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">content</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                               <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">action</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span><span class="op">(</span><span class="va">action</span><span class="op">)</span>
  
  <span class="va">content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">content</span>, <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">c</span>, <span class="st">"shiny.tag"</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">c</span>, <span class="st">"shiny.tag.list"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="co"># necessary if the user pass input/output with deps</span>
      <span class="co"># that are not yet available in the page before inserting the new tag</span>
      <span class="va">c</span> <span class="op">&lt;-</span> <span class="fu">processDeps</span><span class="op">(</span><span class="va">c</span>, <span class="va">session</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">c</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span>
    <span class="st">"user-messages"</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="va">session</span><span class="op">$</span><span class="fu">ns</span><span class="op">(</span><span class="va">id</span><span class="op">)</span>, 
      action <span class="op">=</span> <span class="va">action</span>, 
      index <span class="op">=</span> <span class="va">index</span>,
      body <span class="op">=</span> <span class="va">content</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We have to send the container <strong>id</strong> so as to be able to select the good target on the JS side. Note the <code>session$ns</code> that actually make sure this function can work within shiny modules.</p>
<p>As a reminder, the message handler name has to be the same on the JS side!</p>
<p>Now we are all done for the R side but still have to design the JS interface. The first step is to create a custom message handler skeleton:</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb328-1"><a href="shiny-custom-handler.html#cb328-1"></a><span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(<span class="st">"user-messages"</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb328-2"><a href="shiny-custom-handler.html#cb328-2"></a>  <span class="co">// JS logic</span></span>
<span id="cb328-3"><a href="shiny-custom-handler.html#cb328-3"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>where the message parameter is actually the message sent through the R <code>updateUserMessages</code> function. We recall that is we send a list, it is converted into a JS object. Therefore, to access the container id element, we do:</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb329-1"><a href="shiny-custom-handler.html#cb329-1"></a><span class="va">message</span>.<span class="at">id</span></span></code></pre></div>
<p>and similarly for other elements. There may be nested list, for instance the message content is one, which is not very complex to handle: we simply use the <code>.</code> JS notation to access lower level elements, that is <code>message.content.text</code> for the message text.</p>
<p>The second step is to store all message elements in variables, which may be separated by commas. This step is not mandatory but improves the code readability:</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb330-1"><a href="shiny-custom-handler.html#cb330-1"></a><span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(<span class="st">"user-messages"</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb330-2"><a href="shiny-custom-handler.html#cb330-2"></a>  <span class="kw">var</span> id <span class="op">=</span> <span class="va">message</span>.<span class="at">id</span><span class="op">,</span> action <span class="op">=</span> <span class="va">message</span>.<span class="at">action</span><span class="op">,</span> content <span class="op">=</span> <span class="va">message</span>.<span class="at">body</span><span class="op">,</span> index <span class="op">=</span> <span class="va">message</span>.<span class="at">index</span><span class="op">;</span></span>
<span id="cb330-3"><a href="shiny-custom-handler.html#cb330-3"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>In the following we show how to process any message content. For sake of simplicity, we assume to be able to only edit the message text.
As mentioned earlier, there are 2 possible cases:</p>
<ul>
<li>The text is simple text or simple HTML without any extra dependency, we do nothing more than storing it into a meaningful variable.</li>
<li>The text is a list of shiny tags containing input/output with extra dependencies like <code>sliderInput</code>, we have to use the <code>renderHtml</code> method to correctly process the missing dependencies passed from R via <code>processDeps</code> in <code>updateUserMessages</code>.</li>
</ul>
<p>This yields:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb331-1"><a href="shiny-custom-handler.html#cb331-1"></a><span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(<span class="st">"user-messages"</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb331-2"><a href="shiny-custom-handler.html#cb331-2"></a>  <span class="kw">var</span> id <span class="op">=</span> <span class="va">message</span>.<span class="at">id</span><span class="op">,</span> action <span class="op">=</span> <span class="va">message</span>.<span class="at">action</span><span class="op">,</span> content <span class="op">=</span> <span class="va">message</span>.<span class="at">body</span><span class="op">,</span> index <span class="op">=</span> <span class="va">message</span>.<span class="at">index</span><span class="op">;</span></span>
<span id="cb331-3"><a href="shiny-custom-handler.html#cb331-3"></a>  </span>
<span id="cb331-4"><a href="shiny-custom-handler.html#cb331-4"></a>  <span class="cf">if</span> (<span class="va">content</span>.<span class="at">hasOwnProperty</span>(<span class="st">"text"</span>)) <span class="op">{</span></span>
<span id="cb331-5"><a href="shiny-custom-handler.html#cb331-5"></a>    <span class="kw">var</span> text<span class="op">;</span></span>
<span id="cb331-6"><a href="shiny-custom-handler.html#cb331-6"></a>    <span class="cf">if</span> (<span class="va">content</span>.<span class="va">text</span>.<span class="at">html</span> <span class="op">===</span> <span class="kw">undefined</span>) <span class="op">{</span></span>
<span id="cb331-7"><a href="shiny-custom-handler.html#cb331-7"></a>      text <span class="op">=</span> <span class="va">content</span>.<span class="at">text</span><span class="op">;</span></span>
<span id="cb331-8"><a href="shiny-custom-handler.html#cb331-8"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb331-9"><a href="shiny-custom-handler.html#cb331-9"></a>      text <span class="op">=</span> <span class="va">Shiny</span>.<span class="at">renderHtml</span>(<span class="va">content</span>.<span class="va">text</span>.<span class="at">html</span><span class="op">,</span> <span class="at">$</span>([])<span class="op">,</span> <span class="va">content</span>.<span class="va">text</span>.<span class="at">deps</span>).<span class="at">html</span><span class="op">;</span></span>
<span id="cb331-10"><a href="shiny-custom-handler.html#cb331-10"></a>    <span class="op">}</span> </span>
<span id="cb331-11"><a href="shiny-custom-handler.html#cb331-11"></a>  <span class="op">}</span></span>
<span id="cb331-12"><a href="shiny-custom-handler.html#cb331-12"></a>  </span>
<span id="cb331-13"><a href="shiny-custom-handler.html#cb331-13"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>Note the <code>hasOwnProperty</code> that checks whether content has a text property.</p>
<p>Then, the next step is to consider the multiple options provided by the user (update, add, remove). We consider the simplest case, that is <code>remove</code> a message. We remind the reader that the <strong>action</strong> contains the user choice in <code>updateUserMessages</code>. What do we need to remove a given message:</p>
<ul>
<li>It’s index contained in the <strong>index</strong> variable.</li>
<li>The container <strong>id</strong>.</li>
<li>Remember/notice that a message has the <code>direct-chat-msg</code> class.</li>
<li>Use the <code>remove</code> jQuery method.</li>
</ul>
<p>We therefore target the main container with <code>$("#" + id)</code>, look for its messages with <code><a href="https://rdrr.io/r/utils/apropos.html">find(".direct-chat-msg")</a></code>, specify the target using <code>eq(index - 1)</code> (index is the R value) and apply the remove method:</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb332-1"><a href="shiny-custom-handler.html#cb332-1"></a><span class="cf">if</span> (action <span class="op">===</span> <span class="st">"remove"</span>) <span class="op">{</span></span>
<span id="cb332-2"><a href="shiny-custom-handler.html#cb332-2"></a>  <span class="at">$</span>(<span class="st">"#"</span> <span class="op">+</span> id).<span class="at">find</span>(<span class="st">".direct-chat-msg"</span>).<span class="at">eq</span>(index <span class="op">-</span> <span class="dv">1</span>).<span class="at">remove</span>()<span class="op">;</span></span>
<span id="cb332-3"><a href="shiny-custom-handler.html#cb332-3"></a><span class="op">}</span></span></code></pre></div>
<p>We could add more security with <code>console.warn</code> whenever the user wants to delete a message that does not exist. We leave it to the reader as an exercise.</p>
<p>The second case is to add a new message. In that case, we define new variables containing the
author, the date, the image and the message type. Below is a reminder of the message HTML structure:</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb333-1"><a href="shiny-custom-handler.html#cb333-1"></a><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"direct-chat-msg"</span><span class="kw">&gt;</span></span>
<span id="cb333-2"><a href="shiny-custom-handler.html#cb333-2"></a>  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"direct-chat-info clearfix"</span><span class="kw">&gt;</span></span>
<span id="cb333-3"><a href="shiny-custom-handler.html#cb333-3"></a>    <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">"direct-chat-name pull-left"</span><span class="kw">&gt;</span>AUTHOR (TO REPLACE)<span class="kw">&lt;/span&gt;</span></span>
<span id="cb333-4"><a href="shiny-custom-handler.html#cb333-4"></a>    <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">"direct-chat-timestamp pull-right"</span><span class="kw">&gt;</span>DATE (TO REPLACE)<span class="kw">&lt;/span&gt;</span></span>
<span id="cb333-5"><a href="shiny-custom-handler.html#cb333-5"></a>  <span class="kw">&lt;/div&gt;</span></span>
<span id="cb333-6"><a href="shiny-custom-handler.html#cb333-6"></a>  <span class="co">&lt;!-- /.direct-chat-info --&gt;</span></span>
<span id="cb333-7"><a href="shiny-custom-handler.html#cb333-7"></a>  <span class="kw">&lt;img</span><span class="ot"> class=</span><span class="st">"direct-chat-img"</span><span class="ot"> src=</span><span class="st">"IMAGE URL (TO REPLACE)"</span><span class="ot"> alt=</span><span class="st">"message user image"</span><span class="kw">&gt;</span></span>
<span id="cb333-8"><a href="shiny-custom-handler.html#cb333-8"></a>                      <span class="co">&lt;!-- /.direct-chat-img --&gt;</span></span>
<span id="cb333-9"><a href="shiny-custom-handler.html#cb333-9"></a>  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"direct-chat-text"</span><span class="kw">&gt;</span>MAIN CONTENT (TO REPLACE)</span>
<span id="cb333-10"><a href="shiny-custom-handler.html#cb333-10"></a>  <span class="kw">&lt;/div&gt;</span></span>
<span id="cb333-11"><a href="shiny-custom-handler.html#cb333-11"></a>  <span class="co">&lt;!-- /.direct-chat-text --&gt;</span></span>
<span id="cb333-12"><a href="shiny-custom-handler.html#cb333-12"></a><span class="kw">&lt;/div&gt;</span></span></code></pre></div>
<p>In our JS logic, we use the same template and replace any relevant element (see capital letters)
by the previously created variables. We might use the string interpolation but this is not compatible with all
web browsers. We wrap all of these elements in a <code>direct-chat-msg</code> div which class may vary depending
on the message type. If sent, the class is <code>direct-chat-msg right</code> and <code>direct-chat-msg</code> otherwise.
The final step is to target the main container with <code>$("#" + id)</code>, look for the messages slot <code><a href="https://rdrr.io/r/utils/apropos.html">find(".direct-chat-messages")</a></code> (the message container is nested in the main wrapper) and <code>append</code> it
to the DOM. We used <code>append</code> which add the message at the end but could choose <code>prepend</code> to add on top
of all other messages. This behavior may be defined by the programmer with no option for the end-user.
Alternatively, the developer could expose an external parameter to control the add position.</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb334-1"><a href="shiny-custom-handler.html#cb334-1"></a><span class="co">// other condition before ...</span></span>
<span id="cb334-2"><a href="shiny-custom-handler.html#cb334-2"></a><span class="cf">else</span> <span class="cf">if</span> (action <span class="op">===</span> <span class="st">"add"</span>) <span class="op">{</span></span>
<span id="cb334-3"><a href="shiny-custom-handler.html#cb334-3"></a>  <span class="kw">var</span> author <span class="op">=</span> <span class="va">content</span>.<span class="at">author</span><span class="op">,</span> date <span class="op">=</span> <span class="va">content</span>.<span class="at">date</span><span class="op">,</span> image <span class="op">=</span> <span class="va">content</span>.<span class="at">image</span><span class="op">,</span> type <span class="op">=</span> <span class="va">content</span>.<span class="at">type</span><span class="op">;</span></span>
<span id="cb334-4"><a href="shiny-custom-handler.html#cb334-4"></a>      </span>
<span id="cb334-5"><a href="shiny-custom-handler.html#cb334-5"></a>  <span class="co">// build the new message </span></span>
<span id="cb334-6"><a href="shiny-custom-handler.html#cb334-6"></a>  <span class="kw">var</span> newMessage <span class="op">=</span> <span class="st">'&lt;div class="direct-chat-info clearfix"&gt;'</span> <span class="op">+</span></span>
<span id="cb334-7"><a href="shiny-custom-handler.html#cb334-7"></a>    <span class="st">'&lt;span class="direct-chat-name"&gt;'</span> <span class="op">+</span> author <span class="op">+</span> <span class="st">'&lt;/span&gt;'</span> <span class="op">+</span></span>
<span id="cb334-8"><a href="shiny-custom-handler.html#cb334-8"></a>    <span class="st">'&lt;span class="direct-chat-timestamp" style="margin-left: 4px"&gt;'</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">'&lt;/span&gt;'</span> <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span> <span class="op">+</span></span>
<span id="cb334-9"><a href="shiny-custom-handler.html#cb334-9"></a>    <span class="st">'&lt;img class="direct-chat-img" src="'</span> <span class="op">+</span> image <span class="op">+</span> <span class="st">'"/&gt;'</span> <span class="op">+</span> </span>
<span id="cb334-10"><a href="shiny-custom-handler.html#cb334-10"></a>    <span class="st">'&lt;div class="direct-chat-text"&gt;'</span> <span class="op">+</span> text <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb334-11"><a href="shiny-custom-handler.html#cb334-11"></a>    </span>
<span id="cb334-12"><a href="shiny-custom-handler.html#cb334-12"></a>  <span class="co">// build wrapper</span></span>
<span id="cb334-13"><a href="shiny-custom-handler.html#cb334-13"></a>  <span class="kw">var</span> newMessageWrapper<span class="op">;</span></span>
<span id="cb334-14"><a href="shiny-custom-handler.html#cb334-14"></a>  <span class="cf">if</span> (type <span class="op">===</span> <span class="st">"sent"</span>) <span class="op">{</span></span>
<span id="cb334-15"><a href="shiny-custom-handler.html#cb334-15"></a>    newMessageWrapper <span class="op">=</span> <span class="st">'&lt;div class="direct-chat-msg right"&gt;'</span> <span class="op">+</span> newMessage <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb334-16"><a href="shiny-custom-handler.html#cb334-16"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb334-17"><a href="shiny-custom-handler.html#cb334-17"></a>    newMessageWrapper <span class="op">=</span> <span class="st">'&lt;div class="direct-chat-msg"&gt;'</span> <span class="op">+</span> newMessage <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb334-18"><a href="shiny-custom-handler.html#cb334-18"></a>  <span class="op">}</span></span>
<span id="cb334-19"><a href="shiny-custom-handler.html#cb334-19"></a>  </span>
<span id="cb334-20"><a href="shiny-custom-handler.html#cb334-20"></a>  <span class="co">// append message</span></span>
<span id="cb334-21"><a href="shiny-custom-handler.html#cb334-21"></a>  <span class="at">$</span>(<span class="st">"#"</span> <span class="op">+</span> id).<span class="at">find</span>(<span class="st">".direct-chat-messages"</span>).<span class="at">append</span>(newMessageWrapper)<span class="op">;</span></span>
<span id="cb334-22"><a href="shiny-custom-handler.html#cb334-22"></a><span class="op">}</span></span></code></pre></div>
<p>Finally, the last case is to update a given message. As stated above, we assume to only edit the
message text and the date. To update the message, we target the messages container with <code>$("#" + id)</code>,
look for all texts with <code><a href="https://rdrr.io/r/utils/apropos.html">find(".direct-chat-text")</a></code>, refine our choice by targeting the good element with
<code>eq(index - 1)</code>, call <code>replaceWith</code> containing the new text element.</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb335-1"><a href="shiny-custom-handler.html#cb335-1"></a><span class="cf">else</span> <span class="cf">if</span> (action <span class="op">===</span> <span class="st">"update"</span>) <span class="op">{</span></span>
<span id="cb335-2"><a href="shiny-custom-handler.html#cb335-2"></a>      </span>
<span id="cb335-3"><a href="shiny-custom-handler.html#cb335-3"></a>  <span class="co">// today's date</span></span>
<span id="cb335-4"><a href="shiny-custom-handler.html#cb335-4"></a>  <span class="kw">var</span> d <span class="op">=</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">;</span></span>
<span id="cb335-5"><a href="shiny-custom-handler.html#cb335-5"></a>  <span class="kw">var</span> month <span class="op">=</span> <span class="va">d</span>.<span class="at">getMonth</span>() <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb335-6"><a href="shiny-custom-handler.html#cb335-6"></a>  <span class="kw">var</span> day <span class="op">=</span> <span class="va">d</span>.<span class="at">getDate</span>()<span class="op">;</span></span>
<span id="cb335-7"><a href="shiny-custom-handler.html#cb335-7"></a>  <span class="kw">var</span> today <span class="op">=</span> <span class="va">d</span>.<span class="at">getFullYear</span>() <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span></span>
<span id="cb335-8"><a href="shiny-custom-handler.html#cb335-8"></a>    ((<span class="st">''</span><span class="op">+</span>month).<span class="at">length</span><span class="op">&lt;</span><span class="dv">2</span> <span class="op">?</span> <span class="st">'0'</span> : <span class="st">''</span>) <span class="op">+</span> month <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span></span>
<span id="cb335-9"><a href="shiny-custom-handler.html#cb335-9"></a>    ((<span class="st">''</span><span class="op">+</span>day).<span class="at">length</span><span class="op">&lt;</span><span class="dv">2</span> <span class="op">?</span> <span class="st">'0'</span> : <span class="st">''</span>) <span class="op">+</span> day<span class="op">;</span></span>
<span id="cb335-10"><a href="shiny-custom-handler.html#cb335-10"></a>    </span>
<span id="cb335-11"><a href="shiny-custom-handler.html#cb335-11"></a>  <span class="co">// we assume only text may be updated. Does not make sense to modify author</span></span>
<span id="cb335-12"><a href="shiny-custom-handler.html#cb335-12"></a>  </span>
<span id="cb335-13"><a href="shiny-custom-handler.html#cb335-13"></a>  <span class="at">$</span>(<span class="st">"#"</span> <span class="op">+</span> id)</span>
<span id="cb335-14"><a href="shiny-custom-handler.html#cb335-14"></a>    .<span class="at">find</span>(<span class="st">".direct-chat-text"</span>)</span>
<span id="cb335-15"><a href="shiny-custom-handler.html#cb335-15"></a>    .<span class="at">eq</span>(index <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb335-16"><a href="shiny-custom-handler.html#cb335-16"></a>    .<span class="at">replaceWith</span>(<span class="st">'&lt;div class="direct-chat-text"&gt;&lt;small class="text-red"&gt;(modified: '</span> <span class="op">+</span> today <span class="op">+</span><span class="st">')&lt;/small&gt;&lt;br&gt;'</span> <span class="op">+</span>  text <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span>)</span>
<span id="cb335-17"><a href="shiny-custom-handler.html#cb335-17"></a><span class="op">}</span></span></code></pre></div>
<p>Don’t forget to unbind, re-initialize and bind all inputs by calling <code>Shiny.unbindAll();</code>, <code>Shiny.initializeInputs();</code> and
<code>Shiny.bindAll();</code>. If you ommit this part, the newly inserted input/output elements won’t work!</p>
<p>The whole JS code may be found below:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb336-1"><a href="shiny-custom-handler.html#cb336-1"></a><span class="co">// userMessages</span></span>
<span id="cb336-2"><a href="shiny-custom-handler.html#cb336-2"></a>  <span class="co">// ------------------------------------------------------------------</span></span>
<span id="cb336-3"><a href="shiny-custom-handler.html#cb336-3"></a>  <span class="co">// This code creates acustom handler for userMessages</span></span>
<span id="cb336-4"><a href="shiny-custom-handler.html#cb336-4"></a>  <span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(<span class="st">"user-messages"</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb336-5"><a href="shiny-custom-handler.html#cb336-5"></a>    <span class="kw">var</span> id <span class="op">=</span> <span class="va">message</span>.<span class="at">id</span><span class="op">,</span> action <span class="op">=</span> <span class="va">message</span>.<span class="at">action</span><span class="op">,</span> content <span class="op">=</span> <span class="va">message</span>.<span class="at">body</span><span class="op">,</span> index <span class="op">=</span> <span class="va">message</span>.<span class="at">index</span><span class="op">;</span></span>
<span id="cb336-6"><a href="shiny-custom-handler.html#cb336-6"></a>    </span>
<span id="cb336-7"><a href="shiny-custom-handler.html#cb336-7"></a>    <span class="co">// message text</span></span>
<span id="cb336-8"><a href="shiny-custom-handler.html#cb336-8"></a>    <span class="co">// We use Shiny.renderHtml to handle the case where the user pass input/outputs in the updated content that require a new dependency not available in the </span></span>
<span id="cb336-9"><a href="shiny-custom-handler.html#cb336-9"></a>    <span class="co">// page at startup. </span></span>
<span id="cb336-10"><a href="shiny-custom-handler.html#cb336-10"></a>    <span class="cf">if</span> (<span class="va">content</span>.<span class="at">hasOwnProperty</span>(<span class="st">"text"</span>)) <span class="op">{</span></span>
<span id="cb336-11"><a href="shiny-custom-handler.html#cb336-11"></a>      <span class="kw">var</span> text<span class="op">;</span></span>
<span id="cb336-12"><a href="shiny-custom-handler.html#cb336-12"></a>      <span class="cf">if</span> (<span class="va">content</span>.<span class="va">text</span>.<span class="at">html</span> <span class="op">===</span> <span class="kw">undefined</span>) <span class="op">{</span></span>
<span id="cb336-13"><a href="shiny-custom-handler.html#cb336-13"></a>        text <span class="op">=</span> <span class="va">content</span>.<span class="at">text</span><span class="op">;</span></span>
<span id="cb336-14"><a href="shiny-custom-handler.html#cb336-14"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb336-15"><a href="shiny-custom-handler.html#cb336-15"></a>        text <span class="op">=</span> <span class="va">Shiny</span>.<span class="at">renderHtml</span>(<span class="va">content</span>.<span class="va">text</span>.<span class="at">html</span><span class="op">,</span> <span class="at">$</span>([])<span class="op">,</span> <span class="va">content</span>.<span class="va">text</span>.<span class="at">deps</span>).<span class="at">html</span><span class="op">;</span></span>
<span id="cb336-16"><a href="shiny-custom-handler.html#cb336-16"></a>      <span class="op">}</span> </span>
<span id="cb336-17"><a href="shiny-custom-handler.html#cb336-17"></a>    <span class="op">}</span></span>
<span id="cb336-18"><a href="shiny-custom-handler.html#cb336-18"></a>    </span>
<span id="cb336-19"><a href="shiny-custom-handler.html#cb336-19"></a>    <span class="co">// unbind all</span></span>
<span id="cb336-20"><a href="shiny-custom-handler.html#cb336-20"></a>    <span class="va">Shiny</span>.<span class="at">unbindAll</span>()<span class="op">;</span></span>
<span id="cb336-21"><a href="shiny-custom-handler.html#cb336-21"></a>    </span>
<span id="cb336-22"><a href="shiny-custom-handler.html#cb336-22"></a>    <span class="cf">if</span> (action <span class="op">===</span> <span class="st">"remove"</span>) <span class="op">{</span></span>
<span id="cb336-23"><a href="shiny-custom-handler.html#cb336-23"></a>      <span class="at">$</span>(<span class="st">"#"</span> <span class="op">+</span> id).<span class="at">find</span>(<span class="st">".direct-chat-msg"</span>).<span class="at">eq</span>(index <span class="op">-</span> <span class="dv">1</span>).<span class="at">remove</span>()<span class="op">;</span></span>
<span id="cb336-24"><a href="shiny-custom-handler.html#cb336-24"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (action <span class="op">===</span> <span class="st">"add"</span>) <span class="op">{</span></span>
<span id="cb336-25"><a href="shiny-custom-handler.html#cb336-25"></a>      <span class="kw">var</span> author <span class="op">=</span> <span class="va">content</span>.<span class="at">author</span><span class="op">,</span> date <span class="op">=</span> <span class="va">content</span>.<span class="at">date</span><span class="op">,</span> image <span class="op">=</span> <span class="va">content</span>.<span class="at">image</span><span class="op">,</span> type <span class="op">=</span> <span class="va">content</span>.<span class="at">type</span><span class="op">;</span></span>
<span id="cb336-26"><a href="shiny-custom-handler.html#cb336-26"></a>      </span>
<span id="cb336-27"><a href="shiny-custom-handler.html#cb336-27"></a>      <span class="co">// build the new message </span></span>
<span id="cb336-28"><a href="shiny-custom-handler.html#cb336-28"></a>      <span class="kw">var</span> newMessage <span class="op">=</span> <span class="st">'&lt;div class="direct-chat-info clearfix"&gt;'</span> <span class="op">+</span></span>
<span id="cb336-29"><a href="shiny-custom-handler.html#cb336-29"></a>        <span class="st">'&lt;span class="direct-chat-name"&gt;'</span> <span class="op">+</span> author <span class="op">+</span> <span class="st">'&lt;/span&gt;'</span> <span class="op">+</span></span>
<span id="cb336-30"><a href="shiny-custom-handler.html#cb336-30"></a>        <span class="st">'&lt;span class="direct-chat-timestamp" style="margin-left: 4px"&gt;'</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">'&lt;/span&gt;'</span> <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span> <span class="op">+</span></span>
<span id="cb336-31"><a href="shiny-custom-handler.html#cb336-31"></a>        <span class="st">'&lt;img class="direct-chat-img" src="'</span> <span class="op">+</span> image <span class="op">+</span> <span class="st">'"/&gt;'</span> <span class="op">+</span> </span>
<span id="cb336-32"><a href="shiny-custom-handler.html#cb336-32"></a>        <span class="st">'&lt;div class="direct-chat-text"&gt;'</span> <span class="op">+</span> text <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb336-33"><a href="shiny-custom-handler.html#cb336-33"></a>        </span>
<span id="cb336-34"><a href="shiny-custom-handler.html#cb336-34"></a>      <span class="co">// build wrapper</span></span>
<span id="cb336-35"><a href="shiny-custom-handler.html#cb336-35"></a>      <span class="kw">var</span> newMessageWrapper<span class="op">;</span></span>
<span id="cb336-36"><a href="shiny-custom-handler.html#cb336-36"></a>      <span class="cf">if</span> (type <span class="op">===</span> <span class="st">"sent"</span>) <span class="op">{</span></span>
<span id="cb336-37"><a href="shiny-custom-handler.html#cb336-37"></a>        newMessageWrapper <span class="op">=</span> <span class="st">'&lt;div class="direct-chat-msg right"&gt;'</span> <span class="op">+</span> newMessage <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb336-38"><a href="shiny-custom-handler.html#cb336-38"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb336-39"><a href="shiny-custom-handler.html#cb336-39"></a>        newMessageWrapper <span class="op">=</span> <span class="st">'&lt;div class="direct-chat-msg"&gt;'</span> <span class="op">+</span> newMessage <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb336-40"><a href="shiny-custom-handler.html#cb336-40"></a>      <span class="op">}</span></span>
<span id="cb336-41"><a href="shiny-custom-handler.html#cb336-41"></a>      </span>
<span id="cb336-42"><a href="shiny-custom-handler.html#cb336-42"></a>      <span class="co">// append message</span></span>
<span id="cb336-43"><a href="shiny-custom-handler.html#cb336-43"></a>      <span class="at">$</span>(<span class="st">"#"</span> <span class="op">+</span> id).<span class="at">find</span>(<span class="st">".direct-chat-messages"</span>).<span class="at">append</span>(newMessageWrapper)<span class="op">;</span></span>
<span id="cb336-44"><a href="shiny-custom-handler.html#cb336-44"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (action <span class="op">===</span> <span class="st">"update"</span>) <span class="op">{</span></span>
<span id="cb336-45"><a href="shiny-custom-handler.html#cb336-45"></a>      </span>
<span id="cb336-46"><a href="shiny-custom-handler.html#cb336-46"></a>      <span class="co">// today's date</span></span>
<span id="cb336-47"><a href="shiny-custom-handler.html#cb336-47"></a>      <span class="kw">var</span> d <span class="op">=</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">;</span></span>
<span id="cb336-48"><a href="shiny-custom-handler.html#cb336-48"></a>      <span class="kw">var</span> month <span class="op">=</span> <span class="va">d</span>.<span class="at">getMonth</span>() <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb336-49"><a href="shiny-custom-handler.html#cb336-49"></a>      <span class="kw">var</span> day <span class="op">=</span> <span class="va">d</span>.<span class="at">getDate</span>()<span class="op">;</span></span>
<span id="cb336-50"><a href="shiny-custom-handler.html#cb336-50"></a>      <span class="kw">var</span> today <span class="op">=</span> <span class="va">d</span>.<span class="at">getFullYear</span>() <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span></span>
<span id="cb336-51"><a href="shiny-custom-handler.html#cb336-51"></a>        ((<span class="st">''</span><span class="op">+</span>month).<span class="at">length</span><span class="op">&lt;</span><span class="dv">2</span> <span class="op">?</span> <span class="st">'0'</span> : <span class="st">''</span>) <span class="op">+</span> month <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span></span>
<span id="cb336-52"><a href="shiny-custom-handler.html#cb336-52"></a>        ((<span class="st">''</span><span class="op">+</span>day).<span class="at">length</span><span class="op">&lt;</span><span class="dv">2</span> <span class="op">?</span> <span class="st">'0'</span> : <span class="st">''</span>) <span class="op">+</span> day<span class="op">;</span></span>
<span id="cb336-53"><a href="shiny-custom-handler.html#cb336-53"></a>        </span>
<span id="cb336-54"><a href="shiny-custom-handler.html#cb336-54"></a>      <span class="co">// we assume only text may be updated. Does not make sense to modify author/date</span></span>
<span id="cb336-55"><a href="shiny-custom-handler.html#cb336-55"></a>      </span>
<span id="cb336-56"><a href="shiny-custom-handler.html#cb336-56"></a>      <span class="at">$</span>(<span class="st">"#"</span> <span class="op">+</span> id)</span>
<span id="cb336-57"><a href="shiny-custom-handler.html#cb336-57"></a>        .<span class="at">find</span>(<span class="st">".direct-chat-text"</span>)</span>
<span id="cb336-58"><a href="shiny-custom-handler.html#cb336-58"></a>        .<span class="at">eq</span>(index <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb336-59"><a href="shiny-custom-handler.html#cb336-59"></a>        .<span class="at">replaceWith</span>(<span class="st">'&lt;div class="direct-chat-text"&gt;&lt;small class="text-red"&gt;(modified: '</span> <span class="op">+</span> today <span class="op">+</span><span class="st">')&lt;/small&gt;&lt;br&gt;'</span> <span class="op">+</span>  text <span class="op">+</span> <span class="st">'&lt;/div&gt;'</span>)</span>
<span id="cb336-60"><a href="shiny-custom-handler.html#cb336-60"></a>    <span class="op">}</span></span>
<span id="cb336-61"><a href="shiny-custom-handler.html#cb336-61"></a>    </span>
<span id="cb336-62"><a href="shiny-custom-handler.html#cb336-62"></a>    <span class="co">// Calls .initialize() for all of the input objects in all input bindings,</span></span>
<span id="cb336-63"><a href="shiny-custom-handler.html#cb336-63"></a>    <span class="co">// in the given scope (document)</span></span>
<span id="cb336-64"><a href="shiny-custom-handler.html#cb336-64"></a>    <span class="va">Shiny</span>.<span class="at">initializeInputs</span>()<span class="op">;</span></span>
<span id="cb336-65"><a href="shiny-custom-handler.html#cb336-65"></a>    <span class="va">Shiny</span>.<span class="at">bindAll</span>()<span class="op">;</span> <span class="co">// bind all inputs/outputs</span></span>
<span id="cb336-66"><a href="shiny-custom-handler.html#cb336-66"></a>  <span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>as well as a demonstration:</p>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://rstudio.github.io/shinydashboard/">shinydashboard</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RinteRface/shinydashboardPlus">shinydashboardPlus</a></span><span class="op">)</span>
 
 <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>
  ui <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardPage.html">dashboardPage</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardHeader.html">dashboardHeader</a></span><span class="op">(</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardSidebar.html">dashboardSidebar</a></span><span class="op">(</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardBody.html">dashboardBody</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"remove"</span>, <span class="st">"Remove message"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"add"</span>, <span class="st">"Add message"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"update"</span>, <span class="st">"Update message"</span><span class="op">)</span>
      <span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"index"</span>, <span class="st">"Message index:"</span>, <span class="fl">1</span>, min <span class="op">=</span> <span class="fl">1</span>, max <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">br</a></span><span class="op">(</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">br</a></span><span class="op">(</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/userMessage.html">userMessages</a></span><span class="op">(</span>
        width <span class="op">=</span> <span class="fl">6</span>,
        status <span class="op">=</span> <span class="st">"danger"</span>,
        id <span class="op">=</span> <span class="st">"message"</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/userMessage.html">userMessage</a></span><span class="op">(</span>
          author <span class="op">=</span> <span class="st">"Alexander Pierce"</span>,
          date <span class="op">=</span> <span class="st">"20 Jan 2:00 pm"</span>,
          image <span class="op">=</span> <span class="st">"https://adminlte.io/themes/AdminLTE/dist/img/user1-128x128.jpg"</span>,
          type <span class="op">=</span> <span class="st">"received"</span>,
          <span class="st">"Is this template really for free? That's unbelievable!"</span>
        <span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/userMessage.html">userMessage</a></span><span class="op">(</span>
          author <span class="op">=</span> <span class="st">"Sarah Bullock"</span>,
          date <span class="op">=</span> <span class="st">"23 Jan 2:05 pm"</span>,
          image <span class="op">=</span> <span class="st">"https://adminlte.io/themes/AdminLTE/dist/img/user3-128x128.jpg"</span>,
          type <span class="op">=</span> <span class="st">"sent"</span>,
          <span class="st">"You better believe it!"</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>,
    title <span class="op">=</span> <span class="st">"user Message"</span>
  <span class="op">)</span>,
  server <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">remove</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/userMessage.html">updateUserMessages</a></span><span class="op">(</span><span class="st">"message"</span>, action <span class="op">=</span> <span class="st">"remove"</span>, index <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">index</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">add</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/userMessage.html">updateUserMessages</a></span><span class="op">(</span>
        <span class="st">"message"</span>, 
        action <span class="op">=</span> <span class="st">"add"</span>, 
        content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
          author <span class="op">=</span> <span class="st">"David"</span>,
          date <span class="op">=</span> <span class="st">"Now"</span>,
          image <span class="op">=</span> <span class="st">"https://i.pinimg.com/originals/f1/15/df/f115dfc9cab063597b1221d015996b39.jpg"</span>,
          type <span class="op">=</span> <span class="st">"received"</span>,
          text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tag.html">tagList</a></span><span class="op">(</span>
           <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html">sliderInput</a></span><span class="op">(</span>
            <span class="st">"obs"</span>, 
            <span class="st">"Number of observations:"</span>,
            min <span class="op">=</span> <span class="fl">0</span>, 
            max <span class="op">=</span> <span class="fl">1000</span>, 
            value <span class="op">=</span> <span class="fl">500</span>
           <span class="op">)</span>,
           <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"distPlot"</span><span class="op">)</span>
          <span class="op">)</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="va">output</span><span class="op">$</span><span class="va">distPlot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span>
     <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">update</span>, <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/userMessage.html">updateUserMessages</a></span><span class="op">(</span>
        <span class="st">"message"</span>, 
        action <span class="op">=</span> <span class="st">"update"</span>, 
        index <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">index</span>,
        content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
         text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tag.html">tagList</a></span><span class="op">(</span>
          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/appButton.html">appButton</a></span><span class="op">(</span>
           inputId <span class="op">=</span> <span class="st">"reload"</span>,
           label <span class="op">=</span> <span class="st">"Click me!"</span>, 
           icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"sync"</span><span class="op">)</span>, 
           <span class="fu"><a href="https://rdrr.io/pkg/shinydashboardPlus/man/dashboardBadge.html">dashboardBadge</a></span><span class="op">(</span><span class="fl">1</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span>
          <span class="op">)</span>
         <span class="op">)</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">reload</span>, <span class="op">{</span>
     <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/showNotification.html">showNotification</a></span><span class="op">(</span><span class="st">"Yeah!"</span>, duration <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"default"</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
  <span class="op">}</span>
 <span class="op">)</span></code></pre></div>

</div>
</div>
</div>
</div>
</div>




<div class="chapter-nav">
<div class="prev"><a href="shiny-input-gems.html"><span class="header-section-number">13</span> Hidden gems about inputs</a></div>
<div class="next"><a href="custom-templates-selection.html"><span class="header-section-number">15</span> Template selection</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#shiny-custom-handler"><span class="header-section-number">14</span> Dynamically manage content with handlers</a></li>
<li><a class="nav-link" href="#introduction-3"><span class="header-section-number">14.1</span> Introduction</a></li>
<li><a class="nav-link" href="#the-renderui-case"><span class="header-section-number">14.2</span> The renderUI case</a></li>
<li>
<a class="nav-link" href="#insert-ui"><span class="header-section-number">14.3</span> Other Shiny handlers</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-insertui-case"><span class="header-section-number">14.3.1</span> The insertUI case</a></li>
<li><a class="nav-link" href="#example-2"><span class="header-section-number">14.3.2</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#custom-handlers"><span class="header-section-number">14.4</span> Custom handlers</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#theory"><span class="header-section-number">14.4.1</span> Theory</a></li>
<li><a class="nav-link" href="#custom-ui-functions"><span class="header-section-number">14.4.2</span> Toward custom UI management functions</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/blob/master/shiny-custom-handler.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/edit/master/shiny-custom-handler.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>
</div>
  

  

</div>
 <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Outstanding User Interfaces with Shiny</strong>" was written by David Granjon. It was last built on 2021-02-15.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
