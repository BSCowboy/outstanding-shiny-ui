# Define dependencies {#custom-templates-dependencies}
This is time to start our practical session. As mentionned in the previous chapter, we will focus on the tabler, a tiny Bootstrap 4 dashboard template.
Importantly, what follows is not the description of how to customize tabler but rather provide a R wrapper. Therefore we will not write SASS nore edit the core JavaScript, even though technically possible.

## Discover the project
The first step of any template adaptation consists in exploring the underlying github repository (if open source) and look for mandatory elements, like CSS/JS dependencies. You would actually proceed similarly for an HTMLWidget.

```{r tabler-github, echo=FALSE, fig.cap='Github project exploration'}
knitr::include_graphics("images/practice/tabler-github.png")
```

As shown in Figure \@ref(fig:tabler-github), the most important folders are:

  - dist: contains CSS and JS files as well as other libraries like Bootstrap and jQuery. In production we seek for minified files since they take less space. It is also a good moment to look at the version of each dependency that might conflict with Shiny 
  - demo is the website folder used for demonstration purpose. This is our source to explore the template capabilities in depth
  
The scss and build folder are also crucial to the package but as stated previously, customizing tabler is out of the scope of this book. It is already a significant task to adapt a template from a language to another.


## Identify mandatory dependencies
Now, among all JS/CSS resources, we need to identify the one necessary to the template. Obviously, the Bootstrap 4, jQuery, tabler.min.css and tabler.min.js are key elements, contrary to flag icons which are optional (and take a lot of space). The package size is also to consider if you plan to release the template on CRAN and respect the 5mB maximum limit. By experience, I can tell you this is quite hard to handle.

To inspect dependencies, we proceed as follows

  - Download or clone the github repository
  - Go to the demo folder and open the layout-dark.html file
  - Open the HTML inspector
  
```{r tabler-deps, echo=FALSE, fig.show = "hold", out.width = "50%", fig.align = "default"}

knitr::include_graphics("images/practice/tabler-deps-1.png")
knitr::include_graphics("images/practice/tabler-deps-2.png")

```

As depicted on Figure \@ref(fig:tabler-deps) left-hand side, we need to include the tabler.min.css from the header. If you are not convinced, try to remove it from the DOM and see what happens. [jqvmap](https://www.10bestdesign.com/jqvmap/) is actually related to an external visualization plugin used in the demo. Finally the demo.min.css file is for the demo purpose. This will not prevent the template to work if we skip it. So far so good, we only need 1 file thus!

JavaScript dependencies are shown on the right-hand side and located at the end of the body tag. We won't need all chart-related dependencies like apexcharts, jquery.vmap and vmap world and can sefely ignore them. We will keep the Bootstrap 4 bundle.js, jQuery core and tabler.min.js (the order is crucial).


## Bundle dependencies
With the help of the `htmltoolsDependency` function, we are going to create our main tabler HTML dependency containing all assets to allow our template to render properly. In this example, I am going to cheat a bit: instead of handling local files, I will use a CDN (content delivery network) that hosts all necessary tabler [assets](https://www.jsdelivr.com/package/npm/tabler). The main reason is that it will allow us to test the template directly from the bookdown project. But in theory, this template would need to live inside an R package, in a github repository.

```{r}
tablers_deps <- htmlDependency(
  name = "tabler",
  version = "1.0.7", # we take that of tabler,
  src = c(href = "https://cdn.jsdelivr.net/npm/tabler@1.0.0-alpha.7/dist/"),
  script = "js/tabler.min.js",
  stylesheet = "css/tabler.min.css"
)
```

I advise the reader to create 1 HTML dependency per element. The Bootstrap version is v4.3.1 (Shiny relies on 3.4.1) and jQuery is 3.5.0 (Shiny relies on 3.4.1). We can also use a CDN:

```{r}
bs4_deps <- htmlDependency(
  name = "Bootstrap",
  version = "4.3.1",
  src = c(href = "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/"),
  script = "bootstrap.bundle.min.js"
)

jQuery_deps <- htmlDependency(
  name = "jQuery",
  version = "3.5.0",
  src = c(href = "https://code.jquery.com/"),
  script = "jquery-3.5.0.slim.min.js"
)
```

We finally create our dependency manager (TO DO: add more details):

```{r}
# utility to add an html dependency without overwriting existing ones
appendDependencies <- function(tag, value) {
  if (inherits(value, "html_dependency"))
    value <- list(value)
  
  old <- attr(tag, "html_dependencies", TRUE)
  
  htmlDependencies(tag) <- c(old, value)
  tag
}

# add all dependencies to a tag
addDeps <- function(tag) {
  # below, the order is of critical importance!
  deps <- list(bs4_deps, jQuery_deps, tablers_deps)
  appendDependencies(tag, deps)
}
```

Let's see how to use `addDeps`. We consider a `<div>` placeholder and check for its dependencies with `findDependencies` (should be NULL). Then, we wrap it with `addDeps`. 

```{r}
tag <- div()
findDependencies(tag)
tag <- addDeps(div())
findDependencies(tag)
```

As shown above, our dependencies are applied to the div, in the correct order. This order is set by the list `list(bs4_deps, jQuery_deps, tablers_deps)`. This flexibility allows to avoid potential conflicts. If we try to run this simple tag in a shiny app, we notice that all dependencies are added to the `<head>` tag, whereas the original template loads JavaScript dependencies in the `<body>`. Currently, htmltools does not allow to distribute dependencies in different places. Here there is no impact but for other templates like [Framework7](https://framework7.io) (which is powering [shinyMobile](https://github.com/RinteRface/shinyMobile)), JavaScript must be place in the body. In practice, this is quite honestly hard to guess and only manual testing will help you.

```{r, eval=FALSE}
ui <- fluidPage(tag)
server <- function(input, output, session) {}
shinyApp(ui, server)
```

Even though the `addDeps` function may be applied to any tag, we will use it with the core HTML template, that remain to be designed!

Would you like to see if our dependency system works? Let's meet in the next chapter to design the main dashboard layout.