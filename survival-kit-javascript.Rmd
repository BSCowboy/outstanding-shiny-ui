# JavaScript {#survival-kit-javascript}

## Introduction 
JavaScript (JS) was created in 1995 by Brendan Eich and also known as ECMAScript (ES). Interestingly, you might have heard about ActionScript, which is no more than an implementation of ES by Adobe Systems. Nowadays, JavaScript is a centerpiece of the web and included in almost all websites. 

Let's make a little experiment. If you have a personal blog (it is very popular in the RStats community) you probably know Hugo or Jekyll. These tools allow to quickly setup professionnal looking (or at least not too ugly) blogs in literraly few minutes. You can focus on the content and this is what matters! Now, if you open the HTML inspector introduced in Chapter \@ref(survival-kit-html), click on the elements tab (in theory it is the first tab and open by default), and uncollapse the `<head>` tag, you see that a lot of scripts are included, as shown in Figure \@ref(fig:scripts-list). Same remark in the `<body>` tag.

```{r scripts-list, echo=FALSE, fig.cap='A website is full of JavaScript'}
knitr::include_graphics("images/survival-kit/scripts-list.png")
```

There are 2 main ways to include scripts:

  - Use the `<script>` tag with the JS code inside
  - Import an external file containing the JS code and only
  
```html
<script type="text/javascript">
// JS code here
</script>
```

```html
<!-- We use the src attribute to link the external file -->
<script type="text/javascript" src="file.js">
```

Whether to choose the first or second method depends on the content of your script. If we consider jQuery, a well known JS library, it contains so much lines of code that it does not make sense to select the first method. 

## Setup
Like R or Python, JavaScript is an interpreted language. It is also executed client side, that is in the navigator. It also means that you cannot run js code without suitable tools. 

### Node
[Node](https://nodejs.org/en/) contains an interpreter for JS as well as a dependencies manager, npm (Node Package Manager). To install Node on your computer, browse to the website and follow the intruction. Once done, open a terminal and check if

```
$ which node
$ node --version
```
returns something. If not, it means that Node is not properly installed. 

### Choose a good IDE
I really like [VSCode](https://code.visualstudio.com) for all the JS things since it contains a Node interpreter and you can seamlessly execute any JS code (the truth is because I'm a big fan of the dracula color theme). But the [Rstudio IDE](https://rstudio.com/products/rstudio/) may also be fine, provided that you have Node installed. Below, we will see how to run a JS code in both IDE.

### First Script
Let's write our first script:

```javascript
console.log("Hello World");
```

You notice that all instruction end by `;`. You can run this script either in Rstudio IDE or VSCode. 

```{r script-vscode, echo=FALSE, fig.cap='Run JS in VSCode'}
knitr::include_graphics("images/survival-kit/script-vscode.png")
```

In VSCode, clicking on the run arrow (top center) of Figure \@ref(fig:script-vscode),
triggers the `node hello.js` command, which tells Node to run my script. We see the result in the right panel (code=0 means the execution is fine and we even have the compute time). To run this script in the RStudio IDE, you need to click on the terminal tab (you could also open a basic terminal) and type `node hello.js` (or `node mycustompath/hello.js` if you are not in the folder containing the script). You should see the Hello World message in the console (see Figure \@ref(fig:script-rstudio)).

```{r script-rstudio, echo=FALSE, fig.cap='Run JS in a terminal'}
knitr::include_graphics("images/survival-kit/script-rstudio.png")
```

## Programming with JS: basis
We are now all set to introduce the basis of JS. As many languages, JS is made of variables and instructions (We saw above that instructions end by `;`).

### JS types
JS defines several types:

  - Number: does not distinguish between integers and others (in R for instance, numeric contains integers and double)
  - String: characters ('blabla')
  - Boolean: true/false
  
To check the type of an element, we may use the `typeof` operator (this is not a function like the `typeof` function in R).

```javascript
typeof 1; // number
typeof 'pouic'; // string
```

### Variables
A variable is defined by:

  - a type
  - a name
  - a value

<br>
<div class="callout callout-danger">
Valid variable names: 
<ul>
<li>don't use an existing name like typeof</li>
<li>son't start with a number (123)</li>
<li>don't include any space (total price)</li>
</ul>
</div>
<br>

Based on the above forbidden items, you can use the camelCase syntax to write your variables in JS. To set a variable we use `let` (there exists `var` but this is not the latest JS norm (ES6). You will see later that we still use `var` in the shiny core and many other R packages):

```javascript
let myVariable = 'welcome';
console.log(myVariable);
```

Then we can use all mathematical operators to manipulate a variable.

```javascript
let myNumber = 1; // affectation
myNumber--; // decrement
console.log(myNumber); // print 0
```

<br>
<div class="callout callout-info">
List of numerical operators in JS: 
<ul>
<li>+</li>
<li>-</li>
<li>*</li>
<li>/</li>
<li>% (modulo)</li>
<li>++ (incrementation)</li>
<li>-- (decrementation)</li>
</ul>
</div>
<br>

To concatenate 2 strings, use `+`.

### Conditions
Below are the operators to check conditions.

<br>
<div class="callout callout-info">
<ul>
<li>== (A equal B)</li>
<li>!= (A not equal to B)</li>
<li>\> (>=)</li>
<li>< (<=)</li>
<li>AND (A AND B)</li>
<li>OR (A OR B)</li>
</ul>
</div>
<br>

To test conditions there exists several ways:

  - `if (condition) { console.log('Test passed'); }`
  - `if (condition) { instruction A} else { instruction B }`
  
This is very common to other languages (and R for instance). Whenever a lot of possible conditions need to be evaluated, it is better to choose the `switch`.


```javascript
switch (variable) {
  case val1: // instruction 1
  break; // don't forget the break!
  case val2:  // instruction 2
  break;
  default: // when none of val1 and val2 are satisfied
}
```

### Iterations
Iterations allow to repeat an instruction or a set of instructions multiple times. 

#### For loops
The for loop has multiple ways to be used. Below is the most classic. We start by defining the index (variable). We then set an upper bound and we finish by incrementing the index value. We execute the instruction between curly braces.

```javascript
const max = 10; // we never mentionned constants before. This is the way to call them
for (let i = 0; i <= max; i++) {
  console.log(i); // this will print i 10 times
}
```

<br>
<div class="callout callout-danger">
Contrary to R, JavaScript index starts from 0 (not from 1)! This is good to keep in mind when we will mix both R and JS.
</div>
<br>

Let's have a look at the `forEach` method for arrays (introduced in ES5):

```javascript
let letters = ["a", "b", "c", "d"];
letters.forEach((letter) => {
  console.log(letter);
});
```

Below is another way to create a for loop (introduced in ES6):

```javascript
let samples = ['blabla', 1, null]; // this is an array!
for (let sample of samples) {
 console.log(sample);
}
```

What is the best `for` loop? The answer is: it depends on the situation! Actually, there even exists other ways (replace of by in and you get the indexes of the array, like the with the first code, but this is really [not recommended](https://hacks.mozilla.org/2015/04/es6-in-depth-iterators-and-the-for-of-loop/)).


#### Other iterations: while
We will clearly never use them in this book but this is good to know. 

```javascript
const h = 3; i = 0;
while (i <= h) {
  console.log(i);
  i++; // we need to increment to avoid infinite loop
}
```


### Objects
JavaScript is an object oriented programming language (like Python). An object is defined by:

  - a type
  - some properties
  - some methods (to manipulate properties)
  
Let's define our first object below:

```javascript
const me = {
  name : 'Divad',
  age : 29,
  music : '',
  printName: function() {
    console.log(`I am ${this.name}`);
  }
}

console.log(JSON.stringify(me)); // print a human readable object.
  
console.log(me.name);
console.log(me.age);
console.log(me.music);
// don't repeat yourself!!!
for (let key in me) { // here is it ok to use `in`
 console.log(`me[${key}] is ${me[key]}`);
}

me.printName();
```

Some comments on the above code:

  - to access an object propertie, we use `object.propertie`
  - to print a human readable version of the object `JSON.stringify` will do the job
  - we introduced string interpolation with `${*}`. `*` may be any valid expression.
  - methods are accessed like properties (we may also pass parameters). We use `this` to refer to the object itself. Take note, we will see it a lot!
  
In JavaScript, we can find already predefined objects to interact with arrays, dates.

#### Arrays
An array is a structure allowing to store informations for instance

```javascript
let table = [1, 'plop'];
console.log(table);
```

Array may be nested

```javascript
let nested = [1, ['a', [1, 2, 3]], 'plop'];
console.log(nested);
```

In arrays, elements may be accessed by their index, but as mentionned before, the first index is 0 (not 1 like in R). A convenient way to print all arrays's elements is to use an iteration:

```javascript
let nested = [1, ['a', [1, 2, 3]], 'plop'];
for (let i of nested) {
  console.log(i);
}

// or with the classic approach
for (let i = 0; i < nested.length; i++) {
  console.log(nested[i]);
}
```

Note that the `length` method returns the size of an array and is very convenient in for loops. Below is a table referencing the principal methods for arrays (we will use some of them later)

| Method/Property   |      Description     | 
|:----------:|:-------------:|
| length |  Return the number of elements in an array  | 
| Join(string separator) |  Transform an array in a string | 
| concat(array1, array2) |    Assemble 2 arrays   |  
| pop() | Remove the last element of an array |    
| shift() | Remove the first element of an array |
| unshift(el1, el2, ...) | Insert elements at the beginning of an array |
| push(el1, el2, ...) | Add extra elements at the end of an array |
| sort() | Sort array elements by increasing value of alphabetical order |
| reverse() | Symetric of sort() |

Quite honestly, we will only use `push` and `length` in the next chapters.


#### Strings
Below are the main methods related to the String object (character in R)

| Method/Property/Operator   |     Description     | 
|:----------:|:-------------:|
| + (operator) |  String concatenation  | 
| length |  String length  | 
| indexOf() | Gives the position of the character following the input string |
| toLowerCase() | Put the string in small letters |
| toUpperCase() | Put the string in capital letters |


#### Math
Below we mention some useful methods to handle mathematical objects

| Method   |     Description     | 
|:----------:|:-------------:|
| parseInt() |  Convert a string to integer  | 
| parseFloat() |  Conversion to floating number  | 

All classic functions like `sqrt`, trigonometric functions are of course available. We call them with the `Math.*` prefix.


### Functions
Functions are useful to wrap a succession of instructions to accomplish a given task. Defining functions allows programmers to save time (less copy and paste, less search and replace), do less errors and share code more easily. In modern JavaScript (ES6), functions are defined as follows:

```javascript
const a = 1;
const fun = (parm1, parm2) => {
  console.log(a);
  let p = 3;
  return Math.max(parm1, parm2); // I use the Math object that contains the max method
}
let res = fun(1, 2);
console.log(res); // prints a and 2. a global
console.log(p); // fails because p was defined inside the function
```

This functions computes the maximum of 2 provided numbers. Some comments about scoping rules: variables defined inside the function are available for the function but not outside. The function may use global variables defined outside of it.

#### Export functions: about modules
What happens if you wrote 100 functions and you would like to reuse some of them in different scripts? To prevent copy and pasting, we will introduce modules. Let's save the below function in a script `utils.js`:

```javascript
const findMax = (parm1, parm2) => {
  return Math.max(parm1, parm2); // I use the Math object that contains the max method
}

module.exports = {
  findMax = findMax
}
```

Now, if we create a `test.js` script in the same folder and want to use `findMax`, we need to import the corresponding module:

```javascript
const {findMax} = require('./utils.js');
findMax(1, 2); // prints 2
```

In the next chapters, we will see that some of the underlying JS code to build custom shiny inputs share the same utils functions. Therefore, introducing modules is necessary.

### Event listeners
When you explore a web application, clicking on a button usually triggers something like a computation, a modal or an alert. How does this work?
In JavaScript, interactivity plays a critical role. Indeed, you want the web application to react to user inputs like mouse clicks, keyboard events. Below we introduce DOM events.

Let's consider a basic HTML button.

```html
<button id="mybutton">Go!</button>
```

On the JavaScript side, we first capture the button element using its id selector (`getElementById`).

```javascript
const btn = document.getElementById('mybutton');
```

We then apply the `addEventListener` method. In short, an event listener is a program that triggers when a given event occurs (we can add multiple event listeners per HTML element). It takes 2 main parameters:

  - the event: click, change, mouseover, ...
  - the function to call
  
```javascript
btn.addEventListener('click', function() {
  alert('Thanks!');
});
```

<br>
<div class="callout callout-info">
We could compare the JavaScript events to Shiny observeEvent in which we are listenning to a specific user input. 
</div>
<br>


## jQuery

### Introduction
[jQuery](https://jquery.com) is a famous JavaScript library providing a user friendly interface to manipulate the DOM and is present in almost all actual websites. It is slighly easier (understand more convenient to use) than vanilla JS, even though web developers tend to avoid it to go back to vanilla JS (Bootstrap 5, the next iteration of Bootstrap will not rely on jQuery anymore). To use jQuery in a webpage, we must include its code either by dowloading the code and putting the minified JS file in our HTML or setting a link to a CDN. 

```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Including jQuery</title>
  <!-- How to include jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
</head>
<body>
 
<p>Hello World</p>

 
<script>
$('p').css('color', 'red');
</script>
 
</body>
</html>
```

### Syntax
Below is a minimal jQuery code representing its philosophy ("write less, do more."):

```javascript
$(selector).action();
```
The selector slot stands for any jQuery selector like class, id, element, [attribute], :input (will select all input elements) and many [more](https://www.w3schools.com/jquery/jquery_ref_selectors.asp). As a reminder, let's consider the following example:

```html
<p class="text">Hello World</p>
```

To select and interact with this element, we use JavaScript and jQuery:

```javascript
let inner = document.getElementsByClassName('text').innerHTML; // vanilla JS
let inner = $('.text').html(); // jQuery
```

This is of course possible to chain selectors

```html
<ul class="list">
  <li class="item">1</li>
  <li class="item">2</li>
  <li class="item">3</li>
  <li class="item" id="precious-item">4</li>
</ul>

<ul class="list" id="list2">
  <li class="item">1</li>
  <li class="item">2</li>
  <li class="item">3</li>
  <li class="item">4</li>
</ul>
```

```javascript
let items = $('.list .item'); // will return an array containing 8 li tags
let otherItems = $('#list2 .item'); // will select only li tags from the second ul element
let lists = $('ul'); // will return an array with 2 ul elements
let firstItem = $('#list2:first-child'); // will return the first li element of the second ul.
```

jQuery is obviously simpler than pure JavaScript. 

### Useful functions
There exist filtering functions dedicated to simplify item [selection](https://api.jquery.com/category/traversing/). We gathered the one mostly used in Shiny below.

#### Travel in the DOM

| Method   |     Description     | 
|:----------:|:-------------:|
| children() | Get the children of each element passed in the selector (important: only travels a single level down the DOM tree) |
| first() | Given an list of elements, select the first item | 
| last() | Given an list of elements, select the last item |
| find() | Look for a descendant of the selected element(s) that could be multiple levels down in the DOM |
| closest() | Returns the first ancestor matching the condition (travels up in the DOM) |
| filter() | Fine tune element selection by applying a filter. Only return element for which the condition is true |
| siblings() | Get all siblings of the selected element(s) |
| next() | Get the immediately following sibling |
| prev() | Get the immediately preceding sibling |
| not() | Given an existing set of selected elements, remove element(s) that match the given condition | 


#### Manipulate tags
Below is a list of the main jQuery [methods](https://api.jquery.com/category/manipulation/) to manipulate tags (adding class, css property...)

| Method   |     Description     | 
|:----------:|:-------------:|
| addClass() | Add class or multiple classes to the set of matched elements |
| hasClass() | Check if the matched element(s) have a given class |
| removeClass() | Remove class or multiple classes to the set of matched elements |
| attr() | Get or set the value of a specific attribute |
| after() | Insert content after |
| before () | Insert content before |
| css() | Get or set a css property | 
| remove() | Remove element(s) from the DOM |
| val() | Get the current value of the matched element(s) |

TO DO: add more methods

### Chaining jQuery methods
A lot of jQuery methods may be chained, that is like pipe operations in R.

```html
<ul>
  <li>Item 1</li>
  <li>Item 2</li>
  <li>Item 3</li>
  <li>Item 4</li>
  <li>Item 5</li>
</ul>
```

We end the chain by `;` and each step is indent by 2 spaces in the right direction.

```javascript
$('ul')
  .first()
  .css('color', 'green') // add some style with css
  .attr('id', 'myAwesomeItem') // add an id attribute
  .addClass('amazing-ul');
```

### Iterations
Like in vanilla JavaScript, it is possible to do iterations in jQuery. Let's consider the following HTML elements.

```html
<ul>
  <li>Item 1</li>
  <li>Item 2</li>
</ul>
```

We apply the `each` method to change the style of each matched element step by step.

```javascript
$('li').each(function() {
  $(this).css('visibility', 'hidden'); // will hide all li items
});
```

The `map` methods has a different purpose. It creates a new object based on the provided one. 

```javascript
let items = [0,1,2,3,4,5];
let threshold = 3;

let filteredItems = $(items).map(function(i) {
  // removes all items > threshold
  if (i > threshold) 
    return null;
  return i;
});
```

### Good practice
It is recommended to wrap any jQuery code as follows:

```javascript
$(document).ready(function(){
  // your code
});

// or a shortcut

$(function() {
  // your code
});
```

Indeed, do you guess what would happen if you try to modify an element that does not even exist? The code above will make sure that the document is ready before starting any jQuery manipulation.


### Events
In jQuery there exists a significant number methods related to events. Below are the most popular:

```javascript
$(element).click(); // click event
$(element).change(); // trigger change on an element
$(element).on('click', function() {
 // whatever
}); // attach an event handler function. Here we add click for the example
$(element).one('click', function() {
 // whatever
}); // the difference with on is that one will trigger only once
$(element).resize(); // useful to trigger plot resize in Shiny so that they correctly fit their container
$(element).trigger('change') // similar to $(element).change(); You will find it in the Shiny core.
```

The `.on` event is frequently used in Shiny since it allows to pass custom events which are not part of the JS prefined events. For instance shinydashboard relies on a specific HTML/JavaScript/CSS template including a homemade API for handling the dashboard events. Don't worry if this section is not clear at the moment. We will see practical examples in the following chapters.


### Extending objects
A last feature we need to mention about jQuery is the ability to extend objects with additional properties and/or method. 

```javascript
// jQuery way
$(function() {
  let object1 = {
    apple: 0
  };
  $.extend(object1, {
    print: function() {
      console.log(this);
    }
  });
  object1.print();
});
```

With vanilla JS we would use `Object.defineProperty`:

```javascript
// pure JavaScript
Object.defineProperty(object1, 'print', {
  value: function() {
    console.log(this);
  },
  writable: false
});
```
